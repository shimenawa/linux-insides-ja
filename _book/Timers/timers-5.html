
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Clockevents framework Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="timers-6.html" />
    
    
    <link rel="prev" href="timers-4.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Initialization/">
            
                <a href="../Initialization/">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Initialization/linux-initialization-1.html">
            
                <a href="../Initialization/linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Initialization/linux-initialization-2.html">
            
                <a href="../Initialization/linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Initialization/linux-initialization-3.html">
            
                <a href="../Initialization/linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Initialization/linux-initialization-4.html">
            
                <a href="../Initialization/linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Initialization/linux-initialization-5.html">
            
                <a href="../Initialization/linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Initialization/linux-initialization-6.html">
            
                <a href="../Initialization/linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Initialization/linux-initialization-7.html">
            
                <a href="../Initialization/linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Initialization/linux-initialization-8.html">
            
                <a href="../Initialization/linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../Initialization/linux-initialization-9.html">
            
                <a href="../Initialization/linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../Initialization/linux-initialization-10.html">
            
                <a href="../Initialization/linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../SysCall/">
            
                <a href="../SysCall/">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../SysCall/syscall-1.html">
            
                <a href="../SysCall/syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../SysCall/syscall-2.html">
            
                <a href="../SysCall/syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../SysCall/syscall-3.html">
            
                <a href="../SysCall/syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../SysCall/syscall-4.html">
            
                <a href="../SysCall/syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../SysCall/syscall-5.html">
            
                <a href="../SysCall/syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="timers-1.html">
            
                <a href="timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="timers-2.html">
            
                <a href="timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="timers-3.html">
            
                <a href="timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="timers-4.html">
            
                <a href="timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.5" data-path="timers-5.html">
            
                <a href="timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="timers-6.html">
            
                <a href="timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="timers-7.html">
            
                <a href="timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Misc/">
            
                <a href="../Misc/">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Misc/how_kernel_compiled.html">
            
                <a href="../Misc/how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Misc/linkers.html">
            
                <a href="../Misc/linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="../Misc/contribute.html">
            
                <a href="../Misc/contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="../Misc/program_startup.html">
            
                <a href="../Misc/program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Clockevents framework</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="timers-and-time-management-in-the-linux-kernel-part-5">Timers and time management in the Linux kernel. Part 5.</h1>
<h2 id="introduction-to-the-clockevents-framework">Introduction to the <code>clockevents</code> framework</h2>
<p>This is fifth part of the <a href="https://0xax.gitbooks.io/linux-insides/content/Timers/index.html" target="_blank">chapter</a> which describes timers and time management related stuff in the Linux kernel. As you might noted from the title of this part, the <code>clockevents</code> framework will be discussed. We already saw one framework in the <a href="https://0xax.gitbooks.io/linux-insides/content/Timers/timers-2.html" target="_blank">second</a> part of this chapter. It was <code>clocksource</code> framework. Both of these frameworks represent timekeeping abstractions in the Linux kernel.</p>
<p>At first let&apos;s refresh your memory and try to remember what is it <code>clocksource</code> framework and and what its purpose. The main goal of the <code>clocksource</code> framework is to provide <code>timeline</code>. As described in the <a href="https://github.com/0xAX/linux/blob/master/Documentation/timers/timekeeping.txt" target="_blank">documentation</a>:</p>
<blockquote>
<p>For example issuing the command &apos;date&apos; on a Linux system will eventually read the clock source to determine exactly what time it is.</p>
</blockquote>
<p>The Linux kernel supports many different clock sources. You can find some of them in the <a href="https://github.com/torvalds/linux/tree/master/drivers/clocksource" target="_blank">drivers/closksource</a>. For example old good <a href="https://en.wikipedia.org/wiki/Intel_8253" target="_blank">Intel 8253</a> - <a href="https://en.wikipedia.org/wiki/Programmable_interval_timer" target="_blank">programmable interval timer</a> with <code>1193182</code> Hz frequency, yet another one - <a href="http://uefi.org/sites/default/files/resources/ACPI_5.pdf" target="_blank">ACPI PM</a> timer with <code>3579545</code> Hz frequency. Besides the <a href="https://github.com/torvalds/linux/tree/master/drivers/clocksource" target="_blank">drivers/closksource</a> directory, each architecture may provide own architecture-specific clock sources. For example <a href="https://en.wikipedia.org/wiki/X86" target="_blank">x86</a> architecture provides <a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer" target="_blank">High Precision Event Timer</a>, or for example <a href="https://en.wikipedia.org/wiki/PowerPC" target="_blank">powerpc</a> provides access to the processor timer through <code>timebase</code> register.</p>
<p>Each clock source provides monotonic atomic counter. As I already wrote, the Linux kernel supports a huge set of different clock source and each clock source has own parameters like <a href="https://en.wikipedia.org/wiki/Frequency" target="_blank">frequency</a>. The main goal of the <code>clocksource</code> framework is to provide <a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank">API</a> to select best available clock source in the system i.e. a clock source with the highest frequency. Additional goal of the <code>clocksource</code> framework is to represent an atomic counter provided by a clock source in human units. In this time, nanoseconds are the favorite choice for the time value units of the given clock source in the Linux kernel.</p>
<p>The <code>clocksource</code> framework represented by the <code>clocksource</code> structure which is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/clocksource.h" target="_blank">include/linux/clocksource.h</a> header code file which contains <code>name</code> of a clock source, rating of certain clock source in the system (a clock source with the higher frequency has the biggest rating in the system), <code>list</code> of all registered clock source in the system, <code>enable</code> and <code>disable</code> fields to enable and disable a clock source, pointer to the <code>read</code> function which must return an atomic counter of a clock source and etc.</p>
<p>Additionally the <code>clocksource</code> structure provides two fields: <code>mult</code> and <code>shift</code> which are needed for translation of an atomic counter which is provided by a certain clock source to the human units, i.e. <a href="https://en.wikipedia.org/wiki/Nanosecond" target="_blank">nanoseconds</a>. Translation occurs via following formula:</p>
<pre><code>ns ~= (clocksource * mult) &gt;&gt; shift
</code></pre><p>As we already know, besides the <code>clocksource</code> structure, the <code>clocksource</code> framework provides an API for registration of clock source with different frequency scale factor:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">clocksource_register_hz</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clocksource *cs, u32 hz)</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">clocksource_register_khz</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clocksource *cs, u32 khz)</span>
</span></code></pre>
<p>A clock source unregistration:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">clocksource_unregister</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clocksource *cs)</span>
</span></code></pre>
<p>and etc.</p>
<p>Additionally to the <code>clocksource</code> framework, the Linux kernel provides <code>clockevents</code> framework. As described in the <a href="https://github.com/0xAX/linux/blob/master/Documentation/timers/timekeeping.txt" target="_blank">documentation</a>:</p>
<blockquote>
<p>Clock events are the conceptual reverse of clock sources</p>
</blockquote>
<p>Main goal of the is to manage clock event devices or in other words - to manage devices that allow to register an event or in other words <a href="https://en.wikipedia.org/wiki/Interrupt" target="_blank">interrupt</a> that is going to happen at a defined point of time in the future.</p>
<p>Now we know a little about the <code>clockevents</code> framework in the Linux kernel, and now time is to see on it <a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank">API</a>.</p>
<h2 id="api-of-clockevents-framework">API of <code>clockevents</code> framework</h2>
<p>The main structure which described a clock event device is <code>clock_event_device</code> structure. This structure is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/clockchips.h" target="_blank">include/linux/clockchips.h</a> header file and contains a huge set of fields. as well as the <code>clocksource</code> structure it has <code>name</code> fields which contains human readable name of a clock event device, for example <a href="https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller" target="_blank">local APIC</a> timer:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> clock_event_device lapic_clockevent = {
    .name                   = <span class="hljs-string">&quot;lapic&quot;</span>,
    ...
    ...
    ...
}
</code></pre>
<p>Addresses of the <code>event_handler</code>, <code>set_next_event</code>, <code>next_event</code> functions for a certain clock event device which are an <a href="https://en.wikipedia.org/wiki/Interrupt_handler" target="_blank">interrupt handler</a>, setter of next event and local storage for next event respectively. Yet another field of the <code>clock_event_device</code> structure is - <code>features</code> field. Its value maybe on of the following generic features:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLOCK_EVT_FEAT_PERIODIC    0x000001</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLOCK_EVT_FEAT_ONESHOT        0x000002</span>
</code></pre>
<p>Where the <code>CLOCK_EVT_FEAT_PERIODIC</code> represents device which may be programmed to generate events periodically. The <code>CLOCK_EVT_FEAT_ONESHOT</code> represents device which may generate an event only once. Besides these two features, there are also architecture-specific features. For example <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a> supports two additional features:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLOCK_EVT_FEAT_C3STOP        0x000008</span>
</code></pre>
<p>The first <code>CLOCK_EVT_FEAT_C3STOP</code> means that a clock event device will be stopped in the <a href="https://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface#Device_states" target="_blank">C3</a> state. Additionally the <code>clock_event_device</code> structure has <code>mult</code> and <code>shift</code> fields as well as <code>clocksource</code> structure. The <code>clocksource</code> structure also contains other fields, but we will consider it later.</p>
<p>After we considered part of the <code>clock_event_device</code> structure, time is to look at the <code>API</code> of the <code>clockevents</code> framework. To work with a clock event device, first of all we need to initialize <code>clock_event_device</code> structure and register a clock events device. The <code>clockevents</code> framework provides following <code>API</code> for registration of clock event devices:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clockevents_register_device</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clock_event_device *dev)</span>
</span>{
   ...
   ...
   ...
}
</code></pre>
<p>This function defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/clockevents.c" target="_blank">kernel/time/clockevents.c</a> source code file and as we may see, the <code>clockevents_register_device</code> function takes only one parameter:</p>
<ul>
<li>address of a <code>clock_event_device</code> structure which represents a clock event device.</li>
</ul>
<p>So, to register a clock event device, at first we need to initialize <code>clock_event_device</code> structure with parameters of a certain clock event device. Let&apos;s take a look at one random clock event device in the Linux kernel source code. We can find one in the <a href="https://github.com/torvalds/linux/tree/master/drivers/clocksource" target="_blank">drivers/closksource</a> directory or try to take a look at an architecture-specific clock event device. Let&apos;s take for example - <a href="http://www.atmel.com/Images/doc6062.pdf" target="_blank">Periodic Interval Timer (PIT) for at91sam926x</a>. You can find its implementation in the <a href="https://github.com/torvalds/linux/tree/master/drivers/clocksource/timer-atmel-pit.c" target="_blank">drivers/closksource</a>.</p>
<p>First of all let&apos;s look at initialization of the <code>clock_event_device</code> structure. This occurs in the <code>at91sam926x_pit_common_init</code> function:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> pit_data {
    ...
    ...
    <span class="hljs-keyword">struct</span> clock_event_device       clkevt;
    ...
    ...
};

<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">at91sam926x_pit_common_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pit_data *data)</span>
</span>{
    ...
    ...
    ...
    data-&gt;clkevt.name = <span class="hljs-string">&quot;pit&quot;</span>;
    data-&gt;clkevt.features = CLOCK_EVT_FEAT_PERIODIC;
    data-&gt;clkevt.shift = <span class="hljs-number">32</span>;
    data-&gt;clkevt.mult = div_sc(pit_rate, NSEC_PER_SEC, data-&gt;clkevt.shift);
    data-&gt;clkevt.rating = <span class="hljs-number">100</span>;
    data-&gt;clkevt.cpumask = cpumask_of(<span class="hljs-number">0</span>);

    data-&gt;clkevt.set_state_shutdown = pit_clkevt_shutdown;
    data-&gt;clkevt.set_state_periodic = pit_clkevt_set_periodic;
    data-&gt;clkevt.resume = at91sam926x_pit_resume;
    data-&gt;clkevt.suspend = at91sam926x_pit_suspend;
    ...
}
</code></pre>
<p>Here we can see that <code>at91sam926x_pit_common_init</code> takes one parameter - pointer to the <code>pit_data</code> structure which contains <code>clock_event_device</code> structure which will contain clock event related information of the <code>at91sam926x</code> <a href="https://en.wikipedia.org/wiki/Programmable_interval_timer" target="_blank">periodic Interval Timer</a>. At the start we fill <code>name</code> of the timer device and its <code>features</code>. In our case we deal with periodic timer which as we already know may be programmed to generate events periodically.</p>
<p>The next two fields <code>shift</code> and <code>mult</code> are familiar to us. They will be used to translate counter of our timer to nanoseconds. After this we set rating of the timer  to <code>100</code>. This means if there will not be timers with higher rating in the system, this timer will be used for timekeeping. The next field - <code>cpumask</code> indicates for which processors in the system the device will work. In our case, the device will work for the first processor. The <code>cpumask_of</code> macro defined in the <a href="https://github.com/torvalds/linux/tree/master/include/linux/cpumask.h" target="_blank">include/linux/cpumask.h</a> header file and just expands to the call of the:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> cpumask_of(cpu) (get_cpu_mask(cpu))</span>
</code></pre>
<p>Where the <code>get_cpu_mask</code> returns the cpumask containing just a given <code>cpu</code> number. More about <code>cpumasks</code> concept you may read in the <a href="https://0xax.gitbooks.io/linux-insides/content/Concepts/cpumask.html" target="_blank">CPU masks in the Linux kernel</a> part. In the last four lines of code we set callbacks for the clock event device suspend/resume, device shutdown and update of the clock event device state.</p>
<p>After we finished with the initialization of the <code>at91sam926x</code> periodic timer, we can register it by the call of the following functions:</p>
<pre><code class="lang-C">clockevents_register_device(&amp;data-&gt;clkevt);
</code></pre>
<p>Now we can consider implementation of the <code>clockevent_register_device</code> function. As I already wrote above, this function is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/clockevents.c" target="_blank">kernel/time/clockevents.c</a> source code file and starts from the initialization of the initial event device state:</p>
<pre><code class="lang-C">clockevent_set_state(dev, CLOCK_EVT_STATE_DETACHED);
</code></pre>
<p>Actually, an event device may be in one of this states:</p>
<pre><code class="lang-C"><span class="hljs-keyword">enum</span> clock_event_state {
    CLOCK_EVT_STATE_DETACHED,
    CLOCK_EVT_STATE_SHUTDOWN,
    CLOCK_EVT_STATE_PERIODIC,
    CLOCK_EVT_STATE_ONESHOT,
    CLOCK_EVT_STATE_ONESHOT_STOPPED,
};
</code></pre>
<p>Where:</p>
<ul>
<li><code>CLOCK_EVT_STATE_DETACHED</code> - a clock event device is not not used by <code>clockevents</code> framework. Actually it is initial state of all clock event devices;</li>
<li><code>CLOCK_EVT_STATE_SHUTDOWN</code> - a clock event device is powered-off;</li>
<li><code>CLOCK_EVT_STATE_PERIODIC</code> - a clock event device may be programmed to generate event periodically;</li>
<li><code>CLOCK_EVT_STATE_ONESHOT</code>  - a clock event device may be programmed to generate event only once;</li>
<li><code>CLOCK_EVT_STATE_ONESHOT_STOPPED</code> - a clock event device was programmed to generate event only once and now it is temporary stopped.</li>
</ul>
<p>The implementation of the <code>clock_event_set_state</code> function is pretty easy:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clockevent_set_state</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clock_event_device *dev,
                    <span class="hljs-keyword">enum</span> clock_event_state state)</span>
</span>{
    dev-&gt;state_use_accessors = state;
}
</code></pre>
<p>As we can see, it just fills the <code>state_use_accessors</code> field of the given <code>clock_event_device</code> structure with the given value which is in our case is <code>CLOCK_EVT_STATE_DETACHED</code>. Actually all clock event devices has this initial state during registration. The <code>state_use_accessors</code> field of the <code>clock_event_device</code> structure provides <code>current</code> state of the clock event device.</p>
<p>After we have set initial state of the given <code>clock_event_device</code> structure we check that the <code>cpumask</code> of the given clock event device is not zero:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (!dev-&gt;cpumask) {
    WARN_ON(num_possible_cpus() &gt; <span class="hljs-number">1</span>);
    dev-&gt;cpumask = cpumask_of(smp_processor_id());
}
</code></pre>
<p>Remember that we have set the <code>cpumask</code> of the <code>at91sam926x</code> periodic timer to first processor. If the <code>cpumask</code> field is zero, we check the number of possible processors in the system and print warning message if it is less than on. Additionally we set the <code>cpumask</code> of the given clock event device to the current processor. If you are interested in how the <code>smp_processor_id</code> macro is implemented, you can read more about it in the fourth <a href="https://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-4.html" target="_blank">part</a> of the Linux kernel initialization process chapter.</p>
<p>After this check we lock the actual code of the clock event device registration by the call following macros:</p>
<pre><code class="lang-C">raw_spin_lock_irqsave(&amp;clockevents_lock, flags);
...
...
...
raw_spin_unlock_irqrestore(&amp;clockevents_lock, flags);
</code></pre>
<p>Additionally the <code>raw_spin_lock_irqsave</code> and the <code>raw_spin_unlock_irqrestore</code> macros disable local interrupts, however interrupts on other processors still may occur. We need to do it to prevent potential <a href="https://en.wikipedia.org/wiki/Deadlock" target="_blank">deadlock</a> if we adding new clock event device to the list of clock event devices and an interrupt occurs from other clock event device.</p>
<p>We can see following code of clock event device registration between the <code>raw_spin_lock_irqsave</code> and <code>raw_spin_unlock_irqrestore</code> macros:</p>
<pre><code class="lang-C">list_add(&amp;dev-&gt;<span class="hljs-built_in">list</span>, &amp;clockevent_devices);
tick_check_new_device(dev);
clockevents_notify_released();
</code></pre>
<p>First of all we add the given clock event device to the list of clock event devices which is represented by the <code>clockevent_devices</code>:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">LIST_HEAD</span><span class="hljs-params">(clockevent_devices)</span></span>;
</code></pre>
<p>At the next step we call the <code>tick_check_new_device</code> function which is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/tick-common.c" target="_blank">kernel/time/tick-common.c</a> source code file and checks do the new registered clock event device should be used or not. The <code>tick_check_new_device</code> function checks the given <code>clock_event_device</code> gets the current registered tick device which is represented by the <code>tick_device</code> structure and compares their ratings and features. Actually <code>CLOCK_EVT_STATE_ONESHOT</code> is preferred:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">tick_check_preferred</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clock_event_device *curdev,
                 <span class="hljs-keyword">struct</span> clock_event_device *newdev)</span>
</span>{
    <span class="hljs-keyword">if</span> (!(newdev-&gt;features &amp; CLOCK_EVT_FEAT_ONESHOT)) {
        <span class="hljs-keyword">if</span> (curdev &amp;&amp; (curdev-&gt;features &amp; CLOCK_EVT_FEAT_ONESHOT))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (tick_oneshot_mode_active())
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> !curdev ||
        newdev-&gt;rating &gt; curdev-&gt;rating ||
           !cpumask_equal(curdev-&gt;cpumask, newdev-&gt;cpumask);
}
</code></pre>
<p>If the new registered clock event device is more preferred than old tick device, we exchange old and new registered devices and install new device:</p>
<pre><code class="lang-C">clockevents_exchange_device(curdev, newdev);
tick_setup_device(td, newdev, cpu, cpumask_of(cpu));
</code></pre>
<p>The <code>clockevents_exchange_device</code> function releases or in other words deleted the old clock event device from the <code>clockevent_devices</code> list. The next function - <code>tick_setup_device</code> as we may understand from its name, setups new tick device. This function check the mode of the new registered clock event device and call the <code>tick_setup_periodic</code> function or the <code>tick_setup_oneshot</code> depends on the tick device mode:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (td-&gt;mode == TICKDEV_MODE_PERIODIC)
    tick_setup_periodic(newdev, <span class="hljs-number">0</span>);
<span class="hljs-keyword">else</span>
    tick_setup_oneshot(newdev, handler, next_event);
</code></pre>
<p>Both of this functions calls the <code>clockevents_switch_state</code> to change state of the clock event device and the <code>clockevents_program_event</code> function to set next event of clock event device based on delta between the maximum and minimum difference current time and time for the next event. The <code>tick_setup_periodic</code>:</p>
<pre><code class="lang-C">clockevents_switch_state(dev, CLOCK_EVT_STATE_PERIODIC);
clockevents_program_event(dev, next, <span class="hljs-literal">false</span>))
</code></pre>
<p>and the <code>tick_setup_oneshot_periodic</code>:</p>
<pre><code class="lang-C">clockevents_switch_state(newdev, CLOCK_EVT_STATE_ONESHOT);
clockevents_program_event(newdev, next_event, <span class="hljs-literal">true</span>);
</code></pre>
<p>The <code>clockevents_switch_state</code> function checks that the clock event device is not in the given state and calls the <code>__clockevents_switch_state</code> function from the same source code file:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (clockevent_get_state(dev) != state) {
    <span class="hljs-keyword">if</span> (__clockevents_switch_state(dev, state))
        <span class="hljs-keyword">return</span>;
</code></pre>
<p>The <code>__clockevents_switch_state</code> function just makes a call of the certain callback depends on the given state:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __clockevents_switch_state(<span class="hljs-keyword">struct</span> clock_event_device *dev,
                      <span class="hljs-keyword">enum</span> clock_event_state state)
{
    <span class="hljs-keyword">if</span> (dev-&gt;features &amp; CLOCK_EVT_FEAT_DUMMY)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">switch</span> (state) {
    <span class="hljs-keyword">case</span> CLOCK_EVT_STATE_DETACHED:
    <span class="hljs-keyword">case</span> CLOCK_EVT_STATE_SHUTDOWN:
        <span class="hljs-keyword">if</span> (dev-&gt;set_state_shutdown)
            <span class="hljs-keyword">return</span> dev-&gt;set_state_shutdown(dev);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">case</span> CLOCK_EVT_STATE_PERIODIC:
        <span class="hljs-keyword">if</span> (!(dev-&gt;features &amp; CLOCK_EVT_FEAT_PERIODIC))
            <span class="hljs-keyword">return</span> -ENOSYS;
        <span class="hljs-keyword">if</span> (dev-&gt;set_state_periodic)
            <span class="hljs-keyword">return</span> dev-&gt;set_state_periodic(dev);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    ...
    ...
    ...
</code></pre>
<p>In our case for <code>at91sam926x</code> periodic timer, the state is the <code>CLOCK_EVT_FEAT_PERIODIC</code>:</p>
<pre><code class="lang-C">data-&gt;clkevt.features = CLOCK_EVT_FEAT_PERIODIC;
data-&gt;clkevt.set_state_periodic = pit_clkevt_set_periodic;
</code></pre>
<p>So, for the <code>pit_clkevt_set_periodic</code> callback will be called. If we will read the documentation of the <a href="http://www.atmel.com/Images/doc6062.pdf" target="_blank">Periodic Interval Timer (PIT) for at91sam926x</a>, we will see that there is <code>Periodic Interval Timer Mode Register</code> which allows us to control of periodic interval timer.</p>
<p>It looks like:</p>
<pre><code>31                                                   25        24
+---------------------------------------------------------------+
|                                          |  PITIEN  |  PITEN  |
+---------------------------------------------------------------+
23                            19                               16
+---------------------------------------------------------------+
|                             |               PIV               |
+---------------------------------------------------------------+
15                                                              8
+---------------------------------------------------------------+
|                            PIV                                |
+---------------------------------------------------------------+
7                                                               0
+---------------------------------------------------------------+
|                            PIV                                |
+---------------------------------------------------------------+
</code></pre><p>Where <code>PIV</code> or <code>Periodic Interval Value</code> - defines the value compared with the primary <code>20-bit</code> counter of the Periodic Interval Timer. The <code>PITEN</code> or <code>Period Interval Timer Enabled</code> if the bit is <code>1</code> and the <code>PITIEN</code> or <code>Periodic Interval Timer Interrupt Enable</code> if the bit is <code>1</code>. So, to set periodic mode, we need to set <code>24</code>, <code>25</code> bits in the <code>Periodic Interval Timer Mode Register</code>. And we are doing it in the <code>pit_clkevt_set_periodic</code> function:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">pit_clkevt_set_periodic</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clock_event_device *dev)</span>
</span>{
        <span class="hljs-keyword">struct</span> pit_data *data = clkevt_to_pit_data(dev);
        ...
        ...
        ...
        pit_write(data-&gt;base, AT91_PIT_MR,
                  (data-&gt;cycle - <span class="hljs-number">1</span>) | AT91_PIT_PITEN | AT91_PIT_PITIEN);

        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>Where the <code>AT91_PT_MR</code>, <code>AT91_PT_PITEN</code> and the <code>AT91_PIT_PITIEN</code> are declared as:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AT91_PIT_MR             0x00</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AT91_PIT_PITIEN       BIT(25)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AT91_PIT_PITEN        BIT(24)</span>
</code></pre>
<p>After the setup of the new clock event device is finished, we can return to the <code>clockevents_register_device</code> function. The last function in the <code>clockevents_register_device</code> function is:</p>
<pre><code class="lang-C">clockevents_notify_released();
</code></pre>
<p>This function checks the <code>clockevents_released</code> list which contains released clock event devices (remember that they may occur after the call of the <code>clockevents_exchange_device</code> function). If this list is not empty, we go through clock event devices from the <code>clock_events_released</code> list and delete it from the <code>clockevent_devices</code>:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clockevents_notify_released</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">struct</span> clock_event_device *dev;

    <span class="hljs-keyword">while</span> (!list_empty(&amp;clockevents_released)) {
        dev = list_entry(clockevents_released.next,
                 <span class="hljs-keyword">struct</span> clock_event_device, <span class="hljs-built_in">list</span>);
        list_del(&amp;dev-&gt;<span class="hljs-built_in">list</span>);
        list_add(&amp;dev-&gt;<span class="hljs-built_in">list</span>, &amp;clockevent_devices);
        tick_check_new_device(dev);
    }
}
</code></pre>
<p>That&apos;s all. From this moment we have registered new clock event device. So the usage of the <code>clockevents</code> framework is simple and clear. Architectures registered their clock event devices, in the clock events core. Users of the clockevents core can get clock event devices for their use. The <code>clockevents</code> framework provides notification mechanisms for various clock related management events like a clock event device registered or unregistered, a processor is offlined in system which supports <a href="https://www.kernel.org/doc/Documentation/cpu-hotplug.txt" target="_blank">CPU hotplug</a> and etc.</p>
<p>We saw implementation only of the <code>clockevents_register_device</code> function. But generally, the clock event layer <a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank">API</a> is small. Besides the <code>API</code> for clock event device registration, the <code>clockevents</code> framework provides functions to schedule the next event interrupt, clock event device notification service and support for suspend and resume for clock event devices.</p>
<p>If you want to know more about <code>clockevents</code> API you can start to research following source code and header files: <a href="https://github.com/torvalds/linux/blob/master/kernel/time/tick-common.c" target="_blank">kernel/time/tick-common.c</a>, <a href="https://github.com/torvalds/linux/blob/master/kernel/time/clockevents.c" target="_blank">kernel/time/clockevents.c</a> and <a href="https://github.com/torvalds/linux/blob/master/include/linux/clockchips.h" target="_blank">include/linux/clockchips.h</a>.</p>
<p>That&apos;s all.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This is the end of the fifth part of the <a href="https://0xax.gitbooks.io/linux-insides/content/Timers/index.html" target="_blank">chapter</a> that describes timers and timer management related stuff in the Linux kernel. In the previous part got acquainted with the <code>timers</code> concept. In this part we continued to learn time management related stuff in the Linux kernel and saw a little about yet another framework - <code>clockevents</code>.</p>
<p>If you have questions or suggestions, feel free to ping me in twitter <a href="https://twitter.com/0xAX" target="_blank">0xAX</a>, drop me <a href="anotherworldofworld@gmail.com">email</a> or just create <a href="https://github.com/0xAX/linux-insides/issues/new" target="_blank">issue</a>.</p>
<p><strong>Please note that English is not my first language and I am really sorry for any inconvenience. If you found any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides" target="_blank">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://github.com/0xAX/linux/blob/master/Documentation/timers/timekeeping.txt" target="_blank">timekeeping documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Intel_8253" target="_blank">Intel 8253</a></li>
<li><a href="https://en.wikipedia.org/wiki/Programmable_interval_timer" target="_blank">programmable interval timer</a></li>
<li><a href="http://uefi.org/sites/default/files/resources/ACPI_5.pdf" target="_blank">ACPI pdf</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86" target="_blank">x86</a></li>
<li><a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer" target="_blank">High Precision Event Timer</a></li>
<li><a href="https://en.wikipedia.org/wiki/PowerPC" target="_blank">powerpc</a></li>
<li><a href="https://en.wikipedia.org/wiki/Frequency" target="_blank">frequency</a></li>
<li><a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank">API</a></li>
<li><a href="https://en.wikipedia.org/wiki/Nanosecond" target="_blank">nanoseconds</a></li>
<li><a href="https://en.wikipedia.org/wiki/Interrupt" target="_blank">interrupt</a></li>
<li><a href="https://en.wikipedia.org/wiki/Interrupt_handler" target="_blank">interrupt handler</a></li>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller" target="_blank">local APIC</a></li>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface#Device_states" target="_blank">C3 state</a> </li>
<li><a href="http://www.atmel.com/Images/doc6062.pdf" target="_blank">Periodic Interval Timer (PIT) for at91sam926x</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/Concepts/cpumask.html" target="_blank">CPU masks in the Linux kernel</a></li>
<li><a href="https://en.wikipedia.org/wiki/Deadlock" target="_blank">deadlock</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/cpu-hotplug.txt" target="_blank">CPU hotplug</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/Timers/timers-3.html" target="_blank">previous part</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="timers-4.html" class="navigation navigation-prev " aria-label="Previous page: Introduction to timers">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="timers-6.html" class="navigation navigation-next " aria-label="Next page: x86 related clock sources">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Clockevents framework","level":"1.6.5","depth":2,"next":{"title":"x86 related clock sources","level":"1.6.6","depth":2,"path":"Timers/timers-6.md","ref":"Timers/timers-6.md","articles":[]},"previous":{"title":"Introduction to timers","level":"1.6.4","depth":2,"path":"Timers/timers-4.md","ref":"Timers/timers-4.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Timers/timers-5.md","mtime":"2019-03-28T07:54:50.412Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T08:16:32.758Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

