
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="timers-2.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Initialization/">
            
                <a href="../Initialization/">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Initialization/linux-initialization-1.html">
            
                <a href="../Initialization/linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Initialization/linux-initialization-2.html">
            
                <a href="../Initialization/linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Initialization/linux-initialization-3.html">
            
                <a href="../Initialization/linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Initialization/linux-initialization-4.html">
            
                <a href="../Initialization/linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Initialization/linux-initialization-5.html">
            
                <a href="../Initialization/linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Initialization/linux-initialization-6.html">
            
                <a href="../Initialization/linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Initialization/linux-initialization-7.html">
            
                <a href="../Initialization/linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Initialization/linux-initialization-8.html">
            
                <a href="../Initialization/linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../Initialization/linux-initialization-9.html">
            
                <a href="../Initialization/linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../Initialization/linux-initialization-10.html">
            
                <a href="../Initialization/linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../SysCall/">
            
                <a href="../SysCall/">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../SysCall/syscall-1.html">
            
                <a href="../SysCall/syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../SysCall/syscall-2.html">
            
                <a href="../SysCall/syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../SysCall/syscall-3.html">
            
                <a href="../SysCall/syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../SysCall/syscall-4.html">
            
                <a href="../SysCall/syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../SysCall/syscall-5.html">
            
                <a href="../SysCall/syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.6.1" data-path="timers-1.html">
            
                <a href="timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="timers-2.html">
            
                <a href="timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="timers-3.html">
            
                <a href="timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="timers-4.html">
            
                <a href="timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="timers-5.html">
            
                <a href="timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="timers-6.html">
            
                <a href="timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="timers-7.html">
            
                <a href="timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Misc/">
            
                <a href="../Misc/">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Misc/how_kernel_compiled.html">
            
                <a href="../Misc/how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Misc/linkers.html">
            
                <a href="../Misc/linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="../Misc/contribute.html">
            
                <a href="../Misc/contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="../Misc/program_startup.html">
            
                <a href="../Misc/program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Introduction</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="timers-and-time-management-in-the-linux-kernel-part-1">Timers and time management in the Linux kernel. Part 1.</h1>
<h2 id="introduction">Introduction</h2>
<p>This is yet another post that opens a new chapter in the <a href="http://0xax.gitbooks.io/linux-insides/content/" target="_blank">linux-insides</a> book. The previous <a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-4.html" target="_blank">part</a> described <a href="https://en.wikipedia.org/wiki/System_call" target="_blank">system call</a> concepts, and now it&apos;s time to start new chapter. As one might understand from the title, this chapter will be devoted to the <code>timers</code> and <code>time management</code> in the Linux kernel. The choice of topic for the current chapter is not accidental. Timers (and generally, time management) are very important and widely used in the Linux kernel. The Linux kernel uses timers for various tasks, for example different timeouts in the <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank">TCP</a> implementation, the kernel knowing current time, scheduling asynchronous functions, next event interrupt scheduling and many many more.</p>
<p>So, we will start to learn implementation of the different time management related stuff in this part. We will see different types of timers and how different Linux kernel subsystems use them. As always, we will start from the earliest part of the Linux kernel and go through the initialization process of the Linux kernel. We already did it in the special <a href="https://0xax.gitbooks.io/linux-insides/content/Initialization/index.html" target="_blank">chapter</a> which describes the initialization process of the Linux kernel, but as you may remember we missed some things there. And one of them is the initialization of timers.</p>
<p>Let&apos;s start.</p>
<h2 id="initialization-of-non-standard-pc-hardware-clock">Initialization of non-standard PC hardware clock</h2>
<p>After the Linux kernel was decompressed (more about this you can read in the <a href="https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-5.html" target="_blank">Kernel decompression</a> part) the architecture non-specific code starts to work in the <a href="https://github.com/torvalds/linux/blob/master/init/main.c" target="_blank">init/main.c</a> source code file. After initialization of the <a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt" target="_blank">lock validator</a>, initialization of <a href="https://en.wikipedia.org/wiki/Cgroups" target="_blank">cgroups</a> and setting <a href="https://en.wikipedia.org/wiki/Buffer_overflow_protection" target="_blank">canary</a> value we can see the call of the <code>setup_arch</code> function.</p>
<p>As you may remember, this function (defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup.c#L842" target="_blank">arch/x86/kernel/setup.c</a>) prepares/initializes architecture-specific stuff (for example it reserves a place for <a href="https://en.wikipedia.org/wiki/.bss" target="_blank">bss</a> section, reserves a place for <a href="https://en.wikipedia.org/wiki/Initrd" target="_blank">initrd</a>, parses kernel command line, and many, many other things). Besides this, we can find some time management related functions there.</p>
<p>The first is:</p>
<pre><code class="lang-C">x86_init.timers.wallclock_init();
</code></pre>
<p>We already saw <code>x86_init</code> structure in the chapter that describes initialization of the Linux kernel. This structure contains pointers to the default setup functions for the different platforms like <a href="https://en.wikipedia.org/wiki/Mobile_Internet_device#Intel_MID_platforms" target="_blank">Intel MID</a>, <a href="http://www.wpgholdings.com/epaper/US/newsRelease_20091215/255874.pdf" target="_blank">Intel CE4100</a>, etc. The <code>x86_init</code> structure is defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/x86_init.c#L36" target="_blank">arch/x86/kernel/x86_init.c</a>, and as you can see it determines standard PC hardware by default.</p>
<p>As we can see, the <code>x86_init</code> structure has the <code>x86_init_ops</code> type that provides a set of functions for platform specific setup like reserving standard resources, platform specific memory setup, initialization of interrupt handlers, etc. This structure looks like:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> x86_init_ops {
    <span class="hljs-keyword">struct</span> x86_init_resources       resources;
    <span class="hljs-keyword">struct</span> x86_init_mpparse         mpparse;
    <span class="hljs-keyword">struct</span> x86_init_irqs            irqs;
    <span class="hljs-keyword">struct</span> x86_init_oem             oem;
    <span class="hljs-keyword">struct</span> x86_init_paging          paging;
    <span class="hljs-keyword">struct</span> x86_init_timers          timers;
    <span class="hljs-keyword">struct</span> x86_init_iommu           iommu;
    <span class="hljs-keyword">struct</span> x86_init_pci             pci;
};
</code></pre>
<p>Note the <code>timers</code> field that has the <code>x86_init_timers</code> type. We can understand by its name that this field is related to time management and timers. <code>x86_init_timers</code> contains four fields which are all functions that returns pointer on <a href="https://en.wikipedia.org/wiki/Void_type" target="_blank">void</a>:</p>
<ul>
<li><code>setup_percpu_clockev</code> - set up the per cpu clock event device for the boot cpu;</li>
<li><code>tsc_pre_init</code> - platform function called before <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter" target="_blank">TSC</a> init;</li>
<li><code>timer_init</code> - initialize the platform timer;</li>
<li><code>wallclock_init</code> - initialize the wallclock device.</li>
</ul>
<p>So, as we already know, in our case the <code>wallclock_init</code> executes initialization of the wallclock device. If we look on the <code>x86_init</code> structure, we see that <code>wallclock_init</code> points to the <code>x86_init_noop</code>:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> x86_init_ops x86_init __initdata = {
    ...
    ...
    ...
    .timers = {
        .wallclock_init            = x86_init_noop,
    },
    ...
    ...
    ...
}
</code></pre>
<p>Where the <code>x86_init_noop</code> is just a function that does nothing:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">cpuinit <span class="hljs-title">x86_init_noop</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{ }
</code></pre>
<p>for the standard PC hardware. Actually, the <code>wallclock_init</code> function is used in the <a href="https://en.wikipedia.org/wiki/Mobile_Internet_device#Intel_MID_platforms" target="_blank">Intel MID</a> platform. Initialization of the <code>x86_init.timers.wallclock_init</code> is located in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/platform/intel-mid/intel-mid.c" target="_blank">arch/x86/platform/intel-mid/intel-mid.c</a> source code file in the <code>x86_intel_mid_early_setup</code> function:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">x86_intel_mid_early_setup</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ...
    ...
    ...
    x86_init.timers.wallclock_init = intel_mid_rtc_init;
    ...
    ...
    ...
}
</code></pre>
<p>Implementation of the <code>intel_mid_rtc_init</code> function is in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/platform/intel-mid/intel_mid_vrtc.c" target="_blank">arch/x86/platform/intel-mid/intel_mid_vrtc.c</a> source code file and looks pretty simple. First of all, this function parses <a href="https://en.wikipedia.org/wiki/Simple_Firmware_Interface" target="_blank">Simple Firmware Interface</a> M-Real-Time-Clock table for getting such devices to the <code>sfi_mrtc_array</code> array and initialization of the <code>set_time</code> and <code>get_time</code> functions:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">intel_mid_rtc_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vrtc_paddr;

    sfi_table_parse(SFI_SIG_MRTC, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, sfi_parse_mrtc);

    vrtc_paddr = sfi_mrtc_array[<span class="hljs-number">0</span>].phys_addr;
    <span class="hljs-keyword">if</span> (!sfi_mrtc_num || !vrtc_paddr)
        <span class="hljs-keyword">return</span>;

    vrtc_virt_base = (<span class="hljs-keyword">void</span> __iomem *)set_fixmap_offset_nocache(FIX_LNW_VRTC,
                                vrtc_paddr);

    x86_platform.get_wallclock = vrtc_get_time;
    x86_platform.set_wallclock = vrtc_set_mmss;
}
</code></pre>
<p>That&apos;s all, after this a device based on <code>Intel MID</code> will be able to get time from the hardware clock. As I already wrote, the standard PC <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a> architecture does not support <code>x86_init_noop</code> and just do nothing during call of this function. We just saw initialization of the <a href="https://en.wikipedia.org/wiki/Real-time_clock" target="_blank">real time clock</a> for the <a href="https://en.wikipedia.org/wiki/Mobile_Internet_device#Intel_MID_platforms" target="_blank">Intel MID</a> architecture, now it&apos;s time to return to the general <code>x86_64</code> architecture and will look on the time management related stuff there.</p>
<h2 id="acquainted-with-jiffies">Acquainted with jiffies</h2>
<p>If we return to the <code>setup_arch</code> function (which is located, as you remember, in the  <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup.c#L842" target="_blank">arch/x86/kernel/setup.c</a> source code file), we see the next call of the time management related function:</p>
<pre><code class="lang-C">register_refined_jiffies(CLOCK_TICK_RATE);
</code></pre>
<p>Before we look at the implementation of this function, we must know about <a href="https://en.wikipedia.org/wiki/Jiffy_%28time%29" target="_blank">jiffy</a>. As we can read on wikipedia:</p>
<pre><code>Jiffy is an informal term for any unspecified short period of time
</code></pre><p>This definition is very similar to the <code>jiffy</code> in the Linux kernel. There is global variable with the <code>jiffies</code> which holds the number of ticks that have occurred since the system booted. The Linux kernel sets this variable to zero:</p>
<pre><code class="lang-C"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">volatile</span> __jiffy_data jiffies;
</code></pre>
<p>during initialization process. This global variable will be increased each time during timer interrupt. Besides this, near the <code>jiffies</code> variable we can see the definition of the similar variable</p>
<pre><code class="lang-C"><span class="hljs-keyword">extern</span> u64 jiffies_64;
</code></pre>
<p>Actually, only one of these variables is in use in the Linux kernel, and it depends on the processor type. For the <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a> it will be <code>u64</code> use and for the <a href="https://en.wikipedia.org/wiki/X86" target="_blank">x86</a> it&apos;s <code>unsigned long</code>. We see this looking at the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/vmlinux.lds.S" target="_blank">arch/x86/kernel/vmlinux.lds.S</a> linker script:</p>
<pre><code>#ifdef CONFIG_X86_32
...
jiffies = jiffies_64;
...
#else
...
jiffies_64 = jiffies;
...
#endif
</code></pre><p>In the case of <code>x86_32</code> the <code>jiffies</code> will be the lower <code>32</code> bits of the <code>jiffies_64</code> variable. Schematically, we can imagine it as follows</p>
<pre><code>                    jiffies_64
+-----------------------------------------------------+
|                       |                             |
|                       |                             |
|                       |       jiffies on `x86_32`   |
|                       |                             |
|                       |                             |
+-----------------------------------------------------+
63                     31                             0
</code></pre><p>Now we know a little theory about <code>jiffies</code> and can return to our function. There is no architecture-specific implementation for our function - the <code>register_refined_jiffies</code>. This function is located in the generic kernel code - <a href="https://github.com/torvalds/linux/blob/master/kernel/time/jiffies.c" target="_blank">kernel/time/jiffies.c</a> source code file. Main point of the <code>register_refined_jiffies</code> is registration of the jiffy <code>clocksource</code>. Before we look on the implementation of the <code>register_refined_jiffies</code> function, we must know what <code>clocksource</code> is. As we can read in the comments:</p>
<pre><code>The `clocksource` is hardware abstraction for a free-running counter.
</code></pre><p>I&apos;m not sure about you, but that description didn&apos;t give a good understanding about the <code>clocksource</code> concept. Let&apos;s try to understand what is it, but we will not go deeper because this topic will be described in a separate part in much more detail. The main point of the <code>clocksource</code> is timekeeping abstraction or in very simple words - it provides a time value to the kernel. We already know about the <code>jiffies</code> interface that represents number of ticks that have occurred since the system booted. It is represented by a global variable in the Linux kernel and increases each timer interrupt. The Linux kernel can use <code>jiffies</code> for time measurement. So why do we need in separate context like the <code>clocksource</code>? Actually, different hardware devices provide different clock sources that are varied in their capabilities. The availability of more precise techniques for time intervals measurement is hardware-dependent.</p>
<p>For example <code>x86</code> has on-chip a 64-bit counter that is called <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter" target="_blank">Time Stamp  Counter</a> and its frequency can be equal to processor frequency. Or for example the <a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer" target="_blank">High Precision Event Timer</a>, that consists of a <code>64-bit</code> counter of at least <code>10 MHz</code> frequency. Two different timers and they are both for <code>x86</code>. If we will add timers from other architectures, this only makes this problem more complex. The Linux kernel provides the <code>clocksource</code> concept to solve the problem.</p>
<p>The clocksource concept is represented by the <code>clocksource</code> structure in the Linux kernel. This structure is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/clocksource.h" target="_blank">include/linux/clocksource.h</a> header file and contains a couple of fields that describe a time counter. For example, it contains - <code>name</code> field which is the name of a counter, <code>flags</code> field that describes different properties of a counter, pointers to the <code>suspend</code> and <code>resume</code> functions, and many more.</p>
<p>Let&apos;s look at the <code>clocksource</code> structure for jiffies that is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/jiffies.c" target="_blank">kernel/time/jiffies.c</a> source code file:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> clocksource clocksource_jiffies = {
    .name        = <span class="hljs-string">&quot;jiffies&quot;</span>,
    .rating        = <span class="hljs-number">1</span>,
    .read        = jiffies_read,
    .mask        = <span class="hljs-number">0xffffffff</span>,
    .mult        = NSEC_PER_JIFFY &lt;&lt; JIFFIES_SHIFT,
    .shift        = JIFFIES_SHIFT,
    .max_cycles    = <span class="hljs-number">10</span>,
};
</code></pre>
<p>We can see the definition of the default name here - <code>jiffies</code>. The next is the <code>rating</code> field, which allows the best registered clock source to be chosen by the clock source management code available for the specified hardware. The <code>rating</code> may have following value:</p>
<ul>
<li><code>1-99</code>    - Only available for bootup and testing purposes;</li>
<li><code>100-199</code> - Functional for real use, but not desired.</li>
<li><code>200-299</code> - A correct and usable clocksource.</li>
<li><code>300-399</code> - A reasonably fast and accurate clocksource.</li>
<li><code>400-499</code> - The ideal clocksource. A must-use where available;</li>
</ul>
<p>For example, rating of the <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter" target="_blank">time stamp counter</a> is <code>300</code>, but rating of the <a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer" target="_blank">high precision event timer</a> is <code>250</code>. The next field is <code>read</code> - it is pointer to the function that allows it to read clocksource&apos;s cycle value; or in other words, it just returns <code>jiffies</code> variable with <code>cycle_t</code> type:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> cycle_t <span class="hljs-title">jiffies_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clocksource *cs)</span>
</span>{
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">cycle_t</span>) jiffies;
}
</code></pre>
<p>that is just 64-bit unsigned type:</p>
<pre><code class="lang-C"><span class="hljs-keyword">typedef</span> u64 <span class="hljs-keyword">cycle_t</span>;
</code></pre>
<p>The next field is the <code>mask</code> value, which ensures that subtraction between counters values from non <code>64 bit</code> counters do not need special overflow logic. In our case the mask is <code>0xffffffff</code> and it is <code>32</code> bits. This means that <code>jiffy</code> wraps around to zero after <code>42</code> seconds:</p>
<pre><code class="lang-python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">0xffffffff</span>
<span class="hljs-number">4294967295</span>
<span class="hljs-comment"># 42 nanoseconds</span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">42</span> * pow(<span class="hljs-number">10</span>, <span class="hljs-number">-9</span>)
<span class="hljs-number">4.2000000000000006e-08</span>
<span class="hljs-comment"># 43 nanoseconds</span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">43</span> * pow(<span class="hljs-number">10</span>, <span class="hljs-number">-9</span>)
<span class="hljs-number">4.3e-08</span>
</code></pre>
<p>The next two fields <code>mult</code> and <code>shift</code> are used to convert the clocksource&apos;s period to nanoseconds per cycle. When the kernel calls the <code>clocksource.read</code> function, this function returns a value in <code>machine</code> time units represented with <code>cycle_t</code> data type that we saw just now. To convert this return value to <a href="https://en.wikipedia.org/wiki/Nanosecond" target="_blank">nanoseconds</a> we need these two fields: <code>mult</code> and <code>shift</code>. The <code>clocksource</code> provides the <code>clocksource_cyc2ns</code> function that will do it for us with the following expression:</p>
<pre><code class="lang-C">((u64) cycles * mult) &gt;&gt; shift;
</code></pre>
<p>As we can see the <code>mult</code> field is equal:</p>
<pre><code class="lang-C">NSEC_PER_JIFFY &lt;&lt; JIFFIES_SHIFT

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NSEC_PER_JIFFY  ((NSEC_PER_SEC+HZ/2)/HZ)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NSEC_PER_SEC    1000000000L</span>
</code></pre>
<p>by default, and the <code>shift</code> is</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HZ &lt; 34</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> JIFFIES_SHIFT   6</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> HZ &lt; 67</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> JIFFIES_SHIFT   7</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> JIFFIES_SHIFT   8</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>The <code>jiffies</code> clock source uses the <code>NSEC_PER_JIFFY</code> multiplier conversion to specify the nanosecond over cycle ratio. Note that values of the  <code>JIFFIES_SHIFT</code> and <code>NSEC_PER_JIFFY</code> depend on <code>HZ</code> value. The <code>HZ</code> represents the frequency of the system timer. This macro defined in the <a href="https://github.com/torvalds/linux/blob/master/include/asm-generic/param.h" target="_blank">include/asm-generic/param.h</a> and depends on the <code>CONFIG_HZ</code> kernel configuration option. The value of <code>HZ</code> differs for each supported architecture, but for <code>x86</code> it&apos;s defined like:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HZ        CONFIG_HZ</span>
</code></pre>
<p>Where <code>CONFIG_HZ</code> can be one of the following values:</p>
<p><img src="http://s9.postimg.org/xy85r3jrj/image.png" alt="HZ"></p>
<p>This means that in our case the timer interrupt frequency is <code>250 HZ</code> or occurs <code>250</code> times per second or one timer interrupt each <code>4ms</code>.</p>
<p>The last field that we can see in the definition of the <code>clocksource_jiffies</code> structure is the - <code>max_cycles</code> that holds the maximum cycle value that can safely be multiplied without potentially causing an overflow.</p>
<p>Ok, we just saw definition of the <code>clocksource_jiffies</code> structure, also we know a little about <code>jiffies</code> and <code>clocksource</code>, now it is time to get back to the implementation of the our function. In the beginning of this part we have stopped on the call of the:</p>
<pre><code class="lang-C">register_refined_jiffies(CLOCK_TICK_RATE);
</code></pre>
<p>function from the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup.c#L842" target="_blank">arch/x86/kernel/setup.c</a> source code file.</p>
<p>As I already wrote, the main purpose of the <code>register_refined_jiffies</code> function is to register <code>refined_jiffies</code> clocksource. We already saw the <code>clocksource_jiffies</code> structure represents standard <code>jiffies</code> clock source. Now, if you look in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/jiffies.c" target="_blank">kernel/time/jiffies.c</a> source code file, you will find yet another clock source definition:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> clocksource refined_jiffies;
</code></pre>
<p>There is one difference between <code>refined_jiffies</code> and <code>clocksource_jiffies</code>: The standard <code>jiffies</code> based clock source is the lowest common denominator clock source which should function on all systems. As we already know, the <code>jiffies</code> global variable will be increased during each timer interrupt. This means the that standard <code>jiffies</code> based clock source has the same resolution as the timer interrupt frequency. From this we can understand that standard <code>jiffies</code> based clock source may suffer from inaccuracies. The <code>refined_jiffies</code> uses <code>CLOCK_TICK_RATE</code> as the base of <code>jiffies</code> shift.</p>
<p>Let&apos;s look at the implementation of this function. First of all, we can see that the <code>refined_jiffies</code> clock source based on the <code>clocksource_jiffies</code> structure:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">register_refined_jiffies</span><span class="hljs-params">(<span class="hljs-keyword">long</span> cycles_per_second)</span>
</span>{
    u64 nsec_per_tick, shift_hz;
    <span class="hljs-keyword">long</span> cycles_per_tick;

    refined_jiffies = clocksource_jiffies;
    refined_jiffies.name = <span class="hljs-string">&quot;refined-jiffies&quot;</span>;
    refined_jiffies.rating++;
    ...
    ...
    ...
</code></pre>
<p>Here we can see that we update the name of the <code>refined_jiffies</code> to <code>refined-jiffies</code> and increase the rating of this structure. As you remember, the <code>clocksource_jiffies</code> has rating - <code>1</code>, so our <code>refined_jiffies</code> clocksource will have rating - <code>2</code>. This means that the <code>refined_jiffies</code> will be the best selection for clock source management code.</p>
<p>In the next step we need to calculate number of cycles per one tick:</p>
<pre><code class="lang-C">cycles_per_tick = (cycles_per_second + HZ/<span class="hljs-number">2</span>)/HZ;
</code></pre>
<p>Note that we have used <code>NSEC_PER_SEC</code> macro as the base of the standard <code>jiffies</code> multiplier. Here we are using the <code>cycles_per_second</code> which is the first parameter of the <code>register_refined_jiffies</code> function. We&apos;ve passed the <code>CLOCK_TICK_RATE</code> macro to the <code>register_refined_jiffies</code> function. This macro is defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/include/asm/timex.h" target="_blank">arch/x86/include/asm/timex.h</a> header file and expands to the:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLOCK_TICK_RATE         PIT_TICK_RATE</span>
</code></pre>
<p>where the <code>PIT_TICK_RATE</code> macro expands to the frequency of the <a href="Programmable%20interval%20timer">Intel 8253</a>:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIT_TICK_RATE 1193182ul</span>
</code></pre>
<p>After this we calculate <code>shift_hz</code> for the <code>register_refined_jiffies</code> that will store <code>hz &lt;&lt; 8</code> or in other words frequency of the system timer. We shift left the <code>cycles_per_second</code> or frequency of the programmable interval timer on <code>8</code> in order to get extra accuracy:</p>
<pre><code class="lang-C">shift_hz = (u64)cycles_per_second &lt;&lt; <span class="hljs-number">8</span>;
shift_hz += cycles_per_tick/<span class="hljs-number">2</span>;
do_div(shift_hz, cycles_per_tick);
</code></pre>
<p>In the next step we calculate the number of seconds per one tick by shifting left the <code>NSEC_PER_SEC</code> on <code>8</code> too as we did it with the <code>shift_hz</code> and do the same calculation as before:</p>
<pre><code class="lang-C">nsec_per_tick = (u64)NSEC_PER_SEC &lt;&lt; <span class="hljs-number">8</span>;
nsec_per_tick += (u32)shift_hz/<span class="hljs-number">2</span>;
do_div(nsec_per_tick, (u32)shift_hz);
</code></pre>
<pre><code class="lang-C">refined_jiffies.mult = ((u32)nsec_per_tick) &lt;&lt; JIFFIES_SHIFT;
</code></pre>
<p>In the end of the <code>register_refined_jiffies</code> function we register new clock source with the <code>__clocksource_register</code> function that is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/clocksource.h" target="_blank">include/linux/clocksource.h</a> header file and return:</p>
<pre><code class="lang-C">__clocksource_register(&amp;refined_jiffies);
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>The clock source management code provides the API for clock source registration and selection. As we can see, clock sources are registered by calling the  <code>__clocksource_register</code> function during kernel initialization or from a kernel module. During registration, the clock source management code will choose the best clock source available in the system using the <code>clocksource.rating</code> field which we already saw when we initialized <code>clocksource</code> structure for <code>jiffies</code>.</p>
<h2 id="using-the-jiffies">Using the jiffies</h2>
<p>We just saw initialization of two <code>jiffies</code> based clock sources in the previous paragraph:</p>
<ul>
<li>standard <code>jiffies</code> based clock source;</li>
<li>refined  <code>jiffies</code> based clock source;</li>
</ul>
<p>Don&apos;t worry if you don&apos;t understand the calculations here. They look frightening at first. Soon, step by step we will learn these things. So, we just saw initialization of <code>jiffies</code> based clock sources and also we know that the Linux kernel has the global variable <code>jiffies</code> that holds the number of ticks that have occurred since the kernel started to work. Now, let&apos;s look how to use it. To use <code>jiffies</code> we just can use the <code>jiffies</code> global variable by its name or with the call of the <code>get_jiffies_64</code> function. This function defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/time/jiffies.c" target="_blank">kernel/time/jiffies.c</a> source code file and just returns full <code>64-bit</code> value of the <code>jiffies</code>:</p>
<pre><code class="lang-C"><span class="hljs-function">u64 <span class="hljs-title">get_jiffies_64</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> seq;
    u64 ret;

    <span class="hljs-keyword">do</span> {
        seq = read_seqbegin(&amp;jiffies_lock);
        ret = jiffies_64;
    } <span class="hljs-keyword">while</span> (read_seqretry(&amp;jiffies_lock, seq));
    <span class="hljs-keyword">return</span> ret;
}
EXPORT_SYMBOL(get_jiffies_64);
</code></pre>
<p>Note that the <code>get_jiffies_64</code> function does not implemented as <code>jiffies_read</code> for example:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> cycle_t <span class="hljs-title">jiffies_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> clocksource *cs)</span>
</span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">cycle_t</span>) jiffies;
}
</code></pre>
<p>We can see that implementation of the <code>get_jiffies_64</code> is more complex. The reading of the <code>jiffies_64</code> variable is implemented using <a href="https://en.wikipedia.org/wiki/Seqlock" target="_blank">seqlocks</a>. Actually this is done for machines that cannot atomically read the full 64-bit values.</p>
<p>If we can access the <code>jiffies</code> or the <code>jiffies_64</code> variable we can convert it to <code>human</code> time units. To get one second we can use following expression:</p>
<pre><code class="lang-C">jiffies / HZ
</code></pre>
<p>So, if we know this, we can get any time units. For example:</p>
<pre><code class="lang-C"><span class="hljs-comment">/* Thirty seconds from now */</span>
jiffies + <span class="hljs-number">30</span>*HZ

<span class="hljs-comment">/* Two minutes from now */</span>
jiffies + <span class="hljs-number">120</span>*HZ

<span class="hljs-comment">/* One millisecond from now */</span>
jiffies + HZ / <span class="hljs-number">1000</span>
</code></pre>
<p>That&apos;s all.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This concludes the first part covering time and time management related concepts in the Linux kernel. We first met two concepts and their initialization: <code>jiffies</code> and <code>clocksource</code>. In the next part we will continue to dive into this interesting theme, and as I already wrote in this part, we will try to understand the insides of these and other time management concepts in the Linux kernel.</p>
<p>If you have questions or suggestions, feel free to ping me in twitter <a href="https://twitter.com/0xAX" target="_blank">0xAX</a>, drop me <a href="anotherworldofworld@gmail.com">email</a> or just create <a href="https://github.com/0xAX/linux-insides/issues/new" target="_blank">issue</a>.</p>
<p><strong>Please note that English is not my first language and I am really sorry for any inconvenience. If you found any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides" target="_blank">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/System_call" target="_blank">system call</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank">TCP</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt" target="_blank">lock validator</a></li>
<li><a href="https://en.wikipedia.org/wiki/Cgroups" target="_blank">cgroups</a></li>
<li><a href="https://en.wikipedia.org/wiki/.bss" target="_blank">bss</a></li>
<li><a href="https://en.wikipedia.org/wiki/Initrd" target="_blank">initrd</a></li>
<li><a href="https://en.wikipedia.org/wiki/Mobile_Internet_device#Intel_MID_platforms" target="_blank">Intel MID</a></li>
<li><a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter" target="_blank">TSC</a></li>
<li><a href="https://en.wikipedia.org/wiki/Void_type" target="_blank">void</a></li>
<li><a href="https://en.wikipedia.org/wiki/Simple_Firmware_Interface" target="_blank">Simple Firmware Interface</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a></li>
<li><a href="https://en.wikipedia.org/wiki/Real-time_clock" target="_blank">real time clock</a></li>
<li><a href="https://en.wikipedia.org/wiki/Jiffy_%28time%29" target="_blank">Jiffy</a></li>
<li><a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer" target="_blank">high precision event timer</a></li>
<li><a href="https://en.wikipedia.org/wiki/Nanosecond" target="_blank">nanoseconds</a></li>
<li><a href="https://en.wikipedia.org/wiki/Intel_8253" target="_blank">Intel 8253</a></li>
<li><a href="https://en.wikipedia.org/wiki/Seqlock" target="_blank">seqlocks</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/timers/timekeeping.txt" target="_blank">cloksource documentation</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/index.html" target="_blank">Previous chapter</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Timers and time management">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="timers-2.html" class="navigation navigation-next " aria-label="Next page: Clocksource framework">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction","level":"1.6.1","depth":2,"next":{"title":"Clocksource framework","level":"1.6.2","depth":2,"path":"Timers/timers-2.md","ref":"Timers/timers-2.md","articles":[]},"previous":{"title":"Timers and time management","level":"1.6","depth":1,"path":"Timers/README.md","ref":"Timers/README.md","articles":[{"title":"Introduction","level":"1.6.1","depth":2,"path":"Timers/timers-1.md","ref":"Timers/timers-1.md","articles":[]},{"title":"Clocksource framework","level":"1.6.2","depth":2,"path":"Timers/timers-2.md","ref":"Timers/timers-2.md","articles":[]},{"title":"The tick broadcast framework and dyntick","level":"1.6.3","depth":2,"path":"Timers/timers-3.md","ref":"Timers/timers-3.md","articles":[]},{"title":"Introduction to timers","level":"1.6.4","depth":2,"path":"Timers/timers-4.md","ref":"Timers/timers-4.md","articles":[]},{"title":"Clockevents framework","level":"1.6.5","depth":2,"path":"Timers/timers-5.md","ref":"Timers/timers-5.md","articles":[]},{"title":"x86 related clock sources","level":"1.6.6","depth":2,"path":"Timers/timers-6.md","ref":"Timers/timers-6.md","articles":[]},{"title":"Time related system calls","level":"1.6.7","depth":2,"path":"Timers/timers-7.md","ref":"Timers/timers-7.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Timers/timers-1.md","mtime":"2019-03-28T07:54:50.409Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T08:16:32.758Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

