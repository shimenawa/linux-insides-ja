
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>How the kernel is compiled Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="linkers.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Initialization/">
            
                <a href="../Initialization/">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Initialization/linux-initialization-1.html">
            
                <a href="../Initialization/linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Initialization/linux-initialization-2.html">
            
                <a href="../Initialization/linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Initialization/linux-initialization-3.html">
            
                <a href="../Initialization/linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Initialization/linux-initialization-4.html">
            
                <a href="../Initialization/linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Initialization/linux-initialization-5.html">
            
                <a href="../Initialization/linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Initialization/linux-initialization-6.html">
            
                <a href="../Initialization/linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Initialization/linux-initialization-7.html">
            
                <a href="../Initialization/linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Initialization/linux-initialization-8.html">
            
                <a href="../Initialization/linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../Initialization/linux-initialization-9.html">
            
                <a href="../Initialization/linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../Initialization/linux-initialization-10.html">
            
                <a href="../Initialization/linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../SysCall/">
            
                <a href="../SysCall/">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../SysCall/syscall-1.html">
            
                <a href="../SysCall/syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../SysCall/syscall-2.html">
            
                <a href="../SysCall/syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../SysCall/syscall-3.html">
            
                <a href="../SysCall/syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../SysCall/syscall-4.html">
            
                <a href="../SysCall/syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../SysCall/syscall-5.html">
            
                <a href="../SysCall/syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Timers/">
            
                <a href="../Timers/">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Timers/timers-1.html">
            
                <a href="../Timers/timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Timers/timers-2.html">
            
                <a href="../Timers/timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Timers/timers-3.html">
            
                <a href="../Timers/timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Timers/timers-4.html">
            
                <a href="../Timers/timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Timers/timers-5.html">
            
                <a href="../Timers/timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Timers/timers-6.html">
            
                <a href="../Timers/timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Timers/timers-7.html">
            
                <a href="../Timers/timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="./">
            
                <a href="./">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.15.1" data-path="how_kernel_compiled.html">
            
                <a href="how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="linkers.html">
            
                <a href="linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="contribute.html">
            
                <a href="contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="program_startup.html">
            
                <a href="program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >How the kernel is compiled</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="process-of-the-linux-kernel-building">Process of the Linux kernel building</h1>
<h2 id="introduction">Introduction</h2>
<p>I won&apos;t tell you how to build and install a custom Linux kernel on your machine. If you need help with this, you can find many <a href="https://encrypted.google.com/search?q=building+linux+kernel#q=building+linux+kernel+from+source+code" target="_blank">resources</a> that will help you do it. Instead, we will learn what occurs when you execute <code>make</code> in the root directory of the Linux kernel source code.</p>
<p>When I started to study the source code of the Linux kernel, the <a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">makefile</a> was the first file that I opened. And it was scary :). The <a href="https://en.wikipedia.org/wiki/Make_%28software%29" target="_blank">makefile</a> contained <code>1591</code> lines of code when I wrote this part and the kernel was the <a href="https://github.com/torvalds/linux/commit/52721d9d3334c1cb1f76219a161084094ec634dc" target="_blank">4.2.0-rc3</a> release.</p>
<p>This makefile is the top makefile in the Linux kernel source code and the kernel building starts here. Yes, it is big, but moreover, if you&apos;ve read the source code of the Linux kernel you may have noted that all directories containing source code has its own makefile. Of course it is not possible to describe how each source file is compiled and linked, so we will only study the standard compilation case. You will not find here building of the kernel&apos;s documentation, cleaning of the kernel source code, <a href="https://en.wikipedia.org/wiki/Ctags" target="_blank">tags</a> generation, <a href="https://en.wikipedia.org/wiki/Cross_compiler" target="_blank">cross-compilation</a> related stuff, etc... We will start from the <code>make</code> execution with the standard kernel configuration file and will finish with the building of the <a href="https://en.wikipedia.org/wiki/Vmlinux#bzImage" target="_blank">bzImage</a>.</p>
<p>It would be better if you&apos;re already familiar with the <a href="https://en.wikipedia.org/wiki/Make_%28software%29" target="_blank">make</a> util, but I will try to describe every piece of code in this part anyway.</p>
<p>So let&apos;s start.</p>
<h2 id="preparation-before-the-kernel-compilation">Preparation before the kernel compilation</h2>
<p>There are many things to prepare before the kernel compilation can be started. The main point here is to find and configure
the type of compilation, to parse command line arguments that are passed to <code>make</code>, etc... So let&apos;s dive into the top <code>Makefile</code> of Linux kernel.</p>
<p>The top <code>Makefile</code> of Linux kernel is responsible for building two major products: <a href="https://en.wikipedia.org/wiki/Vmlinux" target="_blank">vmlinux</a> (the resident kernel image) and the modules (any module files). The <a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">Makefile</a> of the Linux kernel starts with the definition of following variables:</p>
<pre><code class="lang-Makefile">VERSION = 4
PATCHLEVEL = 2
SUBLEVEL = 0
EXTRAVERSION = -rc3
NAME = Hurr durr I&apos;ma sheep
</code></pre>
<p>These variables determine the current version of Linux kernel and are used in different places, for example in the forming of the <code>KERNELVERSION</code> variable in the same <code>Makefile</code>:</p>
<pre><code class="lang-Makefile">KERNELVERSION = <span class="hljs-variable">$(VERSION)</span><span class="hljs-variable">$(if $(PATCHLEVEL)</span>,.<span class="hljs-variable">$(PATCHLEVEL)</span><span class="hljs-variable">$(if $(SUBLEVEL)</span>,.<span class="hljs-variable">$(SUBLEVEL)</span>))<span class="hljs-variable">$(EXTRAVERSION)</span>
</code></pre>
<p>After this we can see a couple of <code>ifeq</code> conditions that check some of the parameters passed to <code>make</code>. The Linux kernel <code>makefiles</code> provides a special <code>make help</code> target that prints all available targets and some of the command line arguments that can be passed to <code>make</code>. For example : <code>make V=1</code> =&gt; verbose build. The first <code>ifeq</code> checks whether the <code>V=n</code> option is passed to <code>make</code>:</p>
<pre><code class="lang-Makefile">ifeq (&quot;$(origin V)&quot;, &quot;command line&quot;)
  KBUILD_VERBOSE = $(V)
endif
ifndef KBUILD_VERBOSE
  KBUILD_VERBOSE = 0
endif

ifeq ($(KBUILD_VERBOSE),1)
  quiet =
  Q =
else
  quiet=quiet_
  Q = @
endif

export quiet Q KBUILD_VERBOSE
</code></pre>
<p>If this option is passed to <code>make</code>, we set the <code>KBUILD_VERBOSE</code> variable to the value of <code>V</code> option. Otherwise we set the <code>KBUILD_VERBOSE</code> variable to zero. After this we check the value of <code>KBUILD_VERBOSE</code> variable and set values of the <code>quiet</code> and <code>Q</code> variables depending on the value of <code>KBUILD_VERBOSE</code> variable. The <code>@</code> symbols suppress the output of command. And if it is present before a command the output will be something like this: <code>CC scripts/mod/empty.o</code> instead of <code>Compiling .... scripts/mod/empty.o</code>. In the end we just export all of these variables. The next <code>ifeq</code> statement checks that <code>O=/dir</code> option was passed to the <code>make</code>. This option allows to locate all output files in the given <code>dir</code>:</p>
<pre><code class="lang-Makefile">ifeq ($(KBUILD_SRC),)

ifeq (&quot;$(origin O)&quot;, &quot;command line&quot;)
  KBUILD_OUTPUT := $(O)
endif

ifneq ($(KBUILD_OUTPUT),)
saved-output := $(KBUILD_OUTPUT)
KBUILD_OUTPUT := <span class="hljs-variable">$(shell mkdir -p $(KBUILD_OUTPUT)</span> &amp;&amp; cd <span class="hljs-variable">$(KBUILD_OUTPUT)</span> \
                                &amp;&amp; /bin/pwd)
$(if $(KBUILD_OUTPUT),, \
     $(error failed to create output directory &quot;$(saved-output)&quot;))

sub-make: FORCE
    $(Q)$(MAKE) -C $(KBUILD_OUTPUT) KBUILD_SRC=$(CURDIR) \
    -f $(CURDIR)/Makefile $(filter-out _all sub-make,$(MAKECMDGOALS))

skip-makefile := 1
endif <span class="hljs-comment"># ifneq ($(KBUILD_OUTPUT),)</span>
endif <span class="hljs-comment"># ifeq ($(KBUILD_SRC),)</span>
</code></pre>
<p>We check the <code>KBUILD_SRC</code> that represents the top directory of the kernel source code and whether it is empty (it is empty when the makefile is executed for the first time). We then set the <code>KBUILD_OUTPUT</code> variable to the value passed with the <code>O</code> option (if this option was passed). In the next step we check this <code>KBUILD_OUTPUT</code> variable and if it is set, we do following things:</p>
<ul>
<li>Store the value of <code>KBUILD_OUTPUT</code> in the temporary <code>saved-output</code> variable;</li>
<li>Try to create the given output directory;</li>
<li>Check that directory created, in other way print error message;</li>
<li>If the custom output directory was created successfully, execute <code>make</code> again with the new directory (see the <code>-C</code> option).</li>
</ul>
<p>The next <code>ifeq</code> statements check that the <code>C</code> or <code>M</code> options passed to <code>make</code>:</p>
<pre><code class="lang-Makefile">ifeq (&quot;$(origin C)&quot;, &quot;command line&quot;)
  KBUILD_CHECKSRC = $(C)
endif
ifndef KBUILD_CHECKSRC
  KBUILD_CHECKSRC = 0
endif

ifeq (&quot;$(origin M)&quot;, &quot;command line&quot;)
  KBUILD_EXTMOD := $(M)
endif
</code></pre>
<p>The <code>C</code> option tells the <code>makefile</code> that we need to check all <code>c</code> source code with a tool provided by the <code>$CHECK</code> environment variable, by default it is <a href="https://en.wikipedia.org/wiki/Sparse" target="_blank">sparse</a>. The second <code>M</code> option provides build for the external modules (will not see this case in this part). We also check whether the <code>KBUILD_SRC</code> variable is set, and if it isn&apos;t, we set the <code>srctree</code> variable to <code>.</code>:</p>
<pre><code class="lang-Makefile">ifeq ($(KBUILD_SRC),)
        srctree := .
endif

objtree    := .
src        := <span class="hljs-variable">$(srctree)</span>
obj        := <span class="hljs-variable">$(objtree)</span>

export srctree objtree VPATH
</code></pre>
<p>That tells <code>Makefile</code> that the kernel source tree will be in the current directory where <code>make</code> was executed. We then set <code>objtree</code> and other variables to this directory and export them. The next step is to get value for the <code>SUBARCH</code> variable that represents what the underlying architecture is:</p>
<pre><code class="lang-Makefile">SUBARCH := <span class="hljs-variable">$(shell uname -m | sed -e s/i.86/x86/ -e s/x86_64/x86/ \
                  -e s/sun4u/sparc64/ \
                  -e s/arm.*/arm/ -e s/sa110/arm/ \
                  -e s/s390x/s390/ -e s/parisc64/parisc/ \
                  -e s/ppc.*/powerpc/ -e s/mips.*/mips/ \
                  -e s/sh[234].*/sh/ -e s/aarch64.*/arm64/ )</span>
</code></pre>
<p>As you can see, it executes the <a href="https://en.wikipedia.org/wiki/Uname" target="_blank">uname</a> util that prints information about machine, operating system and architecture. As it gets the output of <code>uname</code>, it parses the output and assigns the result to the <code>SUBARCH</code> variable. Now that we have <code>SUBARCH</code>, we set the <code>SRCARCH</code> variable that provides the directory of the certain architecture and <code>hfr-arch</code> that provides the directory for the header files:</p>
<pre><code class="lang-Makefile">ifeq ($(ARCH),i386)
        SRCARCH := x86
endif
ifeq ($(ARCH),x86_64)
        SRCARCH := x86
endif

hdr-arch  := $(SRCARCH)
</code></pre>
<p>Note <code>ARCH</code> is an alias for <code>SUBARCH</code>. In the next step we set the <code>KCONFIG_CONFIG</code> variable that represents path to the kernel configuration file and if it was not set before, it is set to <code>.config</code> by default:</p>
<pre><code class="lang-Makefile">KCONFIG_CONFIG    ?= .config
export KCONFIG_CONFIG
</code></pre>
<p>and the <a href="https://en.wikipedia.org/wiki/Shell_%28computing%29" target="_blank">shell</a> that will be used during kernel compilation:</p>
<pre><code class="lang-Makefile">CONFIG_SHELL := <span class="hljs-variable">$(shell if [ -x &quot;$$BASH&quot; ]; then echo $$BASH; \
      else if [ -x /bin/bash ]; then echo /bin/bash; \
      else echo sh; fi ; fi)</span>
</code></pre>
<p>The next set of variables are related to the compilers used during Linux kernel compilation. We set the host compilers for the <code>c</code> and <code>c++</code> and the flags to be used with them:</p>
<pre><code class="lang-Makefile">HOSTCC       = gcc
HOSTCXX      = g++
HOSTCFLAGS   = -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 -fomit-frame-pointer -std=gnu89
HOSTCXXFLAGS = -O2
</code></pre>
<p>Next we get to the <code>CC</code> variable that represents compiler too, so why do we need the <code>HOST*</code> variables? <code>CC</code> is the target compiler that will be used during kernel compilation, but <code>HOSTCC</code> will be used during compilation of the set of the <code>host</code> programs (we will see it soon). After this we can see the definition of <code>KBUILD_MODULES</code> and <code>KBUILD_BUILTIN</code> variables that are used to determine what to compile (modules, kernel, or both):</p>
<pre><code class="lang-Makefile">KBUILD_MODULES :=
KBUILD_BUILTIN := 1

ifeq ($(MAKECMDGOALS),modules)
  KBUILD_BUILTIN := $(if $(CONFIG_MODVERSIONS),1)
endif
</code></pre>
<p>Here we can see definition of these variables and the value of <code>KBUILD_BUILTIN</code> variable will depend on the <code>CONFIG_MODVERSIONS</code> kernel configuration parameter if we pass only <code>modules</code> to <code>make</code>. The next step is to include the <code>kbuild</code> file.</p>
<pre><code class="lang-Makefile">include scripts/Kbuild.include
</code></pre>
<p>The <a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/kbuild.txt" target="_blank">Kbuild</a> or <code>Kernel Build System</code> is a special infrastructure to manage building the kernel and its modules. <code>kbuild</code> files have the same syntax as makefiles. The <a href="https://github.com/torvalds/linux/blob/master/scripts/Kbuild.include" target="_blank">scripts/Kbuild.include</a> file provides some generic definitions for the <code>kbuild</code> system. After including this <code>kbuild</code> file (back in <a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">makefile</a>) we can see the definitions of the variables that are related to the different tools used during kernel and module compilation (like linker, compilers, utils from the <a href="http://www.gnu.org/software/binutils/" target="_blank">binutils</a>, etc...):</p>
<pre><code class="lang-Makefile">AS        = <span class="hljs-variable">$(CROSS_COMPILE)</span>as
LD        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ld
CC        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc
CPP        = <span class="hljs-variable">$(CC)</span> -E
AR        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ar
NM        = <span class="hljs-variable">$(CROSS_COMPILE)</span>nm
STRIP        = <span class="hljs-variable">$(CROSS_COMPILE)</span>strip
OBJCOPY        = <span class="hljs-variable">$(CROSS_COMPILE)</span>objcopy
OBJDUMP        = <span class="hljs-variable">$(CROSS_COMPILE)</span>objdump
AWK        = awk
...
...
...
</code></pre>
<p>We then define two other variables: <code>USERINCLUDE</code> and <code>LINUXINCLUDE</code>, which specify paths to header file directories (public for users in the first case and for kernel in the second case):</p>
<pre><code class="lang-Makefile">USERINCLUDE    := \
        -I$(srctree)/arch/$(hdr-arch)/include/uapi \
        -Iarch/$(hdr-arch)/include/generated/uapi \
        -I$(srctree)/include/uapi \
        -Iinclude/generated/uapi \
        -include $(srctree)/include/linux/kconfig.h

LINUXINCLUDE    := \
        -I$(srctree)/arch/$(hdr-arch)/include \
        ...
</code></pre>
<p>And the standard flags for the C compiler:</p>
<pre><code class="lang-Makefile">KBUILD_CFLAGS   := -Wall -Wundef -Wstrict-prototypes -Wno-trigraphs \
           -fno-strict-aliasing -fno-common \
           -Werror-implicit-function-declaration \
           -Wno-format-security \
           -std=gnu89
</code></pre>
<p>These are not the final compilation flags, as they can be updated in other makefiles (for example kbuilds from <code>arch/</code>). After all of these, all variables will be exported to be available in the other makefiles. The <code>RCS_FIND_IGNORE</code> and the <code>RCS_TAR_IGNORE</code> variables contain files that will be ignored in the version control system:</p>
<pre><code class="lang-Makefile">export RCS_FIND_IGNORE := \( -name SCCS -o -name BitKeeper -o -name .svn -o    \
              -name CVS -o -name .pc -o -name .hg -o -name .git \) \
              -prune -o
export RCS_TAR_IGNORE := --exclude SCCS --exclude BitKeeper --exclude .svn \
             --exclude CVS --exclude .pc --exclude .hg --exclude .git
</code></pre>
<p>With that, we have finished all preparations. The next step is building the <code>vmlinux</code> target.</p>
<h2 id="directly-to-the-kernel-build">Directly to the kernel build</h2>
<p>We have now finished all the preparations, and next step in the main makefile is related to the kernel build. Before this moment, nothing has been printed to the terminal by <code>make</code>. But now the first steps of the compilation are started. We need to go to line <a href="https://github.com/torvalds/linux/blob/master/Makefile#L598" target="_blank">598</a> of the Linux kernel top makefile and we will find the <code>vmlinux</code> target there:</p>
<pre><code class="lang-Makefile">all: vmlinux
    include arch/$(SRCARCH)/Makefile
</code></pre>
<p>Don&apos;t worry that we have missed many lines in Makefile that are between <code>export RCS_FIND_IGNORE.....</code> and <code>all: vmlinux.....</code>. This part of the makefile is responsible for the <code>make *.config</code> targets and as I wrote in the beginning of this part we will see only building of the kernel in a general way.</p>
<p>The <code>all:</code> target is the default when no target is given on the command line. You can see here that we include architecture specific makefile there (in our case it will be <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Makefile" target="_blank">arch/x86/Makefile</a>). From this moment we will continue from this makefile. As we can see <code>all</code> target depends on the <code>vmlinux</code> target that defined a little lower in the top makefile:</p>
<pre><code class="lang-Makefile">vmlinux: scripts/link-vmlinux.sh $(vmlinux-deps) FORCE
</code></pre>
<p>The <code>vmlinux</code> is the Linux kernel in a statically linked executable file format. The <a href="https://github.com/torvalds/linux/blob/master/scripts/link-vmlinux.sh" target="_blank">scripts/link-vmlinux.sh</a> script links and combines different compiled subsystems into vmlinux. The second target is the <code>vmlinux-deps</code> that defined as:</p>
<pre><code class="lang-Makefile">vmlinux-deps := $(KBUILD_LDS) $(KBUILD_VMLINUX_INIT) $(KBUILD_VMLINUX_MAIN)
</code></pre>
<p>and consists from the set of the <code>built-in.o</code> from each top directory of the Linux kernel. Later, when we will go through all directories in the Linux kernel, the <code>Kbuild</code> will compile all the <code>$(obj-y)</code> files.  It then calls <code>$(LD) -r</code> to merge these files into one <code>built-in.o</code> file. For this moment we have no <code>vmlinux-deps</code>, so the <code>vmlinux</code> target will not be executed now. For me <code>vmlinux-deps</code> contains following files:</p>
<pre><code>arch/x86/kernel/vmlinux.lds arch/x86/kernel/head_64.o
arch/x86/kernel/head64.o    arch/x86/kernel/head.o
init/built-in.o             usr/built-in.o
arch/x86/built-in.o         kernel/built-in.o
mm/built-in.o               fs/built-in.o
ipc/built-in.o              security/built-in.o
crypto/built-in.o           block/built-in.o
lib/lib.a                   arch/x86/lib/lib.a
lib/built-in.o              arch/x86/lib/built-in.o
drivers/built-in.o          sound/built-in.o
firmware/built-in.o         arch/x86/pci/built-in.o
arch/x86/power/built-in.o   arch/x86/video/built-in.o
net/built-in.o
</code></pre><p>The next target that can be executed is following:</p>
<pre><code class="lang-Makefile">$(sort $(vmlinux-deps)): $(vmlinux-dirs) ;
$(vmlinux-dirs): prepare scripts
    $(Q)$(MAKE) $(build)=$@
</code></pre>
<p>As we can see <code>vmlinux-dirs</code> depends on two targets: <code>prepare</code> and <code>scripts</code>. <code>prepare</code> is defined in the top <code>Makefile</code> of the Linux kernel and executes three stages of preparations:</p>
<pre><code class="lang-Makefile">prepare: prepare0
prepare0: archprepare FORCE
    $(Q)$(MAKE) $(build)=.
archprepare: archheaders archscripts prepare1 scripts_basic

prepare1: prepare2 $(version_h) include/generated/utsrelease.h \
                   include/config/auto.conf
    $(cmd_crmodverdir)
prepare2: prepare3 outputmakefile asm-generic
</code></pre>
<p>The first <code>prepare0</code> expands to the <code>archprepare</code> that expands to the <code>archheaders</code> and <code>archscripts</code> that defined in the <code>x86_64</code> specific <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Makefile" target="_blank">Makefile</a>. Let&apos;s look on it. The <code>x86_64</code> specific makefile starts from the definition of the variables that are related to the architecture-specific configs (<a href="https://github.com/torvalds/linux/tree/master/arch/x86/configs" target="_blank">defconfig</a>, etc...). After this it defines flags for the compiling of the <a href="https://en.wikipedia.org/wiki/Real_mode" target="_blank">16-bit</a> code, calculating of the <code>BITS</code> variable that can be <code>32</code> for <code>i386</code> or <code>64</code> for the <code>x86_64</code> flags for the assembly source code, flags for the linker and many many more (all definitions you can find in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Makefile" target="_blank">arch/x86/Makefile</a>). The first target is <code>archheaders</code> in the makefile generates syscall table:</p>
<pre><code class="lang-Makefile"><span class="hljs-section">archheaders:</span>
    $(Q)$(MAKE) $(build)=arch/x86/entry/syscalls all
</code></pre>
<p>And the second target is <code>archscripts</code> in this makefile is:</p>
<pre><code class="lang-Makefile">archscripts: scripts_basic
    $(Q)$(MAKE) $(build)=arch/x86/tools relocs
</code></pre>
<p>We can see that it depends on the <code>scripts_basic</code> target from the top <a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">Makefile</a>. At the first we can see the <code>scripts_basic</code> target that executes make for the <a href="https://github.com/torvalds/linux/blob/master/scripts/basic/Makefile" target="_blank">scripts/basic</a> makefile:</p>
<pre><code class="lang-Makefile"><span class="hljs-section">scripts_basic:</span>
    $(Q)$(MAKE) $(build)=scripts/basic
</code></pre>
<p>The <code>scripts/basic/Makefile</code> contains targets for compilation of the two host programs: <code>fixdep</code> and <code>bin2</code>:</p>
<pre><code class="lang-Makefile">hostprogs-y    := fixdep
hostprogs-$(CONFIG_BUILD_BIN2C)     += bin2c
always        := <span class="hljs-variable">$(hostprogs-y)</span>

$(addprefix $(obj)/,$(filter-out fixdep,$(always))): $(obj)/fixdep
</code></pre>
<p>First program is <code>fixdep</code> - optimizes list of dependencies generated by <a href="https://gcc.gnu.org/" target="_blank">gcc</a> that tells make when to remake a source code file. The second program is <code>bin2c</code>, which depends on the value of the <code>CONFIG_BUILD_BIN2C</code> kernel configuration option and is a very little C program that allows to convert a binary on stdin to a C include on stdout. You can note here a strange notation: <code>hostprogs-y</code>, etc... This notation is used in the all <code>kbuild</code> files and you can read more about it in the <a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/makefiles.txt" target="_blank">documentation</a>. In our case <code>hostprogs-y</code> tells <code>kbuild</code> that there is one host program named <code>fixdep</code> that will be built from <code>fixdep.c</code> that is located in the same directory where the <code>Makefile</code> is. The first output after we execute <code>make</code> in our terminal will be result of this <code>kbuild</code> file:</p>
<pre><code>$ make
  HOSTCC  scripts/basic/fixdep
</code></pre><p>As <code>script_basic</code> target was executed, the <code>archscripts</code> target will execute <code>make</code> for the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/tools/Makefile" target="_blank">arch/x86/tools</a> makefile with the <code>relocs</code> target:</p>
<pre><code class="lang-Makefile">$(Q)$(MAKE) $(build)=arch/x86/tools relocs
</code></pre>
<p>The <code>relocs_32.c</code> and the <code>relocs_64.c</code> will be compiled that will contain <a href="https://en.wikipedia.org/wiki/Relocation_%28computing%29" target="_blank">relocation</a> information and we will see it in the <code>make</code> output:</p>
<pre><code class="lang-Makefile">  HOSTCC  arch/x86/tools/relocs_32.o
  HOSTCC  arch/x86/tools/relocs_64.o
  HOSTCC  arch/x86/tools/relocs_common.o
  HOSTLD  arch/x86/tools/relocs
</code></pre>
<p>There is checking of the <code>version.h</code> after compiling of the <code>relocs.c</code>:</p>
<pre><code class="lang-Makefile">$(version_h): $(srctree)/Makefile FORCE
    $(call filechk,version.h)
    $(Q)rm -f $(old_version_h)
</code></pre>
<p>We can see it in the output:</p>
<pre><code>CHK     include/config/kernel.release
</code></pre><p>and the building of the <code>generic</code> assembly headers with the <code>asm-generic</code> target from the <code>arch/x86/include/generated/asm</code> that generated in the top Makefile of the Linux kernel. After the <code>asm-generic</code> target the <code>archprepare</code> will be done, so the <code>prepare0</code> target will be executed. As I wrote above:</p>
<pre><code class="lang-Makefile">prepare0: archprepare FORCE
    $(Q)$(MAKE) $(build)=.
</code></pre>
<p>Note on the <code>build</code>. It defined in the <a href="https://github.com/torvalds/linux/blob/master/scripts/Kbuild.include" target="_blank">scripts/Kbuild.include</a> and looks like this:</p>
<pre><code class="lang-Makefile">build := -f <span class="hljs-variable">$(srctree)</span>/scripts/Makefile.build obj
</code></pre>
<p>Or in our case it is current source directory - <code>.</code>:</p>
<pre><code class="lang-Makefile">$(Q)$(MAKE) -f $(srctree)/scripts/Makefile.build obj=.
</code></pre>
<p>The <a href="https://github.com/torvalds/linux/blob/master/scripts/Makefile.build" target="_blank">scripts/Makefile.build</a> tries to find the <code>Kbuild</code> file by the given directory via the <code>obj</code> parameter, include this <code>Kbuild</code> files:</p>
<pre><code class="lang-Makefile">include $(kbuild-file)
</code></pre>
<p>and build targets from it. In our case <code>.</code> contains the <a href="https://github.com/torvalds/linux/blob/master/Kbuild" target="_blank">Kbuild</a> file that generates the <code>kernel/bounds.s</code> and the <code>arch/x86/kernel/asm-offsets.s</code>. After this the <code>prepare</code> target finished to work. The <code>vmlinux-dirs</code> also depends on the second target - <code>scripts</code> that compiles following programs: <code>file2alias</code>, <code>mk_elfconfig</code>, <code>modpost</code>, etc..... After scripts/host-programs compilation our <code>vmlinux-dirs</code> target can be executed. First of all let&apos;s try to understand what does <code>vmlinux-dirs</code> contain. For my case it contains paths of the following kernel directories:</p>
<pre><code>init usr arch/x86 kernel mm fs ipc security crypto block
drivers sound firmware arch/x86/pci arch/x86/power
arch/x86/video net lib arch/x86/lib
</code></pre><p>We can find definition of the <code>vmlinux-dirs</code> in the top <a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">Makefile</a> of the Linux kernel:</p>
<pre><code class="lang-Makefile">vmlinux-dirs    := $(patsubst %/,%,$(filter %/, $(init-y) $(init-m) \
             $(core-y) $(core-m) $(drivers-y) $(drivers-m) \
             $(net-y) $(net-m) $(libs-y) $(libs-m)))

init-y        := init/
drivers-y    := drivers/ sound/ firmware/
net-y        := net/
libs-y        := lib/
...
...
...
</code></pre>
<p>Here we remove the <code>/</code> symbol from the each directory with the help of the <code>patsubst</code> and <code>filter</code> functions and put it to the <code>vmlinux-dirs</code>. So we have list of directories in the <code>vmlinux-dirs</code> and the following code:</p>
<pre><code class="lang-Makefile">$(vmlinux-dirs): prepare scripts
    $(Q)$(MAKE) $(build)=$@
</code></pre>
<p>The <code>$@</code> represents <code>vmlinux-dirs</code> here that means that it will go recursively over all directories from the <code>vmlinux-dirs</code> and its internal directories (depens on configuration) and will execute <code>make</code> in there. We can see it in the output:</p>
<pre><code>  CC      init/main.o
  CHK     include/generated/compile.h
  CC      init/version.o
  CC      init/do_mounts.o
  ...
  CC      arch/x86/crypto/glue_helper.o
  AS      arch/x86/crypto/aes-x86_64-asm_64.o
  CC      arch/x86/crypto/aes_glue.o
  ...
  AS      arch/x86/entry/entry_64.o
  AS      arch/x86/entry/thunk_64.o
  CC      arch/x86/entry/syscall_64.o
</code></pre><p>Source code in each directory will be compiled and linked to the <code>built-in.o</code>:</p>
<pre><code>$ find . -name built-in.o
./arch/x86/crypto/built-in.o
./arch/x86/crypto/sha-mb/built-in.o
./arch/x86/net/built-in.o
./init/built-in.o
./usr/built-in.o
...
...
</code></pre><p>Ok, all buint-in.o(s) built, now we can back to the <code>vmlinux</code> target. As you remember, the <code>vmlinux</code> target is in the top Makefile of the Linux kernel. Before the linking of the <code>vmlinux</code> it builds <a href="https://github.com/torvalds/linux/tree/master/samples" target="_blank">samples</a>, <a href="https://github.com/torvalds/linux/tree/master/Documentation" target="_blank">Documentation</a>, etc... but I will not describe it here as I wrote in the beginning of this part.</p>
<pre><code class="lang-Makefile">vmlinux: scripts/link-vmlinux.sh $(vmlinux-deps) FORCE
    ...
    ...
    +$(call if_changed,link-vmlinux)
</code></pre>
<p>As you can see main purpose of it is a call of the <a href="https://github.com/torvalds/linux/blob/master/scripts/link-vmlinux.sh" target="_blank">scripts/link-vmlinux.sh</a> script is linking of the all <code>built-in.o</code>(s) to the one statically linked executable and creation of the <a href="https://en.wikipedia.org/wiki/System.map" target="_blank">System.map</a>. In the end we will see following output:</p>
<pre><code>  LINK    vmlinux
  LD      vmlinux.o
  MODPOST vmlinux.o
  GEN     .version
  CHK     include/generated/compile.h
  UPD     include/generated/compile.h
  CC      init/version.o
  LD      init/built-in.o
  KSYM    .tmp_kallsyms1.o
  KSYM    .tmp_kallsyms2.o
  LD      vmlinux
  SORTEX  vmlinux
  SYSMAP  System.map
</code></pre><p>and <code>vmlinux</code> and <code>System.map</code> in the root of the Linux kernel source tree:</p>
<pre><code>$ ls vmlinux System.map
System.map  vmlinux
</code></pre><p>That&apos;s all, <code>vmlinux</code> is ready. The next step is creation of the <a href="https://en.wikipedia.org/wiki/Vmlinux#bzImage" target="_blank">bzImage</a>.</p>
<h2 id="building-bzimage">Building bzImage</h2>
<p>The <code>bzImage</code> file is the compressed Linux kernel image. We can get it by executing <code>make bzImage</code> after <code>vmlinux</code> is built. That, or we can just execute <code>make</code> without any argument and we will get <code>bzImage</code> anyway because it is default image:</p>
<pre><code class="lang-Makefile">all: bzImage
</code></pre>
<p>in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Makefile" target="_blank">arch/x86/kernel/Makefile</a>. Let&apos;s look on this target, it will help us to understand how this image builds. As I already said the <code>bzImage</code> target defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Makefile" target="_blank">arch/x86/kernel/Makefile</a> and looks like this:</p>
<pre><code class="lang-Makefile">bzImage: vmlinux
    $(Q)$(MAKE) $(build)=$(boot) $(KBUILD_IMAGE)
    $(Q)mkdir -p $(objtree)/arch/$(UTS_MACHINE)/boot
    $(Q)ln -fsn ../../x86/boot/bzImage $(objtree)/arch/$(UTS_MACHINE)/boot/$@
</code></pre>
<p>We can see here, that first of all called <code>make</code> for the boot directory, in our case it is:</p>
<pre><code class="lang-Makefile">boot := arch/x86/boot
</code></pre>
<p>The main goal now is to build the source code in the <code>arch/x86/boot</code> and <code>arch/x86/boot/compressed</code> directories, build <code>setup.bin</code> and <code>vmlinux.bin</code>, and build the <code>bzImage</code> from them in the end. First target in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/Makefile" target="_blank">arch/x86/boot/Makefile</a> is the <code>$(obj)/setup.elf</code>:</p>
<pre><code class="lang-Makefile">$(obj)/setup.elf: $(src)/setup.ld $(SETUP_OBJS) FORCE
    $(call if_changed,ld)
</code></pre>
<p>We already have the <code>setup.ld</code> linker script in the <code>arch/x86/boot</code> directory and the <code>SETUP_OBJS</code> variable that expands to the all source files from the <code>boot</code> directory. We can see first output:</p>
<pre><code class="lang-Makefile">  AS      arch/x86/boot/bioscall.o
  CC      arch/x86/boot/cmdline.o
  AS      arch/x86/boot/copy.o
  HOSTCC  arch/x86/boot/mkcpustr
  CPUSTR  arch/x86/boot/cpustr.h
  CC      arch/x86/boot/cpu.o
  CC      arch/x86/boot/cpuflags.o
  CC      arch/x86/boot/cpucheck.o
  CC      arch/x86/boot/early_serial_console.o
  CC      arch/x86/boot/edd.o
</code></pre>
<p>The next source file is <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/header.S" target="_blank">arch/x86/boot/header.S</a>, but we can&apos;t build it now because this target depends on the following two header files:</p>
<pre><code class="lang-Makefile">$(obj)/header.o: $(obj)/voffset.h $(obj)/zoffset.h
</code></pre>
<p>The first is <code>voffset.h</code> generated by the <code>sed</code> script that gets two addresses from the <code>vmlinux</code> with the <code>nm</code> util:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VO__end 0xffffffff82ab0000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VO__text 0xffffffff81000000</span>
</code></pre>
<p>They are the start and the end of the kernel. The second is <code>zoffset.h</code> depens on the <code>vmlinux</code> target from the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/compressed/Makefile" target="_blank">arch/x86/boot/compressed/Makefile</a>:</p>
<pre><code class="lang-Makefile">$(obj)/zoffset.h: $(obj)/compressed/vmlinux FORCE
    $(call if_changed,zoffset)
</code></pre>
<p>The <code>$(obj)/compressed/vmlinux</code> target depends on the <code>vmlinux-objs-y</code> that compiles source code files from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/boot/compressed" target="_blank">arch/x86/boot/compressed</a> directory and generates <code>vmlinux.bin</code>, <code>vmlinux.bin.bz2</code>, and compiles program - <code>mkpiggy</code>. We can see this in the output:</p>
<pre><code class="lang-Makefile">  LDS     arch/x86/boot/compressed/vmlinux.lds
  AS      arch/x86/boot/compressed/head_64.o
  CC      arch/x86/boot/compressed/misc.o
  CC      arch/x86/boot/compressed/string.o
  CC      arch/x86/boot/compressed/cmdline.o
  OBJCOPY arch/x86/boot/compressed/vmlinux.bin
  BZIP2   arch/x86/boot/compressed/vmlinux.bin.bz2
  HOSTCC  arch/x86/boot/compressed/mkpiggy
</code></pre>
<p>Where <code>vmlinux.bin</code> is the <code>vmlinux</code> file with debugging information and comments stripped and the <code>vmlinux.bin.bz2</code> compressed <code>vmlinux.bin.all</code> + <code>u32</code> size of <code>vmlinux.bin.all</code>. The <code>vmlinux.bin.all</code> is <code>vmlinux.bin + vmlinux.relocs</code>, where <code>vmlinux.relocs</code> is the <code>vmlinux</code> that was handled by the <code>relocs</code> program (see above). As we got these files, the <code>piggy.S</code> assembly files will be generated with the <code>mkpiggy</code> program and compiled:</p>
<pre><code class="lang-Makefile">  MKPIGGY arch/x86/boot/compressed/piggy.S
  AS      arch/x86/boot/compressed/piggy.o
</code></pre>
<p>This assembly files will contain the computed offset from the compressed kernel. After this we can see that <code>zoffset</code> generated:</p>
<pre><code class="lang-Makefile">  ZOFFSET arch/x86/boot/zoffset.h
</code></pre>
<p>As the <code>zoffset.h</code> and the <code>voffset.h</code> are generated, compilation of the source code files from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/boot/" target="_blank">arch/x86/boot</a> can be continued:</p>
<pre><code class="lang-Makefile">  AS      arch/x86/boot/header.o
  CC      arch/x86/boot/main.o
  CC      arch/x86/boot/mca.o
  CC      arch/x86/boot/memory.o
  CC      arch/x86/boot/pm.o
  AS      arch/x86/boot/pmjump.o
  CC      arch/x86/boot/printf.o
  CC      arch/x86/boot/regs.o
  CC      arch/x86/boot/string.o
  CC      arch/x86/boot/tty.o
  CC      arch/x86/boot/video.o
  CC      arch/x86/boot/video-mode.o
  CC      arch/x86/boot/video-vga.o
  CC      arch/x86/boot/video-vesa.o
  CC      arch/x86/boot/video-bios.o
</code></pre>
<p>As all source code files will be compiled, they will be linked to the <code>setup.elf</code>:</p>
<pre><code class="lang-Makefile">  LD      arch/x86/boot/setup.elf
</code></pre>
<p>or:</p>
<pre><code>ld -m elf_x86_64   -T arch/x86/boot/setup.ld arch/x86/boot/a20.o arch/x86/boot/bioscall.o arch/x86/boot/cmdline.o arch/x86/boot/copy.o arch/x86/boot/cpu.o arch/x86/boot/cpuflags.o arch/x86/boot/cpucheck.o arch/x86/boot/early_serial_console.o arch/x86/boot/edd.o arch/x86/boot/header.o arch/x86/boot/main.o arch/x86/boot/mca.o arch/x86/boot/memory.o arch/x86/boot/pm.o arch/x86/boot/pmjump.o arch/x86/boot/printf.o arch/x86/boot/regs.o arch/x86/boot/string.o arch/x86/boot/tty.o arch/x86/boot/video.o arch/x86/boot/video-mode.o arch/x86/boot/version.o arch/x86/boot/video-vga.o arch/x86/boot/video-vesa.o arch/x86/boot/video-bios.o -o arch/x86/boot/setup.elf
</code></pre><p>The last two things is the creation of the <code>setup.bin</code> that will contain compiled code from the <code>arch/x86/boot/*</code> directory:</p>
<pre><code>objcopy  -O binary arch/x86/boot/setup.elf arch/x86/boot/setup.bin
</code></pre><p>and the creation of the <code>vmlinux.bin</code> from the <code>vmlinux</code>:</p>
<pre><code>objcopy  -O binary -R .note -R .comment -S arch/x86/boot/compressed/vmlinux arch/x86/boot/vmlinux.bin
</code></pre><p>In the end we compile host program: <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/tools/build.c" target="_blank">arch/x86/boot/tools/build.c</a> that will create our <code>bzImage</code> from the <code>setup.bin</code> and the <code>vmlinux.bin</code>:</p>
<pre><code>arch/x86/boot/tools/build arch/x86/boot/setup.bin arch/x86/boot/vmlinux.bin arch/x86/boot/zoffset.h arch/x86/boot/bzImage
</code></pre><p>Actually the <code>bzImage</code> is the concatenated <code>setup.bin</code> and the <code>vmlinux.bin</code>. In the end we will see the output which is familiar to all who once built the Linux kernel from source:</p>
<pre><code>Setup is 16268 bytes (padded to 16384 bytes).
System is 4704 kB
CRC 94a88f9a
Kernel: arch/x86/boot/bzImage is ready  (#5)
</code></pre><p>That&apos;s all.</p>
<h1 id="conclusion">Conclusion</h1>
<p>It is the end of this part and here we saw all steps from the execution of the <code>make</code> command to the generation of the <code>bzImage</code>. I know, the Linux kernel makefiles and process of the Linux kernel building may seem confusing at first glance, but it is not so hard. Hope this part will help you understand the process of building the Linux kernel.</p>
<h1 id="links">Links</h1>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Make_%28software%29" target="_blank">GNU make util</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/Makefile" target="_blank">Linux kernel top Makefile</a></li>
<li><a href="https://en.wikipedia.org/wiki/Cross_compiler" target="_blank">cross-compilation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Ctags" target="_blank">Ctags</a></li>
<li><a href="https://en.wikipedia.org/wiki/Sparse" target="_blank">sparse</a></li>
<li><a href="https://en.wikipedia.org/wiki/Vmlinux#bzImage" target="_blank">bzImage</a></li>
<li><a href="https://en.wikipedia.org/wiki/Uname" target="_blank">uname</a></li>
<li><a href="https://en.wikipedia.org/wiki/Shell_%28computing%29" target="_blank">shell</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/kbuild.txt" target="_blank">Kbuild</a></li>
<li><a href="http://www.gnu.org/software/binutils/" target="_blank">binutils</a></li>
<li><a href="https://gcc.gnu.org/" target="_blank">gcc</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/makefiles.txt" target="_blank">Documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/System.map" target="_blank">System.map</a></li>
<li><a href="https://en.wikipedia.org/wiki/Relocation_%28computing%29" target="_blank">Relocation</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Misc">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="linkers.html" class="navigation navigation-next " aria-label="Next page: Linkers">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"How the kernel is compiled","level":"1.15.1","depth":2,"next":{"title":"Linkers","level":"1.15.2","depth":2,"path":"Misc/linkers.md","ref":"Misc/linkers.md","articles":[]},"previous":{"title":"Misc","level":"1.15","depth":1,"path":"Misc/README.md","ref":"Misc/README.md","articles":[{"title":"How the kernel is compiled","level":"1.15.1","depth":2,"path":"Misc/how_kernel_compiled.md","ref":"Misc/how_kernel_compiled.md","articles":[]},{"title":"Linkers","level":"1.15.2","depth":2,"path":"Misc/linkers.md","ref":"Misc/linkers.md","articles":[]},{"title":"Linux kernel development","level":"1.15.3","depth":2,"path":"Misc/contribute.md","ref":"Misc/contribute.md","articles":[]},{"title":"Program startup process in userspace","level":"1.15.4","depth":2,"path":"Misc/program_startup.md","ref":"Misc/program_startup.md","articles":[]},{"title":"Write and Submit your first Linux kernel Patch","level":"1.15.5","depth":2,"ref":"","articles":[]},{"title":"Data types in the kernel","level":"1.15.6","depth":2,"ref":"","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Misc/how_kernel_compiled.md","mtime":"2019-03-28T07:54:50.399Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T08:16:32.758Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

