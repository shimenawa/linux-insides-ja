
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Implementation of the open system call Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Timers/" />
    
    
    <link rel="prev" href="syscall-4.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Initialization/">
            
                <a href="../Initialization/">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Initialization/linux-initialization-1.html">
            
                <a href="../Initialization/linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Initialization/linux-initialization-2.html">
            
                <a href="../Initialization/linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Initialization/linux-initialization-3.html">
            
                <a href="../Initialization/linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Initialization/linux-initialization-4.html">
            
                <a href="../Initialization/linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Initialization/linux-initialization-5.html">
            
                <a href="../Initialization/linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Initialization/linux-initialization-6.html">
            
                <a href="../Initialization/linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Initialization/linux-initialization-7.html">
            
                <a href="../Initialization/linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Initialization/linux-initialization-8.html">
            
                <a href="../Initialization/linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../Initialization/linux-initialization-9.html">
            
                <a href="../Initialization/linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../Initialization/linux-initialization-10.html">
            
                <a href="../Initialization/linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="syscall-1.html">
            
                <a href="syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="syscall-2.html">
            
                <a href="syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="syscall-3.html">
            
                <a href="syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="syscall-4.html">
            
                <a href="syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.5" data-path="syscall-5.html">
            
                <a href="syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Timers/">
            
                <a href="../Timers/">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Timers/timers-1.html">
            
                <a href="../Timers/timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Timers/timers-2.html">
            
                <a href="../Timers/timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Timers/timers-3.html">
            
                <a href="../Timers/timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Timers/timers-4.html">
            
                <a href="../Timers/timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Timers/timers-5.html">
            
                <a href="../Timers/timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Timers/timers-6.html">
            
                <a href="../Timers/timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Timers/timers-7.html">
            
                <a href="../Timers/timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Misc/">
            
                <a href="../Misc/">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Misc/how_kernel_compiled.html">
            
                <a href="../Misc/how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Misc/linkers.html">
            
                <a href="../Misc/linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="../Misc/contribute.html">
            
                <a href="../Misc/contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="../Misc/program_startup.html">
            
                <a href="../Misc/program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Implementation of the open system call</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="how-does-the-open-system-call-work">How does the <code>open</code> system call work</h2>
<h2 id="introduction">Introduction</h2>
<p>This is the fifth part of the chapter that describes <a href="https://en.wikipedia.org/wiki/System_call" target="_blank">system calls</a> mechanism in the Linux kernel. Previous parts of this chapter described this mechanism in general. Now I will try to describe implementation of different system calls in the Linux kernel. Previous parts from this chapter and parts from other chapters of the books describe mostly deep parts of the Linux kernel that are faintly visible or fully invisible from the userspace. But the Linux kernel code is not only about itself. The vast of the Linux kernel code provides ability to our code. Due to the linux kernel our programs can read/write from/to files and don&apos;t know anything about sectors, tracks and other parts of a disk structures, we can send data over network and don&apos;t build encapsulated network packets by hand and etc.</p>
<p>I don&apos;t know how about you, but it is interesting to me not only how an operating system works, but how do my software interacts with it. As you may know, our programs interacts with the kernel through the special mechanism which is called <a href="https://en.wikipedia.org/wiki/System_call" target="_blank">system call</a>. So, I&apos;ve decided to write series of parts which will describe implementation and behavior of system calls which we are using every day like <code>read</code>, <code>write</code>, <code>open</code>, <code>close</code>, <code>dup</code> and etc.</p>
<p>I have decided to start from the description of the <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank">open</a> system call. if you have written at least one <code>C</code> program, you should know that before we are able to read/write or execute other manipulations with a file we need to open it with the <code>open</code> function:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv)</span> </span>{
        <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;test&quot;</span>, O_RDONLY);

        <span class="hljs-keyword">if</span> fd &lt; <span class="hljs-number">0</span> {
                perror(<span class="hljs-string">&quot;Opening of the file is failed\n&quot;</span>);
        }
        <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;file sucessfully opened\n&quot;</span>);
        }

        close(fd); 
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>In this case, the open is the function from standard library, but not system call. The standard library will call related system call for us. The <code>open</code> call will return a <a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank">file descriptor</a> which is just an unique number within our process which is associated with the opened file. Now as we opened a file and got file descriptor as result of <code>open</code> call, we may start to interact with this file. We can write into, read from it and etc. List of opened file by a process is available via <a href="https://en.wikipedia.org/wiki/Procfs" target="_blank">proc</a> filesystem: </p>
<pre><code>$ sudo ls /proc/1/fd/

0  10  12  14  16  2   21  23  25  27  29  30  32  34  36  38  4   41  43  45  47  49  50  53  55  58  6   61  63  67  8
1  11  13  15  19  20  22  24  26  28  3   31  33  35  37  39  40  42  44  46  48  5   51  54  57  59  60  62  65  7   9
</code></pre><p>I am not going to describe more details about the <code>open</code> routine from the userspace view in this post, but mostly from the kernel side. if you are not very familiar with, you can get more info in the <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank">man page</a>.</p>
<p>So let&apos;s start.</p>
<h2 id="definition-of-the-open-system-call">Definition of the open system call</h2>
<p>If you have read the <a href="https://github.com/0xAX/linux-insides/blob/master/SysCall/syscall-4.md" target="_blank">fourth part</a> of the <a href="https://0xax.gitbooks.io/linux-insides/content/index.html" target="_blank">linux-insides</a> book, you should know that system calls are defined with the help of <code>SYSCALL_DEFINE</code> macro. So, the <code>open</code> system call is not exception.</p>
<p>Definition of the <code>open</code> system call is located in the <a href="https://github.com/torvalds/linux/blob/master/fs/open.c" target="_blank">fs/open.c</a> source code file and looks pretty small for the first view:</p>
<pre><code class="lang-C">SYSCALL_DEFINE3(open, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *, filename, <span class="hljs-keyword">int</span>, flags, <span class="hljs-keyword">umode_t</span>, mode)
{
    <span class="hljs-keyword">if</span> (force_o_largefile())
        flags |= O_LARGEFILE;

    <span class="hljs-keyword">return</span> do_sys_open(AT_FDCWD, filename, flags, mode);
}
</code></pre>
<p>As you may guess, the <code>do_sys_open</code> function from the <a href="https://github.com/torvalds/linux/blob/master/fs/open.c" target="_blank">same</a> source code file does the main job. But before this function will be called, let&apos;s consider the <code>if</code> clause from which the implementation of the <code>open</code> system call starts:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (force_o_largefile())
    flags |= O_LARGEFILE;
</code></pre>
<p>Here we apply the <code>O_LARGEFILE</code> flag to the flags which were passed to <code>open</code> system call in a case when the <code>force_o_largefile()</code> will return true.
What is <code>O_LARGEFILE</code>? We may read this in the <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank">man page</a> for the <code>open(2)</code> system call:</p>
<blockquote>
<p>O_LARGEFILE</p>
<p>(LFS) Allow files whose sizes cannot be represented in an off_t (but can be represented in an off64_t) to be opened.</p>
</blockquote>
<p>As we may read in the <a href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#File-Position-Primitive" target="_blank">GNU C Library Reference Manual</a>:</p>
<blockquote>
<p>off_t</p>
<p>   This is a signed integer type used to represent file sizes. 
   In the GNU C Library, this type is no narrower than int.
   If the source is compiled with _FILE_OFFSET_BITS == 64 this 
   type is transparently replaced by off64_t.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>off64_t</p>
<p>   This type is used similar to off_t. The difference is that 
   even on 32 bit machines, where the off_t type would have 32 bits,
   off64_t has 64 bits and so is able to address files up to 2^63 bytes
   in length. When compiling with _FILE_OFFSET_BITS == 64 this type 
   is available under the name off_t.</p>
</blockquote>
<p>So it is not hard to guess that the <code>off_t</code>, <code>off64_t</code> and <code>O_LARGEFILE</code> are about a file size. In the case of the Linux kernel, the <code>O_LARGEFILE</code> is used  to disallow opening large files on 32bit systems if the caller didn&apos;t specify <code>O_LARGEFILE</code> flag during opening of a file. On 64bit systems we force on this flag in open system call. And the <code>force_o_largefile</code> macro from the <a href="https://github.com/torvalds/linux/blob/master/include/linux/fcntl.h#L7" target="_blank">include/linux/fcntl.h</a> linux kernel header file confirms this:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> force_o_largefile</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> force_o_largefile() (BITS_PER_LONG != 32)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>This macro may be architecture-specific as for example for <a href="https://en.wikipedia.org/wiki/IA-64" target="_blank">IA-64</a> architecture, but in our case the <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a> does not provide definition of the <code>force_o_largefile</code> and it will be used from <a href="https://github.com/torvalds/linux/blob/master/include/linux/fcntl.h#L7" target="_blank">include/linux/fcntl.h</a>.</p>
<p>So, as we may see the <code>force_o_largefile</code> is just a macro which expands to the <code>true</code> value in our case of <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a> architecture. As we are considering 64-bit architecture, the <code>force_o_largefile</code> will be expanded to <code>true</code> and the <code>O_LARGEFILE</code> flag will be added to the set of flags which were passed to the <code>open</code> system call.</p>
<p>Now as we considered meaning of the <code>O_LARGEFILE</code> flag and <code>force_o_largefile</code> macro, we can proceed to the consideration of the implementation of the <code>do_sys_open</code> function. As I wrote above, this function is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/open.c" target="_blank">same</a> source code file and looks: </p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">do_sys_open</span><span class="hljs-params">(<span class="hljs-keyword">int</span> dfd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *filename, <span class="hljs-keyword">int</span> flags, umode_t mode)</span>
</span>{
    <span class="hljs-keyword">struct</span> open_flags op;
    <span class="hljs-keyword">int</span> fd = build_open_flags(flags, mode, &amp;op);
    <span class="hljs-keyword">struct</span> filename *tmp;

    <span class="hljs-keyword">if</span> (fd)
        <span class="hljs-keyword">return</span> fd;

    tmp = getname(filename);
    <span class="hljs-keyword">if</span> (IS_ERR(tmp))
        <span class="hljs-keyword">return</span> PTR_ERR(tmp);

    fd = get_unused_fd_flags(flags);
    <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">struct</span> file *f = do_filp_open(dfd, tmp, &amp;op);
        <span class="hljs-keyword">if</span> (IS_ERR(f)) {
            put_unused_fd(fd);
            fd = PTR_ERR(f);
        } <span class="hljs-keyword">else</span> {
            fsnotify_open(f);
            fd_install(fd, f);
        }
    }
    putname(tmp);
    <span class="hljs-keyword">return</span> fd;
}
</code></pre>
<p>Let&apos;s try to understand how the <code>do_sys_open</code> works step by step.</p>
<h2 id="open2-flags">open(2) flags</h2>
<p>As you know the <code>open</code> system call takes set of <code>flags</code> as second argument that control opening a file and <code>mode</code> as third argument that specifies permission the permissions of a file if it is created. The <code>do_sys_open</code> function starts from the call of the <code>build_open_flags</code> function which does some checks that set of the given flags is valid and handles different conditions of flags and mode.</p>
<p>Let&apos;s look at the implementation of the <code>build_open_flags</code>. This function is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/open.c" target="_blank">same</a> kernel file and takes three arguments:</p>
<ul>
<li>flags - flags that control opening of a file;</li>
<li>mode - permissions for newly created file;</li>
</ul>
<p>The last argument - <code>op</code> is represented with the <code>open_flags</code> structure:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> open_flags {
        <span class="hljs-keyword">int</span> open_flag;
        <span class="hljs-keyword">umode_t</span> mode;
        <span class="hljs-keyword">int</span> acc_mode;
        <span class="hljs-keyword">int</span> intent;
        <span class="hljs-keyword">int</span> lookup_flags;
};
</code></pre>
<p>which is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/internal.h#L99" target="_blank">fs/internal.h</a> header file and as we may see it holds information about flags and access mode for internal kernel purposes. As you already may guess the main goal of the <code>build_open_flags</code> function is to fill an instance of this structure.</p>
<p>Implementation of the <code>build_open_flags</code> function starts from the definition of local variables and one of them is:</p>
<pre><code class="lang-C"><span class="hljs-keyword">int</span> acc_mode = ACC_MODE(flags);
</code></pre>
<p>This local variable represents access mode and its initial value will be equal to the value of expanded <code>ACC_MODE</code> macro. This macro is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/fs.h" target="_blank">include/linux/fs.h</a> and looks pretty interesting:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ACC_MODE(x) (<span class="hljs-string">&quot;\004\002\006\006&quot;</span>[(x)&amp;O_ACCMODE])</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_ACCMODE   00000003</span>
</code></pre>
<p>The <code>&quot;\004\002\006\006&quot;</code> is an array of four chars:</p>
<pre><code>&quot;\004\002\006\006&quot; == {&apos;\004&apos;, &apos;\002&apos;, &apos;\006&apos;, &apos;\006&apos;}
</code></pre><p>So, the <code>ACC_MODE</code> macro just expands to the accession to this array by <code>[(x) &amp; O_ACCMODE]</code> index. As we just saw, the <code>O_ACCMODE</code> is <code>00000003</code>. By applying <code>x &amp; O_ACCMODE</code> we will take the two least significant bits which are represents <code>read</code>, <code>write</code> or <code>read/write</code> access modes:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_RDONLY        00000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_WRONLY        00000001</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_RDWR          00000002</span>
</code></pre>
<p>After getting value from the array by the calculated index, the <code>ACC_MODE</code> will be expanded to access mode mask of a file which will hold <code>MAY_WRITE</code>, <code>MAY_READ</code> and other information.</p>
<p>We may see following condition after we have calculated initial access mode:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (flags &amp; (O_CREAT | __O_TMPFILE))
    op-&gt;mode = (mode &amp; S_IALLUGO) | S_IFREG;
<span class="hljs-keyword">else</span>
    op-&gt;mode = <span class="hljs-number">0</span>;
</code></pre>
<p>Here we reset permissions in <code>open_flags</code> instance if a opened file wasn&apos;t temporary and wasn&apos;t open for creation. This is because:</p>
<blockquote>
<p>if  neither O_CREAT nor O_TMPFILE is specified, then mode is ignored.</p>
</blockquote>
<p>In other case if <code>O_CREAT</code> or <code>O_TMPFILE</code> were passed we canonicalize it to a regular file because a directory should be created with the <a href="http://man7.org/linux/man-pages/man3/opendir.3.html" target="_blank">opendir</a> system call.</p>
<p>At the next step we check that a file is not tried to be opened via <a href="http://man7.org/linux/man-pages/man7/fanotify.7.html" target="_blank">fanotify</a> and without the <code>O_CLOEXEC</code> flag:</p>
<pre><code class="lang-C">flags &amp;= ~FMODE_NONOTIFY &amp; ~O_CLOEXEC;
</code></pre>
<p>We do this to not leak a <a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank">file descriptor</a>. By default, the new file descriptor is set to remain open across an <code>execve</code> system call, but the <code>open</code> system call supports <code>O_CLOEXEC</code> flag that can be used to change this default behaviour. So we do this to prevent leaking of a file descriptor when one thread opens a file to set <code>O_CLOEXEC</code> flag and in the same time the second process does a <a href="https://en.wikipedia.org/wiki/Fork_(system_call" target="_blank">fork</a>) + <a href="https://en.wikipedia.org/wiki/Exec_(system_call" target="_blank">execve</a>) and as you may remember that child will have copies of the parent&apos;s set of open file descriptors.</p>
<p>At the next step we check that if our flags contains <code>O_SYNC</code> flag, we apply <code>O_DSYNC</code> flag too:</p>
<pre><code>if (flags &amp; __O_SYNC)
    flags |= O_DSYNC;
</code></pre><p>The <code>O_SYNC</code> flag guarantees that the any write call will not return before all data has been transferred to the disk. The <code>O_DSYNC</code> is like <code>O_SYNC</code> except that there is no requirement to wait for any metadata (like <code>atime</code>, <code>mtime</code> and etc.) changes will be written. We apply <code>O_DSYNC</code> in a case of <code>__O_SYNC</code> because it is implemented as <code>__O_SYNC|O_DSYNC</code> in the Linux kernel.</p>
<p>After this we must be sure that if a user wants to create temporary file, the flags should contain <code>O_TMPFILE_MASK</code> or in other words it should contain or <code>O_CREAT</code> or <code>O_TMPFILE</code> or both and also it should be writeable:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (flags &amp; __O_TMPFILE) {
    <span class="hljs-keyword">if</span> ((flags &amp; O_TMPFILE_MASK) != O_TMPFILE)
        <span class="hljs-keyword">return</span> -EINVAL;
    <span class="hljs-keyword">if</span> (!(acc_mode &amp; MAY_WRITE))
        <span class="hljs-keyword">return</span> -EINVAL;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; O_PATH) {
           flags &amp;= O_DIRECTORY | O_NOFOLLOW | O_PATH;
        acc_mode = <span class="hljs-number">0</span>;
}
</code></pre>
<p>as it is written in in the manual page:</p>
<blockquote>
<p>O_TMPFILE  must  be  specified  with one of O_RDWR or O_WRONLY</p>
</blockquote>
<p>If we didn&apos;t pass <code>O_TMPFILE</code> for creation of a temporary file, we check the <code>O_PATH</code> flag at the next condition. The <code>O_PATH</code> flag allows us to obtain a file descriptor that may be used for two following purposes:</p>
<ul>
<li>to indicate a location in the filesystem tree;</li>
<li>to perform operations that act purely at the file descriptor level.</li>
</ul>
<p>So, in this case the file itself is not opened, but operations like <code>dup</code>, <code>fcntl</code> and other can be used. So, if all file content related operations like <code>read</code>, <code>write</code> and other are permitted, only <code>O_DIRECTORY | O_NOFOLLOW | O_PATH</code> flags can be used. We have finished with flags for this moment in the <code>build_open_flags</code> for this moment and we may fill our <code>open_flags-&gt;open_flag</code> with them:</p>
<pre><code class="lang-C">op-&gt;open_flag = flags;
</code></pre>
<p>Now we have filled <code>open_flag</code> field which represents flags that will control opening of a file and <code>mode</code> that will represent <code>umask</code> of a new file if we open file for creation. There are still to fill last flags in the our <code>open_flags</code> structure. The next is <code>op-&gt;acc_mode</code> which represents access mode to a opened file. We already filled the <code>acc_mode</code> local variable with the initial value at the beginning of the <code>build_open_flags</code> and now we check last two flags related to access mode:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (flags &amp; O_TRUNC)
        acc_mode |= MAY_WRITE;
<span class="hljs-keyword">if</span> (flags &amp; O_APPEND)
    acc_mode |= MAY_APPEND;
op-&gt;acc_mode = acc_mode;
</code></pre>
<p>These flags are - <code>O_TRUNC</code> that will truncate an opened file to length <code>0</code> if it existed before we open it and the <code>O_APPEND</code> flag allows to open a file in <code>append mode</code>. So the opened file will be appended during write but not overwritten.</p>
<p>The next field of the <code>open_flags</code> structure is - <code>intent</code>. It allows us to know about our intention or in other words what do we really want to do with file, open it, create, rename it or something else. So we set it to zero if our flags contains the <code>O_PATH</code> flag as we can&apos;t do anything related to a file content with this flag:</p>
<pre><code class="lang-C">op-&gt;intent = flags &amp; O_PATH ? <span class="hljs-number">0</span> : LOOKUP_OPEN;
</code></pre>
<p>or just to <code>LOOKUP_OPEN</code> intention. Additionally we set <code>LOOKUP_CREATE</code> intention if we want to create new file and to be sure that a file didn&apos;t exist before with <code>O_EXCL</code> flag:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (flags &amp; O_CREAT) {
    op-&gt;intent |= LOOKUP_CREATE;
    <span class="hljs-keyword">if</span> (flags &amp; O_EXCL)
        op-&gt;intent |= LOOKUP_EXCL;
}
</code></pre>
<p>The last flag of the <code>open_flags</code> structure is the <code>lookup_flags</code>:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (flags &amp; O_DIRECTORY)
    lookup_flags |= LOOKUP_DIRECTORY;
<span class="hljs-keyword">if</span> (!(flags &amp; O_NOFOLLOW))
    lookup_flags |= LOOKUP_FOLLOW;
op-&gt;lookup_flags = lookup_flags;

<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>We fill it with <code>LOOKUP_DIRECTORY</code> if we want to open a directory and <code>LOOKUP_FOLLOW</code> if we don&apos;t want to follow (open) <a href="https://en.wikipedia.org/wiki/Symbolic_link" target="_blank">symlink</a>. That&apos;s all. It is the end of the <code>build_open_flags</code> function. The <code>open_flags</code> structure is filled with modes and flags for a file opening and we can return back to the <code>do_sys_open</code>.</p>
<h2 id="actual-opening-of-a-file">Actual opening of a file</h2>
<p>At the next step after <code>build_open_flags</code> function is finished and we have formed flags and modes for our file we should get the <code>filename</code> structure with the help of the <code>getname</code> function by name of a file which was passed to the <code>open</code> system call:</p>
<pre><code class="lang-C">tmp = getname(filename);
<span class="hljs-keyword">if</span> (IS_ERR(tmp))
    <span class="hljs-keyword">return</span> PTR_ERR(tmp);
</code></pre>
<p>The <code>getname</code> function is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/namei.c" target="_blank">fs/namei.c</a> source code file and looks:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">struct</span> filename *
<span class="hljs-title">getname</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user * filename)</span>
</span>{
        <span class="hljs-keyword">return</span> getname_flags(filename, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
}
</code></pre>
<p>So, it just calls the <code>getname_flags</code> function and returns its result. The main goal of the <code>getname_flags</code> function is to copy a file path given from userland to kernel space. The <code>filename</code> structure is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/fs.h" target="_blank">include/linux/fs.h</a> linux kernel header file and contains following fields:</p>
<ul>
<li>name - pointer to a file path in kernel space;</li>
<li>uptr - original pointer from userland;</li>
<li>aname - filename from <a href="https://linux.die.net/man/8/auditd" target="_blank">audit</a> context;</li>
<li>refcnt - reference counter;</li>
<li>iname - a filename in a case when it will be less than <code>PATH_MAX</code>.</li>
</ul>
<p>As I already wrote above, the main goal of the <code>getname_flags</code> function is to copy name of a file which was passed to the <code>open</code> system call from user space to kernel space with the strncpy_from_user function. The next step after a filename will be copied to kernel space is getting of new non-busy file descriptor:</p>
<pre><code class="lang-C">fd = get_unused_fd_flags(flags);
</code></pre>
<p>The <code>get_unused_fd_flags</code> function takes table of open files of the current process, minimum (<code>0</code>) and maximum (<code>RLIMIT_NOFILE</code>) possible number of a file descriptor in the system and flags that we have passed to the <code>open</code> system call and allocates file descriptor and mark it busy in the file descriptor table of the current process. The <code>get_unused_fd_flags</code> function sets or clears the <code>O_CLOEXEC</code> flag depends on its state in the passed flags.</p>
<p>The last and main step in the <code>do_sys_open</code> is the <code>do_filp_open</code> function:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> file *f = do_filp_open(dfd, tmp, &amp;op);

<span class="hljs-keyword">if</span> (IS_ERR(f)) {
    put_unused_fd(fd);
    fd = PTR_ERR(f);
} <span class="hljs-keyword">else</span> {
    fsnotify_open(f);
    fd_install(fd, f);
}
</code></pre>
<p>The main goal of this function is to resolve given path name into <code>file</code> structure which represents an opened file of a process. If something going wrong and execution of the <code>do_filp_open</code> function will be failed, we should free new file descriptor with the <code>put_unused_fd</code> or in other way the <code>file</code> structure returned by the <code>do_filp_open</code> will be stored in the file descriptor table of the current process.</p>
<p>Now let&apos;s take a short look at the implementation of the <code>do_filp_open</code> function. This function is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/namei.c" target="_blank">fs/namei.c</a> linux kernel source code file and starts from initialization of the <code>nameidata</code> structure. This structure will provide a link to a file <a href="https://en.wikipedia.org/wiki/Inode" target="_blank">inode</a>. Actually this is one of the main point of the <code>do_filp_open</code> function to acquire an <code>inode</code> by the filename given to <code>open</code> system call. After the <code>nameidata</code> structure will be initialized, the <code>path_openat</code> function will be called:</p>
<pre><code class="lang-C">filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);

<span class="hljs-keyword">if</span> (unlikely(filp == ERR_PTR(-ECHILD)))
    filp = path_openat(&amp;nd, op, flags);
<span class="hljs-keyword">if</span> (unlikely(filp == ERR_PTR(-ESTALE)))
    filp = path_openat(&amp;nd, op, flags | LOOKUP_REVAL);
</code></pre>
<p>Note that it is called three times. Actually, the Linux kernel will open the file in <a href="https://www.kernel.org/doc/Documentation/RCU/whatisRCU.txt" target="_blank">RCU</a> mode. This is the most efficient way to open a file. If this try will be failed, the kernel enters the normal mode. The third call is relatively rare, only in the <a href="https://en.wikipedia.org/wiki/Network_File_System" target="_blank">nfs</a> file system is likely to be used. The <code>path_openat</code> function executes <code>path lookup</code> or in other words it tries to find a <code>dentry</code> (what the Linux kernel uses to keep track of the hierarchy of files in directories) corresponding to a path.</p>
<p>The <code>path_openat</code> function starts from the call of the <code>get_empty_flip()</code> function that allocates a new <code>file</code> structure with some additional checks like do we exceed amount of opened files in the system or not and etc. After we have got allocated new <code>file</code> structure we call the <code>do_tmpfile</code> or <code>do_o_path</code> functions in a case if we have passed <code>O_TMPFILE | O_CREATE</code> or <code>O_PATH</code> flags during call of the <code>open</code> system call. These both cases are quite specific, so let&apos;s consider quite usual case when we want to open already existed file and want to read/write from/to it.</p>
<p>In this case the <code>path_init</code> function will be called. This function performs some preporatory work before actual path lookup. This includes search of start position of path traversal and its metadata like <code>inode</code> of the path, <code>dentry inode</code> and etc. This can be <code>root</code> directory - <code>/</code> or current directory as in our case, because we use <code>AT_CWD</code> as starting point (see call of the <code>do_sys_open</code> at the beginning of the post).</p>
<p>The next step after the <code>path_init</code> is the <a href="https://github.com/torvalds/linux/blob/master/fs/namei.c#L3457" target="_blank">loop</a> which executes the <code>link_path_walk</code> and <code>do_last</code>. The first function executes name resolution or in other words this function starts process of walking along a given path. It handles everything step by step except the last component of a file path. This handling includes checking of a permissions and getting a file component. As a file component is gotten, it is passed to <code>walk_component</code> that updates current directory entry from the <code>dcache</code> or asks underlying filesystem. This repeats before all path&apos;s components will not be handled in such way. After the <code>link_path_walk</code> will be executed, the <code>do_last</code> function will populate a <code>file</code> structure based on the result of the <code>link_path_walk</code>. As we reached last component of the given file path the <code>vfs_open</code> function from the <code>do_last</code> will be called.</p>
<p>This function is defined in the <a href="https://github.com/torvalds/linux/blob/master/fs/open.c" target="_blank">fs/open.c</a> linux kernel source code file and the main goal of this function is to call an <code>open</code> operation of underlying filesystem.</p>
<p>That&apos;s all for now. We didn&apos;t consider <strong>full</strong> implementation of the <code>open</code> system call. We skip some parts like handling case when we want to open a file from other filesystem with different mount point, resolving symlinks and etc., but it should be not so hard to follow this stuff. This stuff does not included in <strong>generic</strong> implementation of open system call and depends on underlying filesystem. If you are interested in, you may lookup the <code>file_operations.open</code> callback function for a certain <a href="https://github.com/torvalds/linux/tree/master/fs" target="_blank">filesystem</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This is the end of the fifth part of the implementation of different system calls in the Linux kernel. If you have questions or suggestions, ping me on twitter <a href="https://twitter.com/0xAX" target="_blank">0xAX</a>, drop me an <a href="anotherworldofworld@gmail.com">email</a>, or just create an <a href="https://github.com/0xAX/linux-internals/issues/new" target="_blank">issue</a>. In the next part, we will continue to dive into system calls in the Linux kernel and see the implementation of the <a href="http://man7.org/linux/man-pages/man2/read.2.html" target="_blank">read</a> system call.</p>
<p><strong>Please note that English is not my first language and I am really sorry for any inconvenience. If you find any mistakes please send me PR to <a href="https://github.com/0xAX/linux-internals" target="_blank">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/System_call" target="_blank">system call</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank">open</a></li>
<li><a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank">file descriptor</a></li>
<li><a href="https://en.wikipedia.org/wiki/Procfs" target="_blank">proc</a></li>
<li><a href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#File-Position-Primitive" target="_blank">GNU C Library Reference Manual</a></li>
<li><a href="https://en.wikipedia.org/wiki/IA-64" target="_blank">IA-64</a> </li>
<li><a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a></li>
<li><a href="http://man7.org/linux/man-pages/man3/opendir.3.html" target="_blank">opendir</a></li>
<li><a href="http://man7.org/linux/man-pages/man7/fanotify.7.html" target="_blank">fanotify</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fork_(system_call" target="_blank">fork</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/Exec_(system_call" target="_blank">execve</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/Symbolic_link" target="_blank">symlink</a></li>
<li><a href="https://linux.die.net/man/8/auditd" target="_blank">audit</a></li>
<li><a href="https://en.wikipedia.org/wiki/Inode" target="_blank">inode</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/RCU/whatisRCU.txt" target="_blank">RCU</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/read.2.html" target="_blank">read</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-4.html" target="_blank">previous part</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="syscall-4.html" class="navigation navigation-prev " aria-label="Previous page: How the Linux kernel runs a program">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Timers/" class="navigation navigation-next " aria-label="Next page: Timers and time management">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Implementation of the open system call","level":"1.5.5","depth":2,"next":{"title":"Timers and time management","level":"1.6","depth":1,"path":"Timers/README.md","ref":"Timers/README.md","articles":[{"title":"Introduction","level":"1.6.1","depth":2,"path":"Timers/timers-1.md","ref":"Timers/timers-1.md","articles":[]},{"title":"Clocksource framework","level":"1.6.2","depth":2,"path":"Timers/timers-2.md","ref":"Timers/timers-2.md","articles":[]},{"title":"The tick broadcast framework and dyntick","level":"1.6.3","depth":2,"path":"Timers/timers-3.md","ref":"Timers/timers-3.md","articles":[]},{"title":"Introduction to timers","level":"1.6.4","depth":2,"path":"Timers/timers-4.md","ref":"Timers/timers-4.md","articles":[]},{"title":"Clockevents framework","level":"1.6.5","depth":2,"path":"Timers/timers-5.md","ref":"Timers/timers-5.md","articles":[]},{"title":"x86 related clock sources","level":"1.6.6","depth":2,"path":"Timers/timers-6.md","ref":"Timers/timers-6.md","articles":[]},{"title":"Time related system calls","level":"1.6.7","depth":2,"path":"Timers/timers-7.md","ref":"Timers/timers-7.md","articles":[]}]},"previous":{"title":"How the Linux kernel runs a program","level":"1.5.4","depth":2,"path":"SysCall/syscall-4.md","ref":"SysCall/syscall-4.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"SysCall/syscall-5.md","mtime":"2019-03-28T07:54:50.406Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T08:16:32.758Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

