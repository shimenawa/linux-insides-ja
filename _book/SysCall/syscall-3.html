
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>vsyscall and vDSO Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="syscall-4.html" />
    
    
    <link rel="prev" href="syscall-2.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Initialization/">
            
                <a href="../Initialization/">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Initialization/linux-initialization-1.html">
            
                <a href="../Initialization/linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Initialization/linux-initialization-2.html">
            
                <a href="../Initialization/linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Initialization/linux-initialization-3.html">
            
                <a href="../Initialization/linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Initialization/linux-initialization-4.html">
            
                <a href="../Initialization/linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Initialization/linux-initialization-5.html">
            
                <a href="../Initialization/linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Initialization/linux-initialization-6.html">
            
                <a href="../Initialization/linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Initialization/linux-initialization-7.html">
            
                <a href="../Initialization/linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Initialization/linux-initialization-8.html">
            
                <a href="../Initialization/linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../Initialization/linux-initialization-9.html">
            
                <a href="../Initialization/linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../Initialization/linux-initialization-10.html">
            
                <a href="../Initialization/linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="syscall-1.html">
            
                <a href="syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="syscall-2.html">
            
                <a href="syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.3" data-path="syscall-3.html">
            
                <a href="syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="syscall-4.html">
            
                <a href="syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="syscall-5.html">
            
                <a href="syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Timers/">
            
                <a href="../Timers/">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Timers/timers-1.html">
            
                <a href="../Timers/timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Timers/timers-2.html">
            
                <a href="../Timers/timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Timers/timers-3.html">
            
                <a href="../Timers/timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Timers/timers-4.html">
            
                <a href="../Timers/timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Timers/timers-5.html">
            
                <a href="../Timers/timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Timers/timers-6.html">
            
                <a href="../Timers/timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Timers/timers-7.html">
            
                <a href="../Timers/timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Misc/">
            
                <a href="../Misc/">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Misc/how_kernel_compiled.html">
            
                <a href="../Misc/how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Misc/linkers.html">
            
                <a href="../Misc/linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="../Misc/contribute.html">
            
                <a href="../Misc/contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="../Misc/program_startup.html">
            
                <a href="../Misc/program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >vsyscall and vDSO</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="system-calls-in-the-linux-kernel-part-3">System calls in the Linux kernel. Part 3.</h1>
<h2 id="vsyscalls-and-vdso">vsyscalls and vDSO</h2>
<p>This is the third part of the <a href="http://0xax.gitbooks.io/linux-insides/content/SysCall/index.html" target="_blank">chapter</a> that describes system calls in the Linux kernel and we saw preparations after a system call caused by an userspace application and process of handling of a system call in the previous <a href="http://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-2.html" target="_blank">part</a>. In this part we will look at two concepts that are very close to the system call concept, they are called <code>vsyscall</code> and <code>vdso</code>.</p>
<p>We already know what is a <code>system call</code>. This is special routine in the Linux kernel which userspace application asks to do privileged tasks, like to read or to write to a file, to open a socket and etc. As you may know, invoking a system call is an expensive operation in the Linux kernel, because the processor must interrupt the currently executing task and switch context to kernel mode, subsequently jumping again into userspace after the system call handler finishes its work. These two mechanisms - <code>vsyscall</code> and <code>vdso</code> are designed to speed up this process for certain system calls and in this part we will try to understand how these mechanisms work.</p>
<h2 id="introduction-to-vsyscalls">Introduction to vsyscalls</h2>
<p>The <code>vsyscall</code> or <code>virtual system call</code> is the first and oldest mechanism in the Linux kernel that is designed to accelerate execution of certain system calls. The principle of work of the <code>vsyscall</code> concept is simple. The Linux kernel maps into user space a page that contains some variables and the implementation of some system calls. We can find information about this memory space in the Linux kernel <a href="https://github.com/torvalds/linux/blob/master/Documentation/x86/x86_64/mm.txt" target="_blank">documentation</a> for the <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a>:</p>
<pre><code>ffffffffff600000 - ffffffffffdfffff (=8 MB) vsyscalls
</code></pre><p>or:</p>
<pre><code>~$ sudo cat /proc/1/maps | grep vsyscall
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
</code></pre><p>After this, these system calls will be executed in userspace and this means that there will not be <a href="https://en.wikipedia.org/wiki/Context_switch" target="_blank">context switching</a>. Mapping of the <code>vsyscall</code> page occurs in the <code>map_vsyscall</code> function that is defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vsyscall/vsyscall_64.c" target="_blank">arch/x86/entry/vsyscall/vsyscall_64.c</a> source code file. This function is called during the Linux kernel initialization in the <code>setup_arch</code> function that is defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup.c" target="_blank">arch/x86/kernel/setup.c</a> source code file (we saw this function in the fifth <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-5.html" target="_blank">part</a> of the Linux kernel initialization process chapter).</p>
<p>Note that implementation of the <code>map_vsyscall</code> function depends on the <code>CONFIG_X86_VSYSCALL_EMULATION</code> kernel configuration option:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_VSYSCALL_EMULATION</span>
<span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map_vsyscall</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map_vsyscall</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>As we can read in the help text, the <code>CONFIG_X86_VSYSCALL_EMULATION</code> configuration option: <code>Enable vsyscall emulation</code>. Why emulate <code>vsyscall</code>? Actually, the <code>vsyscall</code> is a legacy <a href="https://en.wikipedia.org/wiki/Application_binary_interface" target="_blank">ABI</a> due to security reasons. Virtual system calls have fixed addresses, meaning that <code>vsyscall</code> page is still at the same location every time and the location of this page is determined in the <code>map_vsyscall</code> function. Let&apos;s look on the implementation of this function: </p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">map_vsyscall</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> __vsyscall_page;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> physaddr_vsyscall = __pa_symbol(&amp;__vsyscall_page);
    ...
    ...
    ...
}
</code></pre>
<p>As we can see, at the beginning of the <code>map_vsyscall</code> function we get the physical address of the <code>vsyscall</code> page with the <code>__pa_symbol</code> macro (we already saw implementation if this macro in the fourth <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-4.html" target="_blank">path</a> of the Linux kernel initialization process). The <code>__vsyscall_page</code> symbol defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vsyscall/vsyscall_emu_64.S" target="_blank">arch/x86/entry/vsyscall/vsyscall_emu_64.S</a> assembly source code file and have the following <a href="https://en.wikipedia.org/wiki/Virtual_address_space" target="_blank">virtual address</a>:</p>
<pre><code>ffffffff81881000 D __vsyscall_page
</code></pre><p>in the <code>.data..page_aligned, aw</code> <a href="https://en.wikipedia.org/wiki/Memory_segmentation" target="_blank">section</a> and contains call of the three following system calls:</p>
<ul>
<li><code>gettimeofday</code>;</li>
<li><code>time</code>;</li>
<li><code>getcpu</code>.</li>
</ul>
<p>Or:</p>
<pre><code class="lang-assembly">__vsyscall_page:
    mov $__NR_gettimeofday, %rax
    syscall
    ret

    .balign 1024, 0xcc
    mov $__NR_time, %rax
    syscall
    ret

    .balign 1024, 0xcc
    mov $__NR_getcpu, %rax
    syscall
    ret
</code></pre>
<p>Let&apos;s go back to the implementation of the <code>map_vsyscall</code> function and return to the implementation of the <code>__vsyscall_page</code>, later. After we receiving the physical address of the <code>__vsyscall_page</code>, we check the value of the <code>vsyscall_mode</code> variable and set the <a href="http://0xax.gitbooks.io/linux-insides/content/mm/linux-mm-2.html" target="_blank">fix-mapped</a> address for the <code>vsyscall</code> page with the <code>__set_fixmap</code> macro:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (vsyscall_mode != NONE)
    __set_fixmap(VSYSCALL_PAGE, physaddr_vsyscall,
                 vsyscall_mode == NATIVE
                             ? PAGE_KERNEL_VSYSCALL
                             : PAGE_KERNEL_VVAR);
</code></pre>
<p>The <code>__set_fixmap</code> takes three arguments: The first is index of the <code>fixed_addresses</code> <a href="https://en.wikipedia.org/wiki/Enumerated_type" target="_blank">enum</a>. In our case <code>VSYSCALL_PAGE</code> is the first element of the <code>fixed_addresses</code> enum for the <code>x86_64</code> architecture:</p>
<pre><code class="lang-C"><span class="hljs-keyword">enum</span> fixed_addresses {
...
...
...
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_VSYSCALL_EMULATION</span>
    VSYSCALL_PAGE = (FIXADDR_TOP - VSYSCALL_ADDR) &gt;&gt; PAGE_SHIFT,
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
...
...
...
</code></pre>
<p>It equal to the <code>511</code>. The second argument is the physical address of the page that has to be mapped and the third argument is the flags of the page. Note that the flags of the <code>VSYSCALL_PAGE</code> depend on the <code>vsyscall_mode</code> variable. It will be <code>PAGE_KERNEL_VSYSCALL</code> if the <code>vsyscall_mode</code> variable is <code>NATIVE</code> and the <code>PAGE_KERNEL_VVAR</code> otherwise. Both macros (the <code>PAGE_KERNEL_VSYSCALL</code> and the <code>PAGE_KERNEL_VVAR</code>) will be expanded to the following flags:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __PAGE_KERNEL_VSYSCALL          (__PAGE_KERNEL_RX | _PAGE_USER)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __PAGE_KERNEL_VVAR              (__PAGE_KERNEL_RO | _PAGE_USER)</span>
</code></pre>
<p>that represent access rights to the <code>vsyscall</code> page. Both flags have the same <code>_PAGE_USER</code> flags that means that the page can be accessed by a user-mode process running at lower privilege levels. The second flag depends on the value of the <code>vsyscall_mode</code> variable. The first flag (<code>__PAGE_KERNEL_VSYSCALL</code>) will be set in the case where <code>vsyscall_mode</code> is <code>NATIVE</code>. This means virtual system calls will be native <code>syscall</code> instructions. In other way the vsyscall will have <code>PAGE_KERNEL_VVAR</code> if the <code>vsyscall_mode</code> variable will be <code>emulate</code>. In this case virtual system calls will be turned into traps and are emulated reasonably. The <code>vsyscall_mode</code> variable gets its value in the <code>vsyscall_setup</code> function:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __<span class="hljs-function">init <span class="hljs-title">vsyscall_setup</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str)</span>
</span>{
    <span class="hljs-keyword">if</span> (str) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;emulate&quot;</span>, str))
            vsyscall_mode = EMULATE;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;native&quot;</span>, str))
            vsyscall_mode = NATIVE;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;none&quot;</span>, str))
            vsyscall_mode = NONE;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> -EINVAL;

        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">return</span> -EINVAL;
}
</code></pre>
<p>That will be called during early kernel parameters parsing:</p>
<pre><code class="lang-C">early_param(<span class="hljs-string">&quot;vsyscall&quot;</span>, vsyscall_setup);
</code></pre>
<p>More about <code>early_param</code> macro you can read in the sixth <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-6.html" target="_blank">part</a> of the chapter that describes process of the initialization of the Linux kernel.</p>
<p>In the end of the <code>vsyscall_map</code> function we just check that virtual address of the <code>vsyscall</code> page is equal to the value of the <code>VSYSCALL_ADDR</code> with the <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-1.html" target="_blank">BUILD_BUG_ON</a> macro:</p>
<pre><code class="lang-C">BUILD_BUG_ON((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)__fix_to_virt(VSYSCALL_PAGE) !=
             (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)VSYSCALL_ADDR);
</code></pre>
<p>That&apos;s all. <code>vsyscall</code> page is set up. The result of the all the above is the following: If we pass <code>vsyscall=native</code> parameter to the kernel command line, virtual system calls will be handled as native <code>syscall</code> instructions in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vsyscall/vsyscall_emu_64.S" target="_blank">arch/x86/entry/vsyscall/vsyscall_emu_64.S</a>. The <a href="https://en.wikipedia.org/wiki/GNU_C_Library" target="_blank">glibc</a> knows addresses of the virtual system call handlers. Note that virtual system call handlers are aligned by <code>1024</code> (or <code>0x400</code>) bytes:</p>
<pre><code class="lang-assembly">__vsyscall_page:
    mov $__NR_gettimeofday, %rax
    syscall
    ret

    .balign 1024, 0xcc
    mov $__NR_time, %rax
    syscall
    ret

    .balign 1024, 0xcc
    mov $__NR_getcpu, %rax
    syscall
    ret
</code></pre>
<p>And the start address of the <code>vsyscall</code> page is the <code>ffffffffff600000</code> every time. So, the <a href="https://en.wikipedia.org/wiki/GNU_C_Library" target="_blank">glibc</a> knows the addresses of the all virtual system call handlers. You can find definition of these addresses in the <code>glibc</code> source code:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VSYSCALL_ADDR_vgettimeofday   0xffffffffff600000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VSYSCALL_ADDR_vtime           0xffffffffff600400</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VSYSCALL_ADDR_vgetcpu          0xffffffffff600800</span>
</code></pre>
<p>All virtual system call requests will fall into the <code>__vsyscall_page</code> + <code>VSYSCALL_ADDR_vsyscall_name</code> offset, put the number of a virtual system call to the <code>rax</code> general purpose <a href="https://en.wikipedia.org/wiki/Processor_register" target="_blank">register</a> and the native for the x86_64 <code>syscall</code> instruction will be executed.</p>
<p>In the second case, if we pass <code>vsyscall=emulate</code> parameter to the kernel command line, an attempt to perform virtual system call handler will cause a <a href="https://en.wikipedia.org/wiki/Page_fault" target="_blank">page fault</a> exception. Of course, remember, the <code>vsyscall</code> page has <code>__PAGE_KERNEL_VVAR</code> access rights that forbid execution. The <code>do_page_fault</code> function is the <code>#PF</code> or page fault handler. It tries to understand the reason of the last page fault. And one of the reason can be situation when virtual system call called and <code>vsyscall</code> mode is <code>emulate</code>. In this case <code>vsyscall</code> will be handled by the <code>emulate_vsyscall</code> function that defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vsyscall/vsyscall_64.c" target="_blank">arch/x86/entry/vsyscall/vsyscall_64.c</a> source code file.</p>
<p>The <code>emulate_vsyscall</code> function gets the number of a virtual system call, checks it, prints error and sends <a href="https://en.wikipedia.org/wiki/Segmentation_fault" target="_blank">segmentation fault</a> simply:</p>
<pre><code class="lang-C">...
...
...
vsyscall_nr = addr_to_vsyscall_nr(address);
if (vsyscall_nr &lt; 0) {
    warn_bad_vsyscall(KERN_WARNING, regs, &quot;misaligned vsyscall...);
    goto sigsegv;
}
...
...
...
sigsegv:
    force_sig(SIGSEGV, current);
    reutrn true;
</code></pre>
<p>As it checked number of a virtual system call, it does some yet another checks like <code>access_ok</code> violations and execute system call function depends on the number of a virtual system call:</p>
<pre><code class="lang-C"><span class="hljs-keyword">switch</span> (vsyscall_nr) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        ret = sys_gettimeofday(
            (<span class="hljs-keyword">struct</span> timeval __user *)regs-&gt;di,
            (<span class="hljs-keyword">struct</span> timezone __user *)regs-&gt;si);
        <span class="hljs-keyword">break</span>;
    ...
    ...
    ...
}
</code></pre>
<p>In the end we put the result of the <code>sys_gettimeofday</code> or another virtual system call handler to the <code>ax</code> general purpose register, as we did it with the normal system calls and restore the <a href="https://en.wikipedia.org/wiki/Program_counter" target="_blank">instruction pointer</a> register and add <code>8</code> bytes to the <a href="https://en.wikipedia.org/wiki/Stack_register" target="_blank">stack pointer</a> register. This operation emulates <code>ret</code> instruction.</p>
<pre><code class="lang-C">    regs-&gt;ax = ret;

do_ret:
    regs-&gt;ip = caller;
    regs-&gt;sp += <span class="hljs-number">8</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
</code></pre>
<p>That&apos;s all. Now let&apos;s look on the modern concept - <code>vDSO</code>.</p>
<h2 id="introduction-to-vdso">Introduction to vDSO</h2>
<p>As I already wrote above, <code>vsyscall</code> is an obsolete concept and replaced by the <code>vDSO</code> or <code>virtual dynamic shared object</code>. The main difference between the <code>vsyscall</code> and <code>vDSO</code> mechanisms is that <code>vDSO</code> maps memory pages into each process in a shared object <a href="https://en.wikipedia.org/wiki/Library_%28computing%29#Shared_libraries" target="_blank">form</a>, but <code>vsyscall</code> is static in memory and has the same address every time. For the <code>x86_64</code> architecture it is called -<code>linux-vdso.so.1</code>. All userspace applications linked with this shared library via the <code>glibc</code>. For example:</p>
<pre><code>~$ ldd /bin/uname
    linux-vdso.so.1 (0x00007ffe014b7000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fbfee2fe000)
    /lib64/ld-linux-x86-64.so.2 (0x00005559aab7c000)
</code></pre><p>Or:</p>
<pre><code>~$ sudo cat /proc/1/maps | grep vdso
7fff39f73000-7fff39f75000 r-xp 00000000 00:00 0       [vdso]
</code></pre><p>Here we can see that <a href="https://en.wikipedia.org/wiki/Uname" target="_blank">uname</a> util was linked with the three libraries:</p>
<ul>
<li><code>linux-vdso.so.1</code>;</li>
<li><code>libc.so.6</code>;</li>
<li><code>ld-linux-x86-64.so.2</code>.</li>
</ul>
<p>The first provides <code>vDSO</code> functionality, the second is <code>C</code> <a href="https://en.wikipedia.org/wiki/C_standard_library" target="_blank">standard library</a> and the third is the program interpreter (more about this you can read in the part that describes <a href="http://0xax.gitbooks.io/linux-insides/content/Misc/linkers.html" target="_blank">linkers</a>). So, the <code>vDSO</code> solves limitations of the <code>vsyscall</code>. Implementation of the <code>vDSO</code> is similar to <code>vsyscall</code>.</p>
<p>Initialization of the <code>vDSO</code> occurs in the <code>init_vdso</code> function that defined in the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vdso/vma.c" target="_blank">arch/x86/entry/vdso/vma.c</a> source code file. This function starts from the initialization of the <code>vDSO</code> images for 32-bits and 64-bits depends on the <code>CONFIG_X86_X32_ABI</code> kernel configuration option:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __<span class="hljs-function">init <span class="hljs-title">init_vdso</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    init_vdso_image(&amp;vdso_image_64);

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_X32_ABI</span>
    init_vdso_image(&amp;vdso_image_x32);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>Both function initialize the <code>vdso_image</code> structure. This structure is defined in the two generated source code files: the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vdso/vdso-image-64.c" target="_blank">arch/x86/entry/vdso/vdso-image-64.c</a> and the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vdso/vdso-image-64.c" target="_blank">arch/x86/entry/vdso/vdso-image-64.c</a>. These source code files generated by the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vdso/vdso2c.c" target="_blank">vdso2c</a> program from the different source code files, represent different approaches to call a system call like <code>int 0x80</code>, <code>sysenter</code> and etc. The full set of the images depends on the kernel configuration.</p>
<p>For example for the <code>x86_64</code> Linux kernel it will contain <code>vdso_image_64</code>:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_64</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_64;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>But for the <code>x86</code> - <code>vdso_image_32</code>:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_X32</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_x32;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>If our kernel is configured for the <code>x86</code> architecture or for the <code>x86_64</code> and compatibility mode, we will have ability to call a system call with the <code>int 0x80</code> interrupt, if compatibility mode is enabled, we will be able to call a system call with the native <code>syscall instruction</code> or <code>sysenter</code> instruction in other way:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CONFIG_X86_32 || defined CONFIG_COMPAT</span>
  <span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_32_int80;
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_COMPAT</span>
  <span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_32_syscall;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
 <span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_32_sysenter;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>As we can understand from the name of the <code>vdso_image</code> structure, it represents image of the <code>vDSO</code> for the certain mode of the system call entry. This structure contains information about size in bytes of the <code>vDSO</code> area that always a multiple of <code>PAGE_SIZE</code> (<code>4096</code> bytes), pointer to the text mapping, start and end address of the <code>alternatives</code> (set of instructions with better alternatives for the certain type of the processor) and etc. For example <code>vdso_image_64</code> looks like this:</p>
<pre><code class="lang-C"><span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image vdso_image_64 = {
    .data = raw_data,
    .size = <span class="hljs-number">8192</span>,
    .text_mapping = {
        .name = <span class="hljs-string">&quot;[vdso]&quot;</span>,
        .pages = pages,
    },
    .alt = <span class="hljs-number">3145</span>,
    .alt_len = <span class="hljs-number">26</span>,
    .sym_vvar_start = <span class="hljs-number">-8192</span>,
    .sym_vvar_page = <span class="hljs-number">-8192</span>,
    .sym_hpet_page = <span class="hljs-number">-4096</span>,
};
</code></pre>
<p>Where the <code>raw_data</code> contains raw binary code of the 64-bit <code>vDSO</code> system calls which are <code>2</code> page size:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> page *pages[<span class="hljs-number">2</span>];
</code></pre>
<p>or 8 Kilobytes.</p>
<p>The <code>init_vdso_image</code> function is defined in the same source code file and just initializes the <code>vdso_image.text_mapping.pages</code>. First of all this function calculates the number of pages and initializes each <code>vdso_image.text_mapping.pages[number_of_page]</code> with the <code>virt_to_page</code> macro that converts given address to the <code>page</code> structure:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">init_vdso_image</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> vdso_image *image)</span>
</span>{
    <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">int</span> npages = (image-&gt;size) / PAGE_SIZE;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; npages; i++)
        image-&gt;text_mapping.pages[i] =
            virt_to_page(image-&gt;data + i*PAGE_SIZE);
    ...
    ...
    ...
}
</code></pre>
<p>The <code>init_vdso</code> function passed to the <code>subsys_initcall</code> macro adds the given function to the <code>initcalls</code> list. All functions from this list will be called in the <code>do_initcalls</code> function from the <a href="https://github.com/torvalds/linux/blob/master/init/main.c" target="_blank">init/main.c</a> source code file:</p>
<pre><code class="lang-C">subsys_initcall(init_vdso);
</code></pre>
<p>Ok, we just saw initialization of the <code>vDSO</code> and initialization of <code>page</code> structures that are related to the memory pages that contain <code>vDSO</code> system calls. But to where do their pages map? Actually they are mapped by the kernel, when it loads binary to the memory. The Linux kernel calls the <code>arch_setup_additional_pages</code> function from the <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/vdso/vma.c" target="_blank">arch/x86/entry/vdso/vma.c</a> source code file that checks that <code>vDSO</code> enabled for the <code>x86_64</code> and calls the <code>map_vdso</code> function:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">arch_setup_additional_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> linux_binprm *bprm, <span class="hljs-keyword">int</span> uses_interp)</span>
</span>{
    <span class="hljs-keyword">if</span> (!vdso64_enabled)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">return</span> map_vdso(&amp;vdso_image_64, <span class="hljs-literal">true</span>);
}
</code></pre>
<p>The <code>map_vdso</code> function is defined in the same source code file and maps pages for the <code>vDSO</code> and for the shared <code>vDSO</code> variables. That&apos;s all. The main differences between the <code>vsyscall</code> and the <code>vDSO</code> concepts is that <code>vsyscal</code> has a static address of <code>ffffffffff600000</code> and implements <code>3</code> system calls, whereas the <code>vDSO</code> loads dynamically and implements four system calls:</p>
<ul>
<li><code>__vdso_clock_gettime</code>;</li>
<li><code>__vdso_getcpu</code>;</li>
<li><code>__vdso_gettimeofday</code>;</li>
<li><code>__vdso_time</code>.</li>
</ul>
<p>That&apos;s all.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This is the end of the third part about the system calls concept in the Linux kernel. In the previous <a href="http://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-2.html" target="_blank">part</a> we discussed the implementation of the preparation from the Linux kernel side, before a system call will be handled and implementation of the <code>exit</code> process from a system call handler. In this part we continued to dive into the stuff which is related to the system call concept and learned two new concepts that are very similar to the system call - the <code>vsyscall</code> and the <code>vDSO</code>.</p>
<p>After all of these three parts, we know almost all things that are related to system calls, we know what system call is and why user applications need them.  We also know what occurs when a user application calls a system call and how the kernel handles system calls.</p>
<p>The next part will be the last part in this <a href="http://0xax.gitbooks.io/linux-insides/content/SysCall/index.html" target="_blank">chapter</a> and we will see what occurs when a user runs the program.</p>
<p>If you have questions or suggestions, feel free to ping me in twitter <a href="https://twitter.com/0xAX" target="_blank">0xAX</a>, drop me <a href="anotherworldofworld@gmail.com">email</a> or just create <a href="https://github.com/0xAX/linux-insides/issues/new" target="_blank">issue</a>.</p>
<p><strong>Please note that English is not my first language and I am really sorry for any inconvenience. If you found any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides" target="_blank">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://github.com/torvalds/linux/blob/master/Documentation/x86/x86_64/mm.txt" target="_blank">x86_64 memory map</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86-64" target="_blank">x86_64</a></li>
<li><a href="https://en.wikipedia.org/wiki/Context_switch" target="_blank">context switching</a></li>
<li><a href="https://en.wikipedia.org/wiki/Application_binary_interface" target="_blank">ABI</a></li>
<li><a href="https://en.wikipedia.org/wiki/Virtual_address_space" target="_blank">virtual address</a></li>
<li><a href="https://en.wikipedia.org/wiki/Memory_segmentation" target="_blank">Segmentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Enumerated_type" target="_blank">enum</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/mm/linux-mm-2.html" target="_blank">fix-mapped addresses</a></li>
<li><a href="https://en.wikipedia.org/wiki/GNU_C_Library" target="_blank">glibc</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-1.html" target="_blank">BUILD_BUG_ON</a></li>
<li><a href="https://en.wikipedia.org/wiki/Processor_register" target="_blank">Processor register</a></li>
<li><a href="https://en.wikipedia.org/wiki/Page_fault" target="_blank">Page fault</a></li>
<li><a href="https://en.wikipedia.org/wiki/Segmentation_fault" target="_blank">segmentation fault</a></li>
<li><a href="https://en.wikipedia.org/wiki/Program_counter" target="_blank">instruction pointer</a></li>
<li><a href="https://en.wikipedia.org/wiki/Stack_register" target="_blank">stack pointer</a></li>
<li><a href="https://en.wikipedia.org/wiki/Uname" target="_blank">uname</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/Misc/linkers.html" target="_blank">Linkers</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-2.html" target="_blank">Previous part</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="syscall-2.html" class="navigation navigation-prev " aria-label="Previous page: How the Linux kernel handles a system call">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="syscall-4.html" class="navigation navigation-next " aria-label="Next page: How the Linux kernel runs a program">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"vsyscall and vDSO","level":"1.5.3","depth":2,"next":{"title":"How the Linux kernel runs a program","level":"1.5.4","depth":2,"path":"SysCall/syscall-4.md","ref":"SysCall/syscall-4.md","articles":[]},"previous":{"title":"How the Linux kernel handles a system call","level":"1.5.2","depth":2,"path":"SysCall/syscall-2.md","ref":"SysCall/syscall-2.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"SysCall/syscall-3.md","mtime":"2019-03-28T07:54:50.406Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T07:57:01.662Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

