
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>RCU initialization Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="linux-initialization-10.html" />
    
    
    <link rel="prev" href="linux-initialization-8.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Summary</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Booting/">
            
                <a href="../Booting/">
            
                    
                    Booting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Booting/linux-bootstrap-1.html">
            
                <a href="../Booting/linux-bootstrap-1.html">
            
                    
                    From bootloader to kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Booting/linux-bootstrap-2.html">
            
                <a href="../Booting/linux-bootstrap-2.html">
            
                    
                    First steps in the kernel setup code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Booting/linux-bootstrap-3.html">
            
                <a href="../Booting/linux-bootstrap-3.html">
            
                    
                    Video mode initialization and transition to protected mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Booting/linux-bootstrap-4.html">
            
                <a href="../Booting/linux-bootstrap-4.html">
            
                    
                    Transition to 64-bit mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Booting/linux-bootstrap-5.html">
            
                <a href="../Booting/linux-bootstrap-5.html">
            
                    
                    Kernel decompression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Initialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-initialization-1.html">
            
                <a href="linux-initialization-1.html">
            
                    
                    First steps in the kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-initialization-2.html">
            
                <a href="linux-initialization-2.html">
            
                    
                    Early interrupts handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-initialization-3.html">
            
                <a href="linux-initialization-3.html">
            
                    
                    Last preparations before the kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-initialization-4.html">
            
                <a href="linux-initialization-4.html">
            
                    
                    Kernel entry point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="linux-initialization-5.html">
            
                <a href="linux-initialization-5.html">
            
                    
                    Continue architecture-specific boot-time initializations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="linux-initialization-6.html">
            
                <a href="linux-initialization-6.html">
            
                    
                    Architecture-specific initializations, again...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="linux-initialization-7.html">
            
                <a href="linux-initialization-7.html">
            
                    
                    End of the architecture-specific initializations, almost...
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="linux-initialization-8.html">
            
                <a href="linux-initialization-8.html">
            
                    
                    Scheduler initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.9" data-path="linux-initialization-9.html">
            
                <a href="linux-initialization-9.html">
            
                    
                    RCU initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="linux-initialization-10.html">
            
                <a href="linux-initialization-10.html">
            
                    
                    End of initialization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../interrupts/">
            
                <a href="../interrupts/">
            
                    
                    Interrupts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../interrupts/interrupts-1.html">
            
                <a href="../interrupts/interrupts-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../interrupts/interrupts-2.html">
            
                <a href="../interrupts/interrupts-2.html">
            
                    
                    Start to dive into interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../interrupts/interrupts-3.html">
            
                <a href="../interrupts/interrupts-3.html">
            
                    
                    Interrupt handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../interrupts/interrupts-4.html">
            
                <a href="../interrupts/interrupts-4.html">
            
                    
                    Initialization of non-early interrupt gates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../interrupts/interrupts-5.html">
            
                <a href="../interrupts/interrupts-5.html">
            
                    
                    Implementation of some exception handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../interrupts/interrupts-6.html">
            
                <a href="../interrupts/interrupts-6.html">
            
                    
                    Handling Non-Maskable interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../interrupts/interrupts-7.html">
            
                <a href="../interrupts/interrupts-7.html">
            
                    
                    Dive into external hardware interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../interrupts/interrupts-8.html">
            
                <a href="../interrupts/interrupts-8.html">
            
                    
                    Initialization of external hardware interrupts structures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../interrupts/interrupts-9.html">
            
                <a href="../interrupts/interrupts-9.html">
            
                    
                    Softirq, Tasklets and Workqueues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../interrupts/interrupts-10.html">
            
                <a href="../interrupts/interrupts-10.html">
            
                    
                    Last part
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../SysCall/">
            
                <a href="../SysCall/">
            
                    
                    System calls
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../SysCall/syscall-1.html">
            
                <a href="../SysCall/syscall-1.html">
            
                    
                    Introduction to system calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../SysCall/syscall-2.html">
            
                <a href="../SysCall/syscall-2.html">
            
                    
                    How the Linux kernel handles a system call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../SysCall/syscall-3.html">
            
                <a href="../SysCall/syscall-3.html">
            
                    
                    vsyscall and vDSO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../SysCall/syscall-4.html">
            
                <a href="../SysCall/syscall-4.html">
            
                    
                    How the Linux kernel runs a program
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../SysCall/syscall-5.html">
            
                <a href="../SysCall/syscall-5.html">
            
                    
                    Implementation of the open system call
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Timers/">
            
                <a href="../Timers/">
            
                    
                    Timers and time management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Timers/timers-1.html">
            
                <a href="../Timers/timers-1.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Timers/timers-2.html">
            
                <a href="../Timers/timers-2.html">
            
                    
                    Clocksource framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Timers/timers-3.html">
            
                <a href="../Timers/timers-3.html">
            
                    
                    The tick broadcast framework and dyntick
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Timers/timers-4.html">
            
                <a href="../Timers/timers-4.html">
            
                    
                    Introduction to timers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Timers/timers-5.html">
            
                <a href="../Timers/timers-5.html">
            
                    
                    Clockevents framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Timers/timers-6.html">
            
                <a href="../Timers/timers-6.html">
            
                    
                    x86 related clock sources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Timers/timers-7.html">
            
                <a href="../Timers/timers-7.html">
            
                    
                    Time related system calls
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SyncPrim/">
            
                <a href="../SyncPrim/">
            
                    
                    Synchronization primitives
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../SyncPrim/sync-1.html">
            
                <a href="../SyncPrim/sync-1.html">
            
                    
                    Introduction to spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../SyncPrim/sync-2.html">
            
                <a href="../SyncPrim/sync-2.html">
            
                    
                    Queued spinlocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../SyncPrim/sync-3.html">
            
                <a href="../SyncPrim/sync-3.html">
            
                    
                    Semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../SyncPrim/sync-4.html">
            
                <a href="../SyncPrim/sync-4.html">
            
                    
                    Mutex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../SyncPrim/sync-5.html">
            
                <a href="../SyncPrim/sync-5.html">
            
                    
                    Reader/Writer semaphores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../SyncPrim/sync-6.html">
            
                <a href="../SyncPrim/sync-6.html">
            
                    
                    SeqLock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" >
            
                <span>
            
                    
                    RCU
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" >
            
                <span>
            
                    
                    Lockdep
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../mm/">
            
                <a href="../mm/">
            
                    
                    Memory management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../mm/linux-mm-1.html">
            
                <a href="../mm/linux-mm-1.html">
            
                    
                    Memblock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../mm/linux-mm-2.html">
            
                <a href="../mm/linux-mm-2.html">
            
                    
                    Fixmaps and ioremap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../mm/linux-mm-3.html">
            
                <a href="../mm/linux-mm-3.html">
            
                    
                    kmemcheck
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Cgroups/">
            
                <a href="../Cgroups/">
            
                    
                    Cgroups
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Cgroups/cgroups1.html">
            
                <a href="../Cgroups/cgroups1.html">
            
                    
                    Introduction to Control Groups
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    SMP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Concepts/">
            
                <a href="../Concepts/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Concepts/per-cpu.html">
            
                <a href="../Concepts/per-cpu.html">
            
                    
                    Per-CPU variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Concepts/cpumask.html">
            
                <a href="../Concepts/cpumask.html">
            
                    
                    Cpumasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Concepts/initcall.html">
            
                <a href="../Concepts/initcall.html">
            
                    
                    The initcall mechanism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../DataStructures/">
            
                <a href="../DataStructures/">
            
                    
                    Data Structures in the Linux Kernel
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../DataStructures/dlist.html">
            
                <a href="../DataStructures/dlist.html">
            
                    
                    Doubly linked list
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../DataStructures/radix-tree.html">
            
                <a href="../DataStructures/radix-tree.html">
            
                    
                    Radix tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../DataStructures/bitmap.html">
            
                <a href="../DataStructures/bitmap.html">
            
                    
                    Bit arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Theory/">
            
                <a href="../Theory/">
            
                    
                    Theory
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../Theory/Paging.html">
            
                <a href="../Theory/Paging.html">
            
                    
                    Paging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../Theory/ELF.html">
            
                <a href="../Theory/ELF.html">
            
                    
                    Elf64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../Theory/asm.html">
            
                <a href="../Theory/asm.html">
            
                    
                    Inline assembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" >
            
                <span>
            
                    
                    CPUID
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" >
            
                <span>
            
                    
                    MSR
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Initial ram disk
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" >
            
                <span>
            
                    
                    initrd
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Misc/">
            
                <a href="../Misc/">
            
                    
                    Misc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Misc/how_kernel_compiled.html">
            
                <a href="../Misc/how_kernel_compiled.html">
            
                    
                    How the kernel is compiled
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Misc/linkers.html">
            
                <a href="../Misc/linkers.html">
            
                    
                    Linkers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="../Misc/contribute.html">
            
                <a href="../Misc/contribute.html">
            
                    
                    Linux kernel development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" data-path="../Misc/program_startup.html">
            
                <a href="../Misc/program_startup.html">
            
                    
                    Program startup process in userspace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <span>
            
                    
                    Write and Submit your first Linux kernel Patch
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.6" >
            
                <span>
            
                    
                    Data types in the kernel
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../KernelStructures/">
            
                <a href="../KernelStructures/">
            
                    
                    KernelStructures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../KernelStructures/idt.html">
            
                <a href="../KernelStructures/idt.html">
            
                    
                    IDT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../LINKS.html">
            
                <a href="../LINKS.html">
            
                    
                    Useful links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../contributors.html">
            
                <a href="../contributors.html">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >RCU initialization</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="kernel-initialization-part-9">Kernel initialization. Part 9.</h1>
<h1 id="rcu-initialization">RCU initialization</h1>
<p>This is ninth part of the <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/index.html" target="_blank">Linux Kernel initialization process</a> and in the previous part we stopped at the <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-8.html" target="_blank">scheduler initialization</a>. In this part we will continue to dive to the linux kernel initialization process and the main purpose of this part will be to learn about initialization of the <a href="http://en.wikipedia.org/wiki/Read-copy-update" target="_blank">RCU</a>. We can see that the next step in the <a href="https://github.com/torvalds/linux/blob/master/init/main.c" target="_blank">init/main.c</a> after the <code>sched_init</code> is the call of the <code>preempt_disable</code>. There are two macros:</p>
<ul>
<li><code>preempt_disable</code></li>
<li><code>preempt_enable</code></li>
</ul>
<p>for preemption disabling and enabling. First of all let&apos;s try to understand what is <code>preempt</code> in the context of an operating system kernel. In simple words, preemption is ability of the operating system kernel to preempt current task to run task with higher priority. Here we need to disable preemption because we will have only one <code>init</code> process for the early boot time and we don&apos;t need to stop it before we call <code>cpu_idle</code> function. The <code>preempt_disable</code> macro is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/preempt.h" target="_blank">include/linux/preempt.h</a> and depends on the <code>CONFIG_PREEMPT_COUNT</code> kernel configuration option. This macro is implemented as:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> preempt_disable() \
do { \
        preempt_count_inc(); \
        barrier(); \
} while (0)</span>
</code></pre>
<p>and if <code>CONFIG_PREEMPT_COUNT</code> is not set just:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> preempt_disable()                       barrier()</span>
</code></pre>
<p>Let&apos;s look on it. First of all we can see one difference between these macro implementations. The <code>preempt_disable</code> with <code>CONFIG_PREEMPT_COUNT</code> set contains the call of the <code>preempt_count_inc</code>. There is special <code>percpu</code> variable which stores the number of held locks and <code>preempt_disable</code> calls:</p>
<pre><code class="lang-C">DECLARE_PER_CPU(<span class="hljs-keyword">int</span>, __preempt_count);
</code></pre>
<p>In the first implementation of the <code>preempt_disable</code> we increment this <code>__preempt_count</code>. There is API for returning value of the <code>__preempt_count</code>, it is the <code>preempt_count</code> function. As we called <code>preempt_disable</code>, first of all we increment preemption counter with the <code>preempt_count_inc</code> macro which expands to the:</p>
<pre><code>#define preempt_count_inc() preempt_count_add(1)
#define preempt_count_add(val)  __preempt_count_add(val)
</code></pre><p>where <code>preempt_count_add</code> calls the <code>raw_cpu_add_4</code> macro which adds <code>1</code> to the given <code>percpu</code> variable (<code>__preempt_count</code>) in our case (more about <code>precpu</code> variables you can read in the part about <a href="http://0xax.gitbooks.io/linux-insides/content/Concepts/per-cpu.html" target="_blank">Per-CPU variables</a>). Ok, we increased <code>__preempt_count</code> and the next step we can see the call of the <code>barrier</code> macro in the both macros. The <code>barrier</code> macro inserts an optimization barrier. In the processors with <code>x86_64</code> architecture independent memory access operations can be performed in any order. That&apos;s why we need the opportunity to point compiler and processor on compliance of order. This mechanism is memory barrier. Let&apos;s consider a simple example:</p>
<pre><code class="lang-C">preempt_disable();
foo();
preempt_enable();
</code></pre>
<p>Compiler can rearrange it as:</p>
<pre><code class="lang-C">preempt_disable();
preempt_enable();
foo();
</code></pre>
<p>In this case non-preemptible function <code>foo</code> can be preempted. As we put <code>barrier</code> macro in the <code>preempt_disable</code> and <code>preempt_enable</code> macros, it prevents the compiler from swapping <code>preempt_count_inc</code> with other statements. More about barriers you can read <a href="http://en.wikipedia.org/wiki/Memory_barrier" target="_blank">here</a> and <a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt" target="_blank">here</a>.</p>
<p>In the next step we can see following statement:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (WARN(!irqs_disabled(),
     <span class="hljs-string">&quot;Interrupts were enabled *very* early, fixing it\n&quot;</span>))
    local_irq_disable();
</code></pre>
<p>which check <a href="http://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29" target="_blank">IRQs</a> state, and disabling (with <code>cli</code> instruction for <code>x86_64</code>) if they are enabled.</p>
<p>That&apos;s all. Preemption is disabled and we can go ahead.</p>
<h2 id="initialization-of-the-integer-id-management">Initialization of the integer ID management</h2>
<p>In the next step we can see the call of the <code>idr_init_cache</code> function which defined in the <a href="https://github.com/torvalds/linux/blob/master/lib/idr.c" target="_blank">lib/idr.c</a>. The <code>idr</code> library is used in a various <a href="http://lxr.free-electrons.com/ident?i=idr_find" target="_blank">places</a> in the linux kernel to manage assigning integer <code>IDs</code> to objects and looking up objects by id.</p>
<p>Let&apos;s look on the implementation of the <code>idr_init_cache</code> function:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">idr_init_cache</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        idr_layer_cache = kmem_cache_create(<span class="hljs-string">&quot;idr_layer_cache&quot;</span>,
                                <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> idr_layer), <span class="hljs-number">0</span>, SLAB_PANIC, <span class="hljs-literal">NULL</span>);
}
</code></pre>
<p>Here we can see the call of the <code>kmem_cache_create</code>. We already called the <code>kmem_cache_init</code> in the <a href="https://github.com/torvalds/linux/blob/master/init/main.c#L485" target="_blank">init/main.c</a>. This function create generalized caches again using the <code>kmem_cache_alloc</code> (more about caches we will see in the <a href="http://0xax.gitbooks.io/linux-insides/content/mm/index.html" target="_blank">Linux kernel memory management</a> chapter). In our case, as we are using <code>kmem_cache_t</code> which will be used by the <a href="http://en.wikipedia.org/wiki/Slab_allocation" target="_blank">slab</a> allocator and <code>kmem_cache_create</code> creates it. As you can see we pass five parameters to the <code>kmem_cache_create</code>:</p>
<ul>
<li>name of the cache;</li>
<li>size of the object to store in cache;</li>
<li>offset of the first object in the page;</li>
<li>flags;</li>
<li>constructor for the objects.</li>
</ul>
<p>and it will create <code>kmem_cache</code> for the integer IDs. Integer <code>IDs</code> is commonly used pattern to map set of integer IDs to the set of pointers. We can see usage of the integer IDs in the <a href="http://en.wikipedia.org/wiki/I%C2%B2C" target="_blank">i2c</a> drivers subsystem. For example <a href="https://github.com/torvalds/linux/blob/master/drivers/i2c/i2c-core.c" target="_blank">drivers/i2c/i2c-core.c</a> which represents the core of the <code>i2c</code> subsystem defines <code>ID</code> for the <code>i2c</code> adapter with the <code>DEFINE_IDR</code> macro:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">DEFINE_IDR</span><span class="hljs-params">(i2c_adapter_idr)</span></span>;
</code></pre>
<p>and then uses it for the declaration of the <code>i2c</code> adapter:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __i2c_add_numbered_adapter(<span class="hljs-keyword">struct</span> i2c_adapter *adap)
{
  <span class="hljs-keyword">int</span>     id;
  ...
  ...
  ...
  id = idr_alloc(&amp;i2c_adapter_idr, adap, adap-&gt;nr, adap-&gt;nr + <span class="hljs-number">1</span>, GFP_KERNEL);
  ...
  ...
  ...
}
</code></pre>
<p>and <code>id2_adapter_idr</code> presents dynamically calculated bus number.</p>
<p>More about integer ID management you can read <a href="https://lwn.net/Articles/103209/" target="_blank">here</a>.</p>
<h2 id="rcu-initialization">RCU initialization</h2>
<p>The next step is <a href="http://en.wikipedia.org/wiki/Read-copy-update" target="_blank">RCU</a> initialization with the <code>rcu_init</code> function and it&apos;s implementation depends on two kernel configuration options:</p>
<ul>
<li><code>CONFIG_TINY_RCU</code></li>
<li><code>CONFIG_TREE_RCU</code></li>
</ul>
<p>In the first case <code>rcu_init</code> will be in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tiny.c" target="_blank">kernel/rcu/tiny.c</a> and in the second case it will be defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.c" target="_blank">kernel/rcu/tree.c</a>. We will see the implementation of the <code>tree rcu</code>, but first of all about the <code>RCU</code> in general.</p>
<p><code>RCU</code> or read-copy update is a scalable high-performance synchronization mechanism implemented in the Linux kernel. On the early stage the linux kernel provided support and environment for the concurrently running applications, but all execution was serialized in the kernel using a single global lock. In our days linux kernel has no single global lock, but provides different mechanisms including <a href="http://en.wikipedia.org/wiki/Concurrent_data_structure" target="_blank">lock-free data structures</a>, <a href="http://0xax.gitbooks.io/linux-insides/content/Concepts/per-cpu.html" target="_blank">percpu</a> data structures and other. One of these mechanisms is - the <code>read-copy update</code>. The <code>RCU</code> technique is designed for rarely-modified data structures. The idea of the <code>RCU</code> is simple. For example we have a rarely-modified data structure. If somebody wants to change this data structure, we make a copy of this data structure and make all changes in the copy. In the same time all other users of the data structure use old version of it. Next, we need to choose safe moment when original version of the data structure will have no users and update it with the modified copy.</p>
<p>Of course this description of the <code>RCU</code> is very simplified. To understand some details about <code>RCU</code>, first of all we need to learn some terminology. Data readers in the <code>RCU</code> executed in the <a href="http://en.wikipedia.org/wiki/Critical_section" target="_blank">critical section</a>. Every time when data reader get to the critical section, it calls the <code>rcu_read_lock</code>, and <code>rcu_read_unlock</code> on exit from the critical section. If the thread is not in the critical section, it will be in state which called - <code>quiescent state</code>. The moment when every thread is in the <code>quiescent state</code> called - <code>grace period</code>. If a thread wants to remove an element from the data structure, this occurs in two steps. First step is <code>removal</code> - atomically removes element from the data structure, but does not release the physical memory. After this thread-writer announces and waits until it is finished. From this moment, the removed element is available to the thread-readers. After the <code>grace period</code> finished, the second step of the element removal will be started, it just removes the element from the physical memory.</p>
<p>There a couple of implementations of the <code>RCU</code>. Old <code>RCU</code> called classic, the new implementation called <code>tree</code> RCU. As you may already understand, the <code>CONFIG_TREE_RCU</code> kernel configuration option enables tree <code>RCU</code>. Another is the <code>tiny</code> RCU which depends on <code>CONFIG_TINY_RCU</code> and <code>CONFIG_SMP=n</code>. We will see more details about the <code>RCU</code> in general in the separate chapter about synchronization primitives, but now let&apos;s look on the <code>rcu_init</code> implementation from the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.c" target="_blank">kernel/rcu/tree.c</a>:</p>
<pre><code class="lang-C"><span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">rcu_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
         <span class="hljs-keyword">int</span> cpu;

         rcu_bootup_announce();
         rcu_init_geometry();
         rcu_init_one(&amp;rcu_bh_state, &amp;rcu_bh_data);
         rcu_init_one(&amp;rcu_sched_state, &amp;rcu_sched_data);
         __rcu_init_preempt();
         open_softirq(RCU_SOFTIRQ, rcu_process_callbacks);

         <span class="hljs-comment">/*
          * We don&apos;t need protection against CPU-hotplug here because
          * this is called early in boot, before either interrupts
          * or the scheduler are operational.
          */</span>
         cpu_notifier(rcu_cpu_notify, <span class="hljs-number">0</span>);
         pm_notifier(rcu_pm_notify, <span class="hljs-number">0</span>);
         for_each_online_cpu(cpu)
                 rcu_cpu_notify(<span class="hljs-literal">NULL</span>, CPU_UP_PREPARE, (<span class="hljs-keyword">void</span> *)(<span class="hljs-keyword">long</span>)cpu);

         rcu_early_boot_tests();
}
</code></pre>
<p>In the beginning of the <code>rcu_init</code> function we define <code>cpu</code> variable and call <code>rcu_bootup_announce</code>. The <code>rcu_bootup_announce</code> function is pretty simple:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">rcu_bootup_announce</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        pr_info(<span class="hljs-string">&quot;Hierarchical RCU implementation.\n&quot;</span>);
        rcu_bootup_announce_oddness();
}
</code></pre>
<p>It just prints information about the <code>RCU</code> with the <code>pr_info</code> function and <code>rcu_bootup_announce_oddness</code> which uses <code>pr_info</code> too, for printing different information about the current <code>RCU</code> configuration which depends on different kernel configuration options like <code>CONFIG_RCU_TRACE</code>, <code>CONFIG_PROVE_RCU</code>, <code>CONFIG_RCU_FANOUT_EXACT</code>, etc. In the next step, we can see the call of the <code>rcu_init_geometry</code> function. This function is defined in the same source code file and computes the node tree geometry depends on the amount of CPUs. Actually <code>RCU</code> provides scalability with extremely low internal RCU lock contention. What if a data structure will be read from the different CPUs? <code>RCU</code> API provides the <code>rcu_state</code> structure which presents RCU global state including node hierarchy. Hierarchy is presented by the:</p>
<pre><code>struct rcu_node node[NUM_RCU_NODES];
</code></pre><p>array of structures. As we can read in the comment of above definition:</p>
<pre><code>The root (first level) of the hierarchy is in -&gt;node[0] (referenced by -&gt;level[0]), the second
level in -&gt;node[1] through -&gt;node[m] (-&gt;node[1] referenced by -&gt;level[1]), and the third level
in -&gt;node[m+1] and following (-&gt;node[m+1] referenced by -&gt;level[2]).  The number of levels is
determined by the number of CPUs and by CONFIG_RCU_FANOUT.

Small systems will have a &quot;hierarchy&quot; consisting of a single rcu_node.
</code></pre><p>The <code>rcu_node</code> structure is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.h" target="_blank">kernel/rcu/tree.h</a> and contains information about current grace period, is grace period completed or not, CPUs or groups that need to switch in order for current grace period to proceed, etc. Every <code>rcu_node</code> contains a lock for a couple of CPUs. These <code>rcu_node</code> structures are embedded into a linear array in the <code>rcu_state</code> structure and represented as a tree with the root as the first element and covers all CPUs. As you can see the number of the rcu nodes determined by the <code>NUM_RCU_NODES</code> which depends on number of available CPUs:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_RCU_NODES (RCU_SUM - NR_CPUS)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RCU_SUM (NUM_RCU_LVL_0 + NUM_RCU_LVL_1 + NUM_RCU_LVL_2 + NUM_RCU_LVL_3 + NUM_RCU_LVL_4)</span>
</code></pre>
<p>where levels values depend on the <code>CONFIG_RCU_FANOUT_LEAF</code> configuration option. For example for the simplest case, one <code>rcu_node</code> will cover two CPU on machine with the eight CPUs:</p>
<pre><code>+-----------------------------------------------------------------+
|  rcu_state                                                      |
|                 +----------------------+                        |
|                 |         root         |                        |
|                 |       rcu_node       |                        |
|                 +----------------------+                        |
|                    |                |                           |
|               +----v-----+       +--v-------+                   |
|               |          |       |          |                   |
|               | rcu_node |       | rcu_node |                   |
|               |          |       |          |                   |
|         +------------------+     +----------------+             |
|         |                  |        |             |             |
|         |                  |        |             |             |
|    +----v-----+    +-------v--+   +-v--------+  +-v--------+    |
|    |          |    |          |   |          |  |          |    |
|    | rcu_node |    | rcu_node |   | rcu_node |  | rcu_node |    |
|    |          |    |          |   |          |  |          |    |
|    +----------+    +----------+   +----------+  +----------+    |
|         |                 |             |               |       |
|         |                 |             |               |       |
|         |                 |             |               |       |
|         |                 |             |               |       |
+---------|-----------------|-------------|---------------|-------+
          |                 |             |               |
+---------v-----------------v-------------v---------------v--------+
|                 |                |               |               |
|     CPU1        |      CPU3      |      CPU5     |     CPU7      |
|                 |                |               |               |
|     CPU2        |      CPU4      |      CPU6     |     CPU8      |
|                 |                |               |               |
+------------------------------------------------------------------+
</code></pre><p>So, in the <code>rcu_init_geometry</code> function we just need to calculate the total number of <code>rcu_node</code> structures. We start to do it with the calculation of the <code>jiffies</code> till to the first and next <code>fqs</code> which is <code>force-quiescent-state</code> (read above about it):</p>
<pre><code class="lang-C">d = RCU_JIFFIES_TILL_FORCE_QS + nr_cpu_ids / RCU_JIFFIES_FQS_DIV;
<span class="hljs-keyword">if</span> (jiffies_till_first_fqs == ULONG_MAX)
        jiffies_till_first_fqs = d;
<span class="hljs-keyword">if</span> (jiffies_till_next_fqs == ULONG_MAX)
        jiffies_till_next_fqs = d;
</code></pre>
<p>where:</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RCU_JIFFIES_TILL_FORCE_QS (1 + (HZ &gt; 250) + (HZ &gt; 500))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RCU_JIFFIES_FQS_DIV     256</span>
</code></pre>
<p>As we calculated these <a href="http://en.wikipedia.org/wiki/Jiffy_%28time%29" target="_blank">jiffies</a>, we check that previous defined <code>jiffies_till_first_fqs</code> and <code>jiffies_till_next_fqs</code> variables are equal to the <a href="http://www.rowleydownload.co.uk/avr/documentation/index.htm?http://www.rowleydownload.co.uk/avr/documentation/ULONG_MAX.htm" target="_blank">ULONG_MAX</a> (their default values) and set they equal to the calculated value. As we did not touch these variables before, they are equal to the <code>ULONG_MAX</code>:</p>
<pre><code class="lang-C"><span class="hljs-keyword">static</span> ulong jiffies_till_first_fqs = ULONG_MAX;
<span class="hljs-keyword">static</span> ulong jiffies_till_next_fqs = ULONG_MAX;
</code></pre>
<p>In the next step of the <code>rcu_init_geometry</code>, we check that <code>rcu_fanout_leaf</code> didn&apos;t change (it has the same value as <code>CONFIG_RCU_FANOUT_LEAF</code> in compile-time) and equal to the value of the <code>CONFIG_RCU_FANOUT_LEAF</code> configuration option, we just return:</p>
<pre><code class="lang-C"><span class="hljs-keyword">if</span> (rcu_fanout_leaf == CONFIG_RCU_FANOUT_LEAF &amp;&amp;
    nr_cpu_ids == NR_CPUS)
    <span class="hljs-keyword">return</span>;
</code></pre>
<p>After this we need to compute the number of nodes that an <code>rcu_node</code> tree can handle with the given number of levels:</p>
<pre><code class="lang-C">rcu_capacity[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
rcu_capacity[<span class="hljs-number">1</span>] = rcu_fanout_leaf;
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt;= MAX_RCU_LVLS; i++)
    rcu_capacity[i] = rcu_capacity[i - <span class="hljs-number">1</span>] * CONFIG_RCU_FANOUT;
</code></pre>
<p>And in the last step we calculate the number of rcu_nodes at each level of the tree in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.c#L4094" target="_blank">loop</a>.</p>
<p>As we calculated geometry of the <code>rcu_node</code> tree, we need to go back to the <code>rcu_init</code> function and next step we need to initialize two <code>rcu_state</code> structures with the <code>rcu_init_one</code> function:</p>
<pre><code class="lang-C">rcu_init_one(&amp;rcu_bh_state, &amp;rcu_bh_data);
rcu_init_one(&amp;rcu_sched_state, &amp;rcu_sched_data);
</code></pre>
<p>The <code>rcu_init_one</code> function takes two arguments:</p>
<ul>
<li>Global <code>RCU</code> state;</li>
<li>Per-CPU data for <code>RCU</code>.</li>
</ul>
<p>Both variables defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.h" target="_blank">kernel/rcu/tree.h</a> with its <code>percpu</code> data:</p>
<pre><code>extern struct rcu_state rcu_bh_state;
DECLARE_PER_CPU(struct rcu_data, rcu_bh_data);
</code></pre><p>About this states you can read <a href="http://lwn.net/Articles/264090/" target="_blank">here</a>. As I wrote above we need to initialize <code>rcu_state</code> structures and <code>rcu_init_one</code> function will help us with it. After the <code>rcu_state</code> initialization, we can see the call of the <code>__rcu_init_preempt</code> which depends on the <code>CONFIG_PREEMPT_RCU</code> kernel configuration option. It does the same as previous functions - initialization of the <code>rcu_preempt_state</code> structure with the <code>rcu_init_one</code> function which has <code>rcu_state</code> type. After this, in the <code>rcu_init</code>, we can see the call of the:</p>
<pre><code class="lang-C">open_softirq(RCU_SOFTIRQ, rcu_process_callbacks);
</code></pre>
<p>function. This function registers a handler of the <code>pending interrupt</code>. Pending interrupt or <code>softirq</code> supposes that part of actions can be delayed for later execution when the system is less loaded. Pending interrupts is represented by the following structure:</p>
<pre><code class="lang-C"><span class="hljs-keyword">struct</span> softirq_action
{
        <span class="hljs-keyword">void</span>    (*action)(<span class="hljs-keyword">struct</span> softirq_action *);
};
</code></pre>
<p>which is defined in the <a href="https://github.com/torvalds/linux/blob/master/include/linux/interrupt.h" target="_blank">include/linux/interrupt.h</a> and contains only one field - handler of an interrupt. You can check about <code>softirqs</code> in the your system with the:</p>
<pre><code>$ cat /proc/softirqs
                    CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7
          HI:          2          0          0          1          0          2          0          0
       TIMER:     137779     108110     139573     107647     107408     114972      99653      98665
      NET_TX:       1127          0          4          0          1          1          0          0
      NET_RX:        334        221     132939       3076        451        361        292        303
       BLOCK:       5253       5596          8        779       2016      37442         28       2855
BLOCK_IOPOLL:          0          0          0          0          0          0          0          0
     TASKLET:         66          0       2916        113          0         24      26708          0
       SCHED:     102350      75950      91705      75356      75323      82627      69279      69914
     HRTIMER:        510        302        368        260        219        255        248        246
         RCU:      81290      68062      82979      69015      68390      69385      63304      63473
</code></pre><p>The <code>open_softirq</code> function takes two parameters:</p>
<ul>
<li>index of the interrupt;</li>
<li>interrupt handler.</li>
</ul>
<p>and adds interrupt handler to the array of the pending interrupts:</p>
<pre><code class="lang-C">void open_softirq(int nr, void (*action)(struct softirq_action *))
{
        softirq_vec[nr].action = action;
}
</code></pre>
<p>In our case the interrupt handler is - <code>rcu_process_callbacks</code> which is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/rcu/tree.c" target="_blank">kernel/rcu/tree.c</a> and does the <code>RCU</code> core processing for the current CPU. After we registered <code>softirq</code> interrupt for the <code>RCU</code>, we can see the following code:</p>
<pre><code class="lang-C">cpu_notifier(rcu_cpu_notify, <span class="hljs-number">0</span>);
pm_notifier(rcu_pm_notify, <span class="hljs-number">0</span>);
for_each_online_cpu(cpu)
    rcu_cpu_notify(<span class="hljs-literal">NULL</span>, CPU_UP_PREPARE, (<span class="hljs-keyword">void</span> *)(<span class="hljs-keyword">long</span>)cpu);
</code></pre>
<p>Here we can see registration of the <code>cpu</code> notifier which needs in systems which supports <a href="https://www.kernel.org/doc/Documentation/cpu-hotplug.txt" target="_blank">CPU hotplug</a> and we will not dive into details about this theme. The last function in the <code>rcu_init</code> is the <code>rcu_early_boot_tests</code>:</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rcu_early_boot_tests</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        pr_info(<span class="hljs-string">&quot;Running RCU self tests\n&quot;</span>);

        <span class="hljs-keyword">if</span> (rcu_self_test)
                 early_boot_test_call_rcu();
         <span class="hljs-keyword">if</span> (rcu_self_test_bh)
                 early_boot_test_call_rcu_bh();
         <span class="hljs-keyword">if</span> (rcu_self_test_sched)
                early_boot_test_call_rcu_sched();
}
</code></pre>
<p>which runs self tests for the <code>RCU</code>.</p>
<p>That&apos;s all. We saw initialization process of the <code>RCU</code> subsystem. As I wrote above, more about the <code>RCU</code> will be in the separate chapter about synchronization primitives.</p>
<h2 id="rest-of-the-initialization-process">Rest of the initialization process</h2>
<p>Ok, we already passed the main theme of this part which is <code>RCU</code> initialization, but it is not the end of the linux kernel initialization process. In the last paragraph of this theme we will see a couple of functions which work in the initialization time, but we will not dive into deep details around this function for different reasons. Some reasons not to dive into details are following:</p>
<ul>
<li>They are not very important for the generic kernel initialization process and depend on the different kernel configuration;</li>
<li>They have the character of debugging and not important for now;</li>
<li>We will see many of this stuff in the separate parts/chapters.</li>
</ul>
<p>After we initialized <code>RCU</code>, the next step which you can see in the <a href="https://github.com/torvalds/linux/blob/master/init/main.c" target="_blank">init/main.c</a> is the - <code>trace_init</code> function. As you can understand from its name, this function initialize <a href="http://en.wikipedia.org/wiki/Tracing_%28software%29" target="_blank">tracing</a> subsystem. You can read more about linux kernel trace system - <a href="http://elinux.org/Kernel_Trace_Systems" target="_blank">here</a>.</p>
<p>After the <code>trace_init</code>, we can see the call of the <code>radix_tree_init</code>. If you are familiar with the different data structures, you can understand from the name of this function that it initializes kernel implementation of the <a href="http://en.wikipedia.org/wiki/Radix_tree" target="_blank">Radix tree</a>. This function is defined in the <a href="https://github.com/torvalds/linux/blob/master/lib/radix-tree.c" target="_blank">lib/radix-tree.c</a> and you can read more about it in the part about <a href="https://0xax.gitbooks.io/linux-insides/content/DataStructures/radix-tree.html" target="_blank">Radix tree</a>.</p>
<p>In the next step we can see the functions which are related to the <code>interrupts handling</code> subsystem, they are:</p>
<ul>
<li><code>early_irq_init</code></li>
<li><code>init_IRQ</code></li>
<li><code>softirq_init</code></li>
</ul>
<p>We will see explanation about this functions and their implementation in the special part about interrupts and exceptions handling. After this many different functions (like <code>init_timers</code>, <code>hrtimers_init</code>, <code>time_init</code>, etc.) which are related to different timing and timers stuff. We will see more about these function in the chapter about timers.</p>
<p>The next couple of functions are related with the <a href="https://perf.wiki.kernel.org/index.php/Main_Page" target="_blank">perf</a> events - <code>perf_event-init</code> (there will be separate chapter about perf), initialization of the <code>profiling</code> with the <code>profile_init</code>. After this we enable <code>irq</code> with the call of the:</p>
<pre><code class="lang-C">local_irq_enable();
</code></pre>
<p>which expands to the <code>sti</code> instruction and making post initialization of the <a href="http://en.wikipedia.org/wiki/Slab_allocation" target="_blank">SLAB</a> with the call of the <code>kmem_cache_init_late</code> function (As I wrote above we will know about the <code>SLAB</code> in the <a href="http://0xax.gitbooks.io/linux-insides/content/mm/index.html" target="_blank">Linux memory management</a> chapter).</p>
<p>After the post initialization of the <code>SLAB</code>, next point is initialization of the console with the <code>console_init</code> function from the <a href="https://github.com/torvalds/linux/blob/master/drivers/tty/tty_io.c" target="_blank">drivers/tty/tty_io.c</a>.</p>
<p>After the console initialization, we can see the <code>lockdep_info</code> function which prints information about the <a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt" target="_blank">Lock dependency validator</a>. After this, we can see the initialization of the dynamic allocation of the <code>debug objects</code> with the <code>debug_objects_mem_init</code>, kernel memory leak <a href="https://www.kernel.org/doc/Documentation/kmemleak.txt" target="_blank">detector</a> initialization with the <code>kmemleak_init</code>, <code>percpu</code> pageset setup with the <code>setup_per_cpu_pageset</code>, setup of the <a href="http://en.wikipedia.org/wiki/Non-uniform_memory_access" target="_blank">NUMA</a> policy with the <code>numa_policy_init</code>, setting time for the scheduler with the <code>sched_clock_init</code>, <code>pidmap</code> initialization with the call of the <code>pidmap_init</code> function for the initial <code>PID</code> namespace, cache creation with the <code>anon_vma_init</code> for the private virtual memory areas and early initialization of the <a href="http://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface" target="_blank">ACPI</a> with the <code>acpi_early_init</code>.</p>
<p>This is the end of the ninth part of the <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/index.html" target="_blank">linux kernel initialization process</a> and here we saw initialization of the <a href="http://en.wikipedia.org/wiki/Read-copy-update" target="_blank">RCU</a>. In the last paragraph of this part (<code>Rest of the initialization process</code>) we will go through many functions but did not dive into details about their implementations. Do not worry if you do not know anything about these stuff or you know and do not understand anything about this. As I already wrote many times, we will see details of implementations in other parts or other chapters.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It is the end of the ninth part about the linux kernel <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/index.html" target="_blank">initialization process</a>. In this part, we looked on the initialization process of the <code>RCU</code> subsystem. In the next part we will continue to dive into linux kernel initialization process and I hope that we will finish with the <code>start_kernel</code> function and will go to the <code>rest_init</code> function from the same <a href="https://github.com/torvalds/linux/blob/master/init/main.c" target="_blank">init/main.c</a> source code file and will see the start of the first process.</p>
<p>If you have any questions or suggestions write me a comment or ping me at <a href="https://twitter.com/0xAX" target="_blank">twitter</a>.</p>
<p><strong>Please note that English is not my first language, And I am really sorry for any inconvenience. If you find any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides" target="_blank">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Concurrent_data_structure" target="_blank">lock-free data structures</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/kmemleak.txt" target="_blank">kmemleak</a></li>
<li><a href="http://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface" target="_blank">ACPI</a></li>
<li><a href="http://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29" target="_blank">IRQs</a></li>
<li><a href="http://en.wikipedia.org/wiki/Read-copy-update" target="_blank">RCU</a></li>
<li><a href="https://github.com/torvalds/linux/tree/master/Documentation/RCU" target="_blank">RCU documentation</a></li>
<li><a href="https://lwn.net/Articles/103209/" target="_blank">integer ID management</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt" target="_blank">Documentation/memory-barriers.txt</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt" target="_blank">Runtime locking correctness validator</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/Concepts/per-cpu.html" target="_blank">Per-CPU variables</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/mm/index.html" target="_blank">Linux kernel memory management</a></li>
<li><a href="http://en.wikipedia.org/wiki/Slab_allocation" target="_blank">slab</a></li>
<li><a href="http://en.wikipedia.org/wiki/I%C2%B2C" target="_blank">i2c</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-8.html" target="_blank">Previous part</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="linux-initialization-8.html" class="navigation navigation-prev " aria-label="Previous page: Scheduler initialization">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="linux-initialization-10.html" class="navigation navigation-next " aria-label="Next page: End of initialization">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"RCU initialization","level":"1.3.9","depth":2,"next":{"title":"End of initialization","level":"1.3.10","depth":2,"path":"Initialization/linux-initialization-10.md","ref":"Initialization/linux-initialization-10.md","articles":[]},"previous":{"title":"Scheduler initialization","level":"1.3.8","depth":2,"path":"Initialization/linux-initialization-8.md","ref":"Initialization/linux-initialization-8.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Initialization/linux-initialization-9.md","mtime":"2019-03-28T07:54:50.396Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-28T07:57:01.662Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

